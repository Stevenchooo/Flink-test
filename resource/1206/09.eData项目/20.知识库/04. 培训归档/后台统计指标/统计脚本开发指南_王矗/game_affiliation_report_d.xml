<reportSuite>
    <reports>
        <report tableName = "t_game_affiliation_d" keyFields = "projectid,relchannel,affiliatechannelid,partnerid,chargechannelid,currency,activityid,dtime" 
                period = "daily" timeFormat = "yyyyMMdd" timeField = "dtime">
            <fieldDefinition>
                <field name="projectid" regular="[0-9a-zA-Z./-]*"/>
                <field name="relchannel" regular="[0-9a-zA-Z./-]*"/>
                <field name="affiliatechannelid" regular="[0-9a-zA-Z./-]*"/>
                <field name="partnerid" regular="[0-9a-zA-Z./-]*"/>
                <field name="chargechannelid" regular="[0-9a-zA-Z./-]*"/>
                <field name="activityid" regular="[0-9a-zA-Z./-]*"/>
                <field name="dtime" regular="[0-9a-zA-Z./-]*"/>
            </fieldDefinition>
            <materialViewers>
                <materialViewer tableName = "game.T_MID_JOIN_VIPSTATUS"  clear="false" partition="date">
                    <hql>
                        <![CDATA[
                      SELECT userid, projectid, timestamp,chargetype,chargeresult,relchannel,fee,dtime,unsubchannelid,unsubtype,activityid,protectendtime,promotioncpid,productid,affiliatechannelid,subscribetime,chargechannelid,currency,dtime date
                      from
                      (
                          SELECT userid, projectid, timestamp,chargetype,chargeresult,relchannel,fee,dtime,unsubchannelid,unsubtype,activityid,protectendtime,promotioncpid,productid,affiliatechannelid,subscribetime,chargechannelid,currency
                          from
                          (
                              SELECT t2.userid, t2.projectid,t1.dtime, t2.timestamp,t2.chargetype,t2.chargeresult,t2.fee,t2.relchannel,t2.unsubchannelid,t2.unsubtype,t2.activityid,t2.protectendtime,t2.promotioncpid,t2.productid,t2.affiliatechannelid,t2.subscribetime,t2.chargechannelid,t2.currency,
                                  row_number() OVER (partition by t2.userid,t2.projectid,t1.dtime ORDER BY timestamp DESC,chargetype DESC) AS rank
                              from
                              (
                                  select  from_unixtime(unix_timestamp(dtime,'yyyy-MM-dd'),'yyyyMMdd') dtime
                                  from    game.t_bdi_rundate
                                  where   from_unixtime(unix_timestamp(dtime,'yyyy-MM-dd'),'yyyyMMdd') > '{STARTTIME}' 
                                  AND     from_unixtime(unix_timestamp(dtime,'yyyy-MM-dd'),'yyyyMMdd') < '{ENDTIME}' 
                              ) t1,
                              (
                                  SELECT original_msisdn userid, date dtime, oaoperatorid projectid,timestamp,chargetype,chargeresult,fee,unsubchannelid,unsubtype,activityid,
                                         if(vipsubchannelid is null, 'none', if(substr(vipsubchannelid, 0, 1) = 'l', substr(vipsubchannelid, 4), if(accesschannel = 214, concat_ws('%',CONV( accesschannel,10,10),vipsubchannelid), vipsubchannelid))) relchannel,protectendtime,promotioncpid,
                                         productid,if(affiliatechannelid = '' or affiliatechannelid is null,'none',affiliatechannelid) affiliatechannelid,subscribetime,nvl(chargechannelid, 'none') chargechannelid, nvl(currencyname, 'none') currency 
                                  FROM game.t_cdr_order  
                                  where date > '{STARTTIME}' and date < '{ENDTIME}' and (producttype = 0 or producttype = 1 or producttype is null) and (chargetype = 3 or (chargetype in(2,4) and chargeresult=0)) and activityid is not null
                                  union all
                                  SELECT userid, dtime,projectid, timestamp,chargetype,chargeresult,fee,unsubchannelid,unsubtype,activityid,relchannel,protectendtime,promotioncpid,productid,if(affiliatechannelid = '' or affiliatechannelid is null,'none',affiliatechannelid) affiliatechannelid,subscribetime,nvl(chargechannelid, 'none') chargechannelid,nvl(currency, 'none') currency
                                  from game.T_MID_JOIN_VIPSTATUS where  dtime >= '{STARTTIME}' and activityid is not null
                              ) t2
                              where t2.dtime <= t1.dtime
                          ) t
                        where  rank = 1 
                        ) t                      
                        ]]>
                    </hql>
                </materialViewer>
                <materialViewer tableName = "game.T_MID_JOIN_SUBQUERY"  clear="true" >
                    <hql>
                    <![CDATA[
                    select projectid,userid,productid,relchannel,affiliatechannelid,activityid,t2.dtime dtime,timestamp,promotioncpid,chargechannelid,currency
                      from (select t0.projectid,
                                   t0.userid,
                                   t0.productid,
                                   t0.relchannel,
                                   t0.affiliatechannelid,
                                   t1.activityid,
                                   t0.dtime dtime,
                                   t0.timestamp,
                                   t0.promotioncpid,
                                   t0.chargechannelid,
                                   t0.currency
                              from game.T_MID_JOIN_VIPSTATUS t0, game.T_BFM_ACTIVITY t1
                             where from_unixtime(unix_timestamp(substr(t0.timestamp,1,10),'yyyy-MM-dd'),'yyyyMMdd') = t0.dtime
                               and chargetype =2 and chargeresult = 0 and t1.activityid is not null
                               and t0.projectid = t1.projectid and t0.activityid = t1.activityid) tt,
                           (select from_unixtime(unix_timestamp(dtime, 'yyyy-MM-dd'), 'yyyyMMdd') dtime
                              from game.T_BDI_RUNDATE
                             where from_unixtime(unix_timestamp(dtime, 'yyyy-MM-dd'), 'yyyyMMdd') > '{STARTTIME}'
                               and from_unixtime(unix_timestamp(dtime, 'yyyy-MM-dd'), 'yyyyMMdd') < '{ENDTIME}') t2
                    where tt.dtime = from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime, 'yyyyMMdd'),'yyyy-MM-dd'),6),'yyyy-MM-dd'), 'yyyyMMdd')
                        ]]>
                    </hql>
                </materialViewer>
                <materialViewer tableName = "game.T_MID_JOIN_SUBQUERYTWO"  clear="true" >
                    <hql>
                        <![CDATA[
                        select t1.projectid projectid,t1.userid userid,t1.relchannel relchannel,t1.affiliatechannelid,t1.activityid activityid,
                               t1.dtime dtime,t1.promotioncpid promotioncpid, t1.chargechannelid chargechannelid, t1.currency currency
                          from game.T_MID_JOIN_SUBQUERY t1,
                               (select t0.projectid,
                                       t0.userid,
                                       t0.productid,
                                       t0.relchannel,
                                       t0.affiliatechannelid,
                                       t1.activityid,
                                       t0.dtime,
                                       t0.promotioncpid,
                                       t0.chargechannelid,
                                       t0.currency
                                  from game.T_MID_JOIN_VIPSTATUS t0 ,game.T_BFM_ACTIVITY t1
                                 where t0.dtime  > '{STARTTIME}' and t0.dtime < '{ENDTIME}'
                                   and ((t0.chargetype = 2 and t0.chargeresult = 0 and t0.fee = 0)
                                    or (t0.chargetype = 3 and t0.chargeresult <> 0 and t0.fee > 0)
                                    or (t0.chargetype in (2,3) and t0.chargeresult = 0 and t0.fee > 0))
                                   and t1.activityid is not null
                                   and t0.projectid = t1.projectid and t0.activityid = t1.activityid) t2
                        where t1.userid = t2.userid
                          and t1.productid = t2.productid
                          and t1.relchannel = t2.relchannel
                          and t1.affiliatechannelid = t2.affiliatechannelid
                          and t1.activityid = t2.activityid
                          and t1.dtime = t2.dtime
                          and t1.projectid = t2.projectid
                          and t1.chargechannelid = t2.chargechannelid
                          and t1.currency = t2.currency
                        ]]>
                    </hql>
                </materialViewer>
                 <materialViewer tableName = "game.T_MID_BROWSER"  clear="true" >
                    <hql>
                    <![CDATA[
                        select projectid,relchannel,affiliatechannelid,partnerid,activityid,dtime,count(msisdn) numacqrate_numerator, count(1) numacqrate_denominator, 0 tpaysuccess
                          from (select t1.projectid,
                                       case
                                         when t1.channelid is null then 'none'
                                         when trim(t1.channelid) = '' then 'none'
                                         when substr(t1.channelid,4) is null then 'none'
                                         else substr(t1.channelid,4) 
                                       end relchannel,
                                       nvl(t1.subchannelid, 'none') affiliatechannelid,
                                       nvl(t2.promotioncpid, 'none') partnerid,
                                       nvl(t2.activityid, 'none') activityid,
                                       from_unixtime(unix_timestamp(substr(t1.browsedate, 0, 10), 'yyyy-MM-dd'), 'yyyyMMdd') dtime,
                                       t1.msisdn
                                  from game.t_cdr_browser t1
                                  left outer join game.t_bfm_activity t2
                                    on t1.projectid = t2.projectid
                                   and t1.activityid = t2.activityid
                                 where t1.linktype in (1, 4)
                                   and t1.date > '{STARTTIME}'
                                   and t1.date < '{ENDTIME}'
                                   and t1.id in ({PROJECTIDS})
                                   and t2.activityid is not null) t
                           group by projectid,relchannel,affiliatechannelid,partnerid,activityid,dtime
                           union all
                    select projectid,relchannel,affiliatechannelid,partnerid,activityid,dtime,0 numacqrate_numerator,0 numacqrate_denominator,count(distinct(t.original_msisdn)) tpaysuccess
                      from (select t1.oaoperatorid projectid,
                                   from_unixtime(unix_timestamp(substr(t1.timestamp, 0, 10), 'yyyy-MM-dd'), 'yyyyMMdd') dtime,
                                   if(substr(t1.vipsubchannelid, 0, 1) = 'l', substr(t1.vipsubchannelid, 4), if(t1.vipsubchannelid is null, 'none', if(t1.accesschannel = 214, concat_ws('%', CONV(t1.accesschannel,10,10),t1.vipsubchannelid), t1.vipsubchannelid))) relchannel,
                                   nvl(t1.affiliatechannelid, 'none') affiliatechannelid,
                                   nvl(t1.promotioncpid, 'none') partnerid,
                                   nvl(t2.activityid, 'none') activityid,
                                   t1.original_msisdn
                              from game.t_cdr_order t1
                              left outer join game.t_bfm_activity t2
                                on t1.oaoperatorid = t2.projectid
                               and t1.activityid = t2.activityid
                             where t1.chargeresult = 0
                               and t1.chargetype = 2
                               and t2.activityid is not null
                               and t1.date > '{STARTTIME}'
                               and t1.date < '{ENDTIME}'
                               and t1.id in ({PROJECTIDS})) t
                     group by projectid,relchannel,affiliatechannelid,partnerid,activityid,dtime
                        ]]>
                    </hql>
                </materialViewer>
            </materialViewers>
            <dimensions>
                <dimension id = "step1" >
                    <reportIndex>
                        game.affiliation.tnewuserunsubusercnt_actunsubnumofnewsubmem_cusunsubnumofnewsubmem.d,<!--新订购会员退订数,新订购会员主动退订数,新订购会员客服退订数-->  
                        game.affiliation.tunsubscribevips_tuserunsubusercnt_cusunsubnumofnotnewsubmem.d,<!--非新增会员退订数,非新增会员主动退订数,非新增会员客服代退订数 -->  
                        game.affiliation.tnewvips.d,<!--新增会员数-->
                        game.affiliation.sevendaysrematevips.d,<!--7日留存会员数-->
                        game.affiliation.grantcollectvips.d,<!--应收租会员数-->
                        game.affiliation.treceivablevips.d,<!--成功收租会员数-->
                        game.affiliation.tpartnerchannelrevenue_localtpartnerchannelrevenue_tviprevenue_localtviprevenue.d,<!--货币单位,合作渠道流水,会员总流水-->
                        game.affiliation.tprotectvips.d,<!--合作渠道会员数-->
                        game.affiliation.tfreevips_tgracevips_tnormalvips.d<!--免费期会员数,宽限期会员数,正式期会员数-->
                    </reportIndex>
                </dimension>                
                <dimension id = "step2" >
                    <reportIndex>
                        game.affiliation.sevendayordervips.d<!--7日前订购会员总数-->
                    </reportIndex>
                </dimension>
                <dimension id = "step3" >
                    <reportIndex>
                        game.affiliation.sevenrenratedenominator_sevenrenratenumerator.d<!--7日留存率均值分母,7日留存率均值分子-->
                    </reportIndex>
                </dimension>
                <dimension id = "step5">
                    <reportIndex>
                        game.affiliation.chargechannelname.d,<!--支付渠道名称-->
                        game.affiliation.channelname.d,<!--推广渠道名称-->
                        game.affiliation.activityname.d,<!--营销活动名称-->
                        game.affiliation.partnername.d <!--合作伙伴名称-->
                    </reportIndex>
                </dimension> 
                <dimension id = "step6">
                    <reportIndex>
                        game.affiliation.groupby_project_dtime.d,<!--按项目,时间分组求和-->
                        game.affiliation.groupby_project_channel_dtime.d,<!--按项目,渠道,时间分组求和-->
                        game.affiliation.groupby_project_partner_dtime.d,<!--按项目,合作伙伴,时间分组求和-->
                        game.affiliation.groupby_project_channel_partner_dtime.d,<!--按项目,渠道,合作伙伴,时间分组求和-->
                        game.affiliation.groupby_promotionchannel.d,<!--按推广渠道-->
                        game.affiliation.groupby_promotionactivity.d,<!--按营销活动-->
                        game.affiliation.groupby_chargechannle.d<!--按支付渠道-->
                    </reportIndex>
                </dimension>
                <dimension id = "step7">
                    <reportIndex>
                        game.affiliation.groupby_project_dtime_more.d,<!--按项目,时间分组求和追加号码获取率，订购成功率信息-->
                        game.affiliation.groupby_project_channel_dtime_more.d,<!--按项目,渠道,时间分组求和追加号码获取率，订购成功率信息-->
                        game.affiliation.groupby_project_partner_dtime_more.d,<!--按项目,合作伙伴,时间分组求和追加号码获取率，订购成功率信息-->
                        game.affiliation.groupby_project_channel_partner_dtime_more.d,<!--按项目,渠道,合作伙伴,时间分组求和追加号码获取率，订购成功率信息-->
                        game.affiliation.groupby_promotionchannel_more.d,<!--按推广渠道追加号码获取率，订购成功率信息-->
                        game.affiliation.groupby_promotionactivity_more.d,<!--按营销活动追加号码获取率，订购成功率信息-->
                    </reportIndex>
                </dimension>
            </dimensions> 
        </report>
    </reports>
</reportSuite>
