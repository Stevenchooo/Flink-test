<reportIndexGroup>
<!--
[201705][SDK、JSSDK]
本报文结算结果为
projectid@110#activitychannelid@119#activityid@120#platformid@1#dtime@20170510#
projectid@110#activitychannelid@119#activityid@120#dtime@20170510#
projectid@110#activitychannelid@119#dtime@20170510#
projectid@110#activityid@120#dtime@20170510#
projectid@110#dtime@20170510#

目前使用的SDK话单相关字段
当期 新增游客数 newvisitor
当周 新增游客数 newvisitor_dw
周月 新增游客数 newvisitor_dm

当期  订购用户数 neworderuser
当周  订购用户数 neworderuser_dw
当月  订购用户数 neworderuser_dm
-->
    <multiHqlReportIndexs>
	<!--
	*********************************************************************************************
	//SDK、JSSDK事件话单结算
	//近日指标
	*********************************************************************************************
	-->
		<!--当期 新增游客数(newvisitor)-->
        <multiHqlReportIndex>
            <indexKey>video.sdk.current.newvisitor.d</indexKey>
            <fieldName>newvisitor</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(userid)) newvisitor
				  from (select projectid,
							   'none' activitychannelid,
							   'ALL' activityid,
							   platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITORS t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITORS t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'none' activitychannelid,
							   'none' activityid,
							   platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITORS t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'none' activityid,
							   platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITORS t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						   
						union all
						   select projectid,
							   'none' activitychannelid,
							   'ALL' activityid,
							   'ALL' platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITORS t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   'ALL' platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITORS t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'none' activitychannelid,
							   'none' activityid,
							   'ALL' platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITORS t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'none' activityid,
							   'ALL' platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITORS t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
					) tt
				 group by projectid,activitychannelid,activityid,platformid,dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--
		//当期 活跃的的用户数量 activeusers [游客和注册用户数]
		//注意更新：全部取客户端上报的事件（组合表不再使用）
		-->
		<multiHqlReportIndex>
			<indexKey>video.sdk.current.activeusers.d</indexKey>
			<fieldName>activeusers</fieldName>
			<hql>
				<![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(userid)) activeusers
				  from (select t.c1 projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   userid
						  from video.t_cdr_sdk_event_join_video_user t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select t.c1 projectid,
							   if(t.activitychannelid is null, 'none', t.activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   userid
						  from video.t_cdr_sdk_event_join_video_user t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select t.c1 projectid,
							   'ALL' activitychannelid,
							   if(t.activityid is null, 'none', t.activityid) activityid,
							   t.date dtime,
							   userid
						  from video.t_cdr_sdk_event_join_video_user t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select t.c1 projectid,
							   if(t.activitychannelid is null, 'none', t.activitychannelid) activitychannelid,
							   if(t.activityid is null, 'none', t.activityid) activityid,
							   t.date dtime,
							   userid
						  from video.t_cdr_sdk_event_join_video_user t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}') tt
				 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>
		
		<!--
		//当期 注册用户活跃数 registeruseractive: 注册用户中有登陆、浏览、播放行为的数量 
		//当前已注册用户 和 当前客户端上报的事件关联处理获取
		//
		//[20170306@SE]
		//注册用户活跃数根据[SDK话单中的 用户类型（guest、subscriber、vip）]c2 <> guest 为注册用户数
		-->
		<multiHqlReportIndex>
			<indexKey>video.sdk.current.registeruseractive.d</indexKey>
			<fieldName>registeruseractive</fieldName>
			<hql>
				<![CDATA[
					select projectid,activitychannelid,activityid,dtime,
						   count(distinct(userid)) activeusers
					  from (select projectid,
								   'ALL' activitychannelid,
								   'ALL' activityid,
								   t.date dtime,
								   userid
							  from video.t_cdr_sdk_event_join_video_user t
							 where t.date > '{STARTTIME}'
							   and t.date < '{ENDTIME}'
							   and t.usertype <> 'guest'
							   and t.projectid is not null
							union all
							select projectid,
								   if(t.activitychannelid is null, 'none', t.activitychannelid) activitychannelid,
								   'ALL' activityid,
								   t.date dtime,
								   userid
							  from video.t_cdr_sdk_event_join_video_user t
							 where t.date > '{STARTTIME}'
							   and t.date < '{ENDTIME}'
							   and t.usertype <> 'guest'
							   and t.projectid is not null
							union all
							select projectid,
								   'ALL' activitychannelid,
								   if(t.activityid is null, 'none', t.activityid) activityid,
								   t.date dtime,
								   userid
							  from video.t_cdr_sdk_event_join_video_user t
							 where t.date > '{STARTTIME}'
							   and t.date < '{ENDTIME}'
							   and t.usertype <> 'guest'
							   and t.projectid is not null
							union all
							select projectid,
								   if(t.activitychannelid is null, 'none', t.activitychannelid) activitychannelid,
								   if(t.activityid is null, 'none', t.activityid) activityid,
								   t.date dtime,
								   userid
							  from video.t_cdr_sdk_event_join_video_user t
							 where t.date > '{STARTTIME}'
							   and t.date < '{ENDTIME}'
							   and t.usertype <> 'guest'
							   and t.projectid is not null) tt
					 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>
		
		<!-- 
		//[201703新增指标@EDP@zwx386873]
		//游客用户总数(totalvisitor) 截止当日的累计的游客总数，根据设备ID去重；同一个用户更换设备，按照新的游客用户统计。
		-->
		<multiHqlReportIndex>
			<indexKey>video.sdk.current.totalvisitor.d</indexKey>
			<fieldName>totalvisitor</fieldName>
			<hql>
				<![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(userid)) totalvisitor
				  from (select t1.c1 projectid, 'ALL' activitychannelid, 'ALL' activityid, t2.dtime, t1.userid
						  from (select *
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.eventname = 'login'
								   and t.eventlabel = 'guest') t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.date <= t2.dtime
						union all
						select t1.c1 projectid, 'ALL' activitychannelid, 'ALL' activityid, t2.dtime, t1.userid
						  from (select *
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.eventname = 'login'
								   and t.eventlabel = 'guest') t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.date <= t2.dtime
						 union all
						 select t1.c1 projectid, 'none' activitychannelid, 'ALL' activityid, t2.dtime, t1.userid
						  from (select *
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.eventname = 'login'
								   and t.eventlabel = 'guest') t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.date <= t2.dtime
						union all
						select t1.c1 projectid, 'none' activitychannelid, 'none' activityid, t2.dtime, t1.userid
						  from (select *
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.eventname = 'login'
								   and t.eventlabel = 'guest') t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.date <= t2.dtime
						) tt
				 group by projectid,activitychannelid,activityid,dtime
				]]>
			</hql>
		</multiHqlReportIndex>

	<!--
	*********************************************************************************************
	//SDK、JSSDK事件话单结算
	//当周指标
	*********************************************************************************************
	-->
		<!--当期 新增游客数(newvisitor)-->
        <multiHqlReportIndex>
            <indexKey>video.sdk.current.newvisitor.dw</indexKey>
            <fieldName>wnewvisitor</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   sum(wnewvisitor) wnewvisitor
				  from (select t1.projectid,
							   if(t1.activitychannelid is null,'ALL',t1.activitychannelid) activitychannelid,
							   if(t1.activityid is null,'ALL',t1.activityid) activityid,
							   t2.dtime,
							   t1.wnewvisitor
						  from (select projectid,activitychannelid,activityid,dtime,
									   if(t.newvisitor is null, 0, t.newvisitor) wnewvisitor
								  from video.t_video_sdk_current_d_hbase t
								 where t.date >= from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}') t1,
							   (select t.dtime, t.weekdays,from_unixtime(unix_timestamp(t.dtime, 'yyyyMMdd'),'yyyy-MM-dd') formaltime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.dtime > from_unixtime(unix_timestamp(date_sub(t2.formaltime,t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.dtime <= t2.dtime
					) tt
				 group by projectid, activitychannelid, activityid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--当期 活跃的的用户数量 activeusers [游客和注册用户数]-->
		<multiHqlReportIndex>
			<indexKey>video.sdk.current.activeusers.dw</indexKey>
			<macroList>
				<macro>
					<name>ACTIVEUSERS_WEEK</name>
					<value>
					<![CDATA[
					select t1.projectid,t1.activitychannelid,t1.activityid,t2.dtime,t1.userid
						  from (select projectid,activitychannelid,activityid,t.date datatime,userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}') t1,
							   (select t.dtime, t.weekdays,from_unixtime(unix_timestamp(t.dtime, 'yyyyMMdd'),'yyyy-MM-dd') formaltime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.datatime > from_unixtime(unix_timestamp(date_sub(t2.formaltime,t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.datatime <=t2.dtime
					]]>
					</value>
				</macro>
			</macroList>
			<fieldName>wactiveusers</fieldName>
			<hql>
				<![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(userid)) wactiveusers
				  from (select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   userid
						  from ({ACTIVEUSERS_WEEK}) t
						union all
						select projectid,
							   if(t.activitychannelid is null,'none',t.activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   userid
						  from ({ACTIVEUSERS_WEEK}) t
						union all
						select projectid,
							   'ALL' activitychannelid,
							   if(t.activityid is null, 'none', t.activityid) activityid,
							   t.date dtime,
							   userid
						  from ({ACTIVEUSERS_WEEK}) t
						union all
						select projectid,
							   if(t.activitychannelid is null,'none',t.activitychannelid) activitychannelid,
							   if(t.activityid is null, 'none', t.activityid) activityid,
							   t.date dtime,
							   userid
						  from ({ACTIVEUSERS_WEEK}) t) tt
				 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>
		
		<!--当期 注册用户活跃数 registeruseractive: 注册用户中有登陆、浏览、播放行为的数量-->
		<multiHqlReportIndex>
			<indexKey>video.sdk.current.registeruseractive.dw</indexKey>
			<macroList>
				<macro>
					<name>ACTIVEUSERS_WEEK</name>
					<value>
					<![CDATA[
					select t1.projectid,t1.activitychannelid,t1.activityid,t2.dtime,t1.userid
						  from (select projectid,activitychannelid,activityid,t.date datatime,userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}') t1,
							   (select t.dtime, t.weekdays,from_unixtime(unix_timestamp(t.dtime, 'yyyyMMdd'),'yyyy-MM-dd') formaltime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.datatime > from_unixtime(unix_timestamp(date_sub(t2.formaltime,t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.datatime <=t2.dtime
					]]>
					</value>
				</macro>
			</macroList>
			<fieldName>wregisteruseractive</fieldName>
			<hql>
				<![CDATA[
					select projectid,activitychannelid,activityid,dtime,
						   count(distinct(userid)) activeusers
				  from (select t1.projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t2.dtime,
							   t1.userid
						  from (select projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}'
								   and t.utcdate =(hour(from_unixtime(unix_timestamp(), 'yyyy-MM-dd HH:mm:ss')) - 2)
								   and t.usertype <> 'guest'
								   and t.projectid is not null) t1,
							   (select t.dtime, t.weekdays
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')
						union all
						select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t2.dtime,
							   t1.userid
						  from (select projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}'
								   and t.utcdate =(hour(from_unixtime(unix_timestamp(), 'yyyy-MM-dd HH:mm:ss')) - 2)
								   and t.usertype <> 'guest'
								   and t.projectid is not null) t1,
							   (select t.dtime, t.weekdays
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')
						union all
						select t1.projectid,
							   'ALL' activitychannelid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activityid,
							   t2.dtime,
							   t1.userid
						  from (select projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}'
								   and t.utcdate =(hour(from_unixtime(unix_timestamp(), 'yyyy-MM-dd HH:mm:ss')) - 2)
								   and t.usertype <> 'guest'
								   and t.projectid is not null) t1,
							   (select t.dtime, t.weekdays
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')
						union all
						select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   if(t1.activityid is null, 'none', t1.activityid) activityid,
							   t2.dtime,
							   t1.userid
						  from (select projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}'
								   and t.utcdate =(hour(from_unixtime(unix_timestamp(), 'yyyy-MM-dd HH:mm:ss')) - 2)
								   and t.usertype <> 'guest'
								   and t.projectid is not null) t1,
							   (select t.dtime, t.weekdays
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')
					) tt
					 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>
		
		
		<!--
		//截止当日的累计的游客总数，根据设备ID去重；同一个用户更换设备，按照新的游客用户统计。
		//
		//取当天累计游客总数
		-->

	<!--
	//当月指标
	-->
		<!--当期 新增游客数(newvisitor)-->
        <multiHqlReportIndex>
            <indexKey>video.sdk.current.newvisitor.dm</indexKey>
            <fieldName>mnewvisitor</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   sum(mnewvisitor) mnewvisitor
				  from (select t1.projectid,
							   if(t1.activitychannelid is null,'ALL',t1.activitychannelid) activitychannelid,
							   if(t1.activityid is null,'ALL',t1.activityid) activityid,
							   t2.dtime,
							   t1.mnewvisitor
						  from (select projectid,activitychannelid,activityid,dtime,
									   if(t.newvisitor is null, 0, t.newvisitor) mnewvisitor
								  from video.t_video_sdk_current_d_hbase t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
					) tt
				 group by projectid, activitychannelid, activityid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>

		<!--当期 活跃的的用户数量 activeusers [游客和注册用户数]-->
		<multiHqlReportIndex>
			<indexKey>video.sdk.current.activeusers.dm</indexKey>
			<fieldName>mactiveusers</fieldName>
			<hql>
				<![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(userid)) mactiveusers
				  from (select t1.projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t2.dtime,
							   t1.userid
						  from (select t.c1 projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
						union all
						select t1.projectid,
							   if(t1.activitychannelid is null,'none',t1.activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t2.dtime,
							   t1.userid
						  from (select t.c1 projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
						union all
						select t1.projectid,
							   'ALL' activitychannelid,
							   if(t1.activityid is null,'none',t1.activityid) activityid,
							   t2.dtime,
							   t1.userid
						  from (select t.c1 projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
						union all
						select t1.projectid,
							   if(t1.activitychannelid is null,'none',t1.activitychannelid) activitychannelid,
							   if(t1.activityid is null,'none',t1.activityid) activityid,
							   t2.dtime,
							   t1.userid
						  from (select t.c1 projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
					) tt
				 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>
		
		<!--当期 注册用户活跃数 registeruseractive: 注册用户中有登陆、浏览、播放行为的数量-->
		<multiHqlReportIndex>
			<indexKey>video.sdk.current.registeruseractive.dm</indexKey>
			<fieldName>mregisteruseractive</fieldName>
			<hql>
				<![CDATA[
					select projectid,activitychannelid,activityid,dtime,
						   count(distinct(userid)) mregisteruseractive
				  from (select t1.projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t2.dtime,
							   t1.userid
						  from (select projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)
								   and t.usertype <> 'guest'
								   and t.projectid is not null) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
						union all
						select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t2.dtime,
							   t1.userid
						  from (select projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)
								   and t.usertype <> 'guest'
								   and t.projectid is not null) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
						union all
						select t1.projectid,
							   'ALL' activitychannelid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activityid,
							   t2.dtime,
							   t1.userid
						  from (select projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)
								   and t.usertype <> 'guest'
								   and t.projectid is not null) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
						union all
						select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   if(t1.activityid is null, 'none', t1.activityid) activityid,
							   t2.dtime,
							   t1.userid
						  from (select projectid,activitychannelid,activityid,t.date dtime, userid
								  from video.t_cdr_sdk_event_join_video_user t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.utcdate = (hour(from_unixtime(unix_timestamp(),'yyyy-MM-dd HH:mm:ss')) - 2)
								   and t.usertype <> 'guest'
								   and t.projectid is not null) t1,
							   (select dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
					) tt
					 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>
		
		<!--
		//截止当日的累计的游客总数，根据设备ID去重；同一个用户更换设备，按照新的游客用户统计。
		//
		//取当天累计游客总数
		-->
		
    </multiHqlReportIndexs>
</reportIndexGroup>
