<reportSuite>
    <reports>
        <report tableName = "t_video_sdk_current_d" 
				keyFields = "projectid,activitychannelid,activityid,dtime" 
				period = "daily" timeFormat = "yyyyMMdd" timeField = "dtime">
            <fieldDefinition>
                <field name="projectid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activitychannelid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activityid" regular="[0-9a-zA-Z./-]*"/>
                <field name="dtime"  regular="[0-9a-zA-Z./-]*"/>
            </fieldDefinition>
			<materialViewers>
			<!--
			******************************************************************************************
			//物化视图
			//新增非游客转化的注册用户数 newregisterusers
			//	新增注册用户数需要扣除由新增游客转化过来的用户，
			//	其中具体计算根据注册话单中的DID如果找到之前（30天内）有游客登录话单则不算新增注册用户。
			//若在浏览器中一键注册后，又进行注销操作，
			******************************************************************************************
			DROP TABLE T_MID_DAY_NOTCONVERT_REGISTEREDUSERS;
			CREATE TABLE video.T_MID_DAY_NOTCONVERT_REGISTEREDUSERS
			(
			projectid string,
			activitychannelid string,
			activityid string,
			clientid string,
			dtime string,
			identityid string,
			time  string
			)
			PARTITIONED BY(
			id string,
			date string
			)
			ROW FORMAT delimited fields terminated by '\t' MAP KEYS TERMINATED BY '&' STORED AS TEXTFILE;
			grant select,delete,insert on T_MID_DAY_NOTCONVERT_REGISTEREDUSERS to user mapred;
			
			grant select on table video.T_MID_DAY_NOTCONVERT_REGISTEREDUSERS to user tianjunjie;
			******************************************************************************************
			-->
				<materialViewer tableName = "video.T_MID_DAY_NOTCONVERT_REGISTEREDUSERS" clear="false" partition="id,date">
					<hql>
					<![CDATA[
					select projectid,activitychannelid,activityid,clientid,dtime,identityid,time,projectid id,dtime date
					  from (select distinct tt.*
							  from (select t.projectid,t.activitychannelid,t.activityid,t.clientid,t.dtime,t.identityid,t.time
									  from (select projectid,activitychannelid,activityid,clientid,t.date dtime,identityid,deviceid,time
											  from video.t_cdr_top_user_info t
											 where t.date > '{STARTTIME}'
											   and t.date < '{ENDTIME}'
											   and t.actiontype = 1
										) t
									  left join (select r1.c1 projectid,r2.dtime dtime,r1.userid,r1.deviceid
												  from video.t_cdr_sdk_event_join_video_user r1,
													   (select t.dtime
														  from video.t_bdi_muchtv_video_rundate t
														 where t.dtime > '{STARTTIME}'
														   and t.dtime < '{ENDTIME}') r2
												 where r1.date >
													   from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(r2.dtime,
														'yyyyMMdd'),'yyyy-MM-dd'),30),'yyyy-MM-dd'),'yyyyMMdd')
												   and r1.date <
													   from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(r2.dtime,
														'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')
												   and r1.deviceid = r1.userid
												   and r1.eventname = 'login'
												   and r1.eventlabel = 'guest'
										) s
										on t.deviceid = s.deviceid
									 where s.userid is null
								) tt
						) tb
					]]>
					</hql>
				</materialViewer>
			<!--
			******************************************************************************************
			//物化视图
			//新增游客(newvisitor)
			******************************************************************************************
			DROP TABLE T_MID_DAY_NEWLOGIN_VISITORS;
			CREATE TABLE video.T_MID_DAY_NEWLOGIN_VISITORS
			(
			projectid string,
			dtime string,
			userid string,
			time  string
			)
			PARTITIONED BY(
			id string,
			date string
			)
			ROW FORMAT delimited fields terminated by '\t' MAP KEYS TERMINATED BY '&' STORED AS TEXTFILE;
			grant select,delete,insert on T_MID_DAY_NEWLOGIN_VISITORS to user mapred;
			
			grant select on table video.T_MID_DAY_NEWLOGIN_VISITORS to user tianjunjie;
			******************************************************************************************
			-->
				<materialViewer tableName = "video.T_MID_DAY_NEWLOGIN_VISITORS" clear="false" partition="id,date">
					<hql>
					<![CDATA[
					  select projectid, dtime, userid, time, projectid id, dtime date
						from (select distinct tt.*
								from (select t1.c1     projectid,
											 t1.date   dtime,
											 t1.userid userid,
											 t1.time
										from (select t.*
												from video.t_cdr_sdk_event_join_video_user t
											   where t.date > '{STARTTIME}'
												 and t.date < '{ENDTIME}'
												 and t.projectid is null
												 and t.eventname = 'login'
												 and t.eventlabel = 'guest'
												 and t.userid = t.deviceid
											) t1
										left join (select r1.*, r2.dtime
													from (select *
															from video.t_cdr_sdk_event_join_video_user t
														   where t.projectid is null
															 and t.eventname = 'login'
															 and t.eventlabel = 'guest'
															 and t.userid = t.deviceid) r1,
														 (select dtime
															from video.t_bdi_muchtv_video_rundate t
														   where t.dtime > '{STARTTIME}'
															 and t.dtime < '{ENDTIME}') r2
												   where r1.date < r2.dtime
											) t2
										  on t1.userid = t2.userid
										 and t1.date = t2.dtime
									   where t2.c1 is null
									) tt
							) tb
					]]>
					</hql>
				</materialViewer>
			</materialViewers>
            <dimensions>
                <dimension id = "0" >
                    <reportIndex>
						video.sdk.current.newvisitor.d,
						video.sdk.current.activeusers.d,
                        video.sdk.current.registeruseractive.d,
						video.sdk.current.totalvisitor.d,
						video.sdk.current.activeusers.dw,
						video.sdk.current.registeruseractive.dw,
						video.sdk.current.activeusers.dm,
						video.sdk.current.registeruseractive.dm
                    </reportIndex>
                </dimension>
                <dimension id = "0" >
                    <reportIndex>
						video.sdk.current.newvisitor.dw,
						video.sdk.current.newvisitor.dm
                    </reportIndex>
                </dimension>
            </dimensions>
        </report>
    </reports>
</reportSuite>
