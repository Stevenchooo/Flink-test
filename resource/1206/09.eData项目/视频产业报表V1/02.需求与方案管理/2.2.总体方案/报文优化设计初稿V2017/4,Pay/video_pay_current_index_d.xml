<reportIndexGroup>
<!--
201705话单
operationType 计费类型： 1：订购 ; 2：退订 ; 3：点播 ; 4 : 续订 ; 5 : 预售激活
BILL_TYPE 帐单类型 ： 100:  话单费、 200:  月租费、 300:  优惠费用、 400:  一次性费用
货币分为：本币和美元，本币为，话单入库中的 if(fee is null,0,fee) fee, 美元需要BDI对本币进行汇率处理后得到 fee_usd(入库时候已经转换为元单位)
-->
    <multiHqlReportIndexs>
	<!--
	*********************************************************************************************
	//支付话单
	//近日指标
	*********************************************************************************************
	-->
		<!--  
		//当期 付费用户数 newpayuser
		//美元 当期 付费流水 newincome
		//本币 当期 付费流水 localnewincome
		-->
		<!--
		//按项目ID，取【支付话单】中，billtype为“400:一次性费用”的话单
		//当期 按次付费用户数 newclickuser
		//美元 当期 按次付费流水  newclick
		//本币 当期 按次付费流水  localnewclick
		-->
		<!--
		//取【支付话单】中，billtype为“200:  月租费”
		//当期 订阅用户数 newsubscribeuser
		//美元 当期 订阅流水 newsubscribe
		//本币 当期 订阅流水 localnewsubscribe
		-->
        <multiHqlReportIndex>
            <indexKey>video.pay.current.incomeanalyse.d</indexKey>
            <fieldName>newincome,localnewincome,newpayuser,newclick,localnewclick,newclickuser,newsubscribe,localnewsubscribe,newsubscribeuser</fieldName>
            <hql>
                <![CDATA[
				 select projectid,activitychannelid,activityid,dtime,
						sum( fee_usd ) newincome,
						sum( fee ) localnewincome,
						count(distinct(identityid) ) newpayuser,
						sum( newclick ) newclick,
						sum( localnewclick ) localnewclick,
						count(distinct(newclickuser) ) newclickuser,
						sum( newsubscribe ) newsubscribe,
						sum( localnewsubscribe ) localnewsubscribe,
						count(distinct(newsubscribeuser) ) newsubscribeuser
				 from (  select projectid,
								if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
								'ALL' activityid,
								t.date dtime,
								if(fee_usd is null,0,fee_usd) fee_usd,
								if(fee is null,0,fee) fee,
								identityid,
								if(t.bill_type = '400',t.fee_usd,0) newclick,
								if(t.bill_type = '400',t.fee,0) localnewclick,
								if(t.bill_type = '400',t.identityid,null) newclickuser,
								if(t.bill_type = '200',t.fee_usd,0) newsubscribe,
								if(t.bill_type = '200',t.fee,0) localnewsubscribe,
								if(t.bill_type = '200',t.identityid,null) newsubscribeuser
						   from video.t_cdr_top_payment_info t 
						  where t.date > '{STARTTIME}'
							and t.date < '{ENDTIME}'
						union all
						 select projectid,
								'ALL' activitychannelid,
								'ALL' activityid,
								t.date dtime,
								if(fee_usd is null,0,fee_usd) fee_usd,
								if(fee is null,0,fee) fee,
								identityid,
								if(t.bill_type = '400',t.fee_usd,0) newclick,
								if(t.bill_type = '400',t.fee,0) localnewclick,
								if(t.bill_type = '400',t.identityid,null) newclickuser,
								if(t.bill_type = '200',t.fee_usd,0) newsubscribe,
								if(t.bill_type = '200',t.fee,0) localnewsubscribe,
								if(t.bill_type = '200',t.identityid,null) newsubscribeuser
						   from video.t_cdr_top_payment_info t 
						  where t.date > '{STARTTIME}'
							and t.date < '{ENDTIME}'
						union all
						 select projectid,
								'ALL' activitychannelid,
								if(activityid is null, 'none', activityid) activityid,
								t.date dtime,
								if(fee_usd is null,0,fee_usd) fee_usd,
								if(fee is null,0,fee) fee,
								identityid,
								if(t.bill_type = '400',t.fee_usd,0) newclick,
								if(t.bill_type = '400',t.fee,0) localnewclick,
								if(t.bill_type = '400',t.identityid,null) newclickuser,
								if(t.bill_type = '200',t.fee_usd,0) newsubscribe,
								if(t.bill_type = '200',t.fee,0) localnewsubscribe,
								if(t.bill_type = '200',t.identityid,null) newsubscribeuser
						   from video.t_cdr_top_payment_info t 
						  where t.date > '{STARTTIME}'
							and t.date < '{ENDTIME}'
						union all
						 select projectid,
								if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
								if(activityid is null, 'none', activityid) activityid,
								t.date dtime,
								if(fee_usd is null,0,fee_usd) fee_usd,
								if(fee is null,0,fee) fee,
								identityid,
								if(t.bill_type = '400',t.fee_usd,0) newclick,
								if(t.bill_type = '400',t.fee,0) localnewclick,
								if(t.bill_type = '400',t.identityid,null) newclickuser,
								if(t.bill_type = '200',t.fee_usd,0) newsubscribe,
								if(t.bill_type = '200',t.fee,0) localnewsubscribe,
								if(t.bill_type = '200',t.identityid,null) newsubscribeuser
						   from video.t_cdr_top_payment_info t 
						  where t.date > '{STARTTIME}'
							and t.date < '{ENDTIME}'
					)tt
				 group by projectid,activitychannelid,dtime
                ]]>
            </hql>
        </multiHqlReportIndex>

		<!--  【支付话单】，根据支付时间（time）取当年的话单将fee字段累加 -->
		<!--  美元 当年累计流水 yearallincome  -->
		<!--  本币 当年累计流水 localyearallincome  -->
        <multiHqlReportIndex>
            <indexKey>video.pay.current.yearincome.d</indexKey>
            <fieldName>yearallincome,localyearallincome</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   sum(newincome) yearallincome,
					   sum(localnewincome) localyearallincome
				  from (select t1.projectid projectid,
							   if(t1.activitychannelid is null, 'ALL', t1.activitychannelid) activitychannelid,
							   if(t1.activityid is null, 'ALL', t1.activityid) activityid,
							   t2.dtime dtime,
							   if(t1.newincome is null, 0, t1.newincome) newincome,
							   if(t1.localnewincome is null, 0, t1.localnewincome) localnewincome
						  from video.t_video_pay_current_d_hbase t1,
							   (select t.dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   AND t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 4) = substr(t2.dtime, 0, 4)
						   and t1.dtime <= t2.dtime) tt
				 group by projectid, activitychannelid, activityid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--  ARPU每用户平均流水=当期付费流水 localnewincome /当期付费用户数 newpayuser  -->
		<!--  美元 ARPU		arpuincome  -->
		<!--  本币 ARPU		localarpuincome  -->
        <multiHqlReportIndex>
            <indexKey>video.pay.current.arpu.d</indexKey>
            <fieldName>arpuincome,localarpuincome</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   (newincome / newpayuser) arpuincome,
					   (localnewincome / newpayuser) localarpuincome
				  from (select projectid,
							   if(activitychannelid is null, 'ALL', activitychannelid) activitychannelid,
							   if(activityid is null, 'ALL', activityid) activityid,
							   dtime,
							   if(newincome is null, 0, newincome) newincome,
							   if(localnewincome is null, 0, localnewincome) localnewincome,
							   newpayuser
						  from video.t_video_pay_current_d_hbase t
						 where t.dtime > '{STARTTIME}'
						   and t.dtime < '{ENDTIME}'
					) tt
				 group by projectid,activitychannelid,activityid,dtime,
						  (newincome / newpayuser),
						  (localnewincome / newpayuser)
                ]]>
            </hql>
        </multiHqlReportIndex>
		
	<!--
	*********************************************************************************************
	//支付话单
	//当周指标
	*********************************************************************************************
	-->
		<!--
		//美元 当年累计流水 wyearallincome
		//本币 当年累计流水 wlocalyearallincome
		//
		//选取当天的当年流水作为当周指标
		-->
		
		<!--  
		//当期 付费用户数 wnewpayuser
		//美元 当期 付费流水 wnewincome
		//本币 当期 付费流水 wlocalnewincome
		//
		//按项目ID，取[支付话单]中，billtype为“400:一次性费用”的话单
		//当期 按次付费用户数 wnewclickuser
		//美元 当期 按次付费流水  wnewclick
		//本币 当期 按次付费流水  wlocalnewclick
		//
		//按项目ID，取[支付话单]中，billtype为“200:  月租费”
		//当期 订阅用户数 wnewsubscribeuser
		//美元 当期 订阅流水 wnewsubscribe
		//本币 当期 订阅流水 wlocalnewsubscribe
		//
		//备注：可以通过两个模块进行指标结算[收入]、[用户]，发现类同代码太多，故整合在一起
		-->
        <multiHqlReportIndex>
            <indexKey>video.pay.current.incomeanalyse.dw</indexKey>
            <fieldName>wnewincome,wlocalnewincome,wnewpayuser,wnewclick,wlocalnewclick,wnewclickuser,wnewsubscribe,wlocalnewsubscribe,wnewsubscribeuser</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,dtime,
					   sum(fee_usd) wnewincome,
					   sum(fee) wlocalnewincome,
					   count(distinct(identityid)) wnewpayuser,
					   sum(newclick) wnewclick,
					   sum(localnewclick) wlocalnewclick,
					   count(distinct(newclickuser)) wnewclickuser,
					   sum(newsubscribe) wnewsubscribe,
					   sum(localnewsubscribe) wlocalnewsubscribe,
					   count(distinct(newsubscribeuser)) wnewsubscribeuser
				  from (select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   t2.dtime,
							   if(t1.fee_usd is null, 0, t1.fee_usd) fee_usd,
							   if(t1.fee is null, 0, t1.fee) fee,
							   t1.identityid,
							   if(t1.bill_type = '400', t1.fee_usd, 0) newclick,
							   if(t1.bill_type = '400', t1.fee, 0) localnewclick,
							   if(t1.bill_type = '400', t1.identityid, null) newclickuser,
							   if(t1.bill_type = '200', t1.fee_usd, 0) newsubscribe,
							   if(t1.bill_type = '200', t1.fee, 0) localnewsubscribe,
							   if(t1.bill_type = '200', t1.identityid, null) newsubscribeuser
						  from (select projectid,activitychannelid,t.date dtime,fee_usd,fee,identityid,bill_type
								  from video.t_cdr_top_payment_info t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}') t1,
							   (select t.dtime, t.weekdays
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')
					union all
						select t1.projectid,
							   'ALL' activitychannelid,
							   t2.dtime,
							   if(t1.fee_usd is null, 0, t1.fee_usd) fee_usd,
							   if(t1.fee is null, 0, t1.fee) fee,
							   t1.identityid,
							   if(t1.bill_type = '400', t1.fee_usd, 0) newclick,
							   if(t1.bill_type = '400', t1.fee, 0) localnewclick,
							   if(t1.bill_type = '400', t1.identityid, null) newclickuser,
							   if(t1.bill_type = '200', t1.fee_usd, 0) newsubscribe,
							   if(t1.bill_type = '200', t1.fee, 0) localnewsubscribe,
							   if(t1.bill_type = '200', t1.identityid, null) newsubscribeuser
						  from (select projectid,activitychannelid,t.date dtime,fee_usd,fee,identityid,bill_type
								  from video.t_cdr_top_payment_info t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}') t1,
							   (select t.dtime, t.weekdays
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')
						
						) tt
				 group by projectid, activitychannelid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--  ARPU每用户平均流水=当期付费流水 localnewincome /当期付费用户数 newpayuser  -->
		<!--  美元 ARPU		arpuincome  -->
		<!--  本币 ARPU		localarpuincome  -->
        <multiHqlReportIndex>
            <indexKey>video.pay.current.arpu.d</indexKey>
            <fieldName>warpuincome,wlocalarpuincome</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,dtime,
					   (wnewincome / wnewpayuser) warpuincome,
					   (wlocalnewincome / wnewpayuser) wlocalarpuincome
				  from (select projectid,
							   if(activitychannelid is null, 'ALL', activitychannelid) activitychannelid,
							   dtime,
							   if(t.wnewincome is null, 0, t.wnewincome) wnewincome,
							   if(t.wlocalnewincome is null, 0, t.wlocalnewincome) wlocalnewincome,
							   if(t.wnewpayuser is null, 0, t.wnewpayuser) wnewpayuser
						  from video.t_video_pay_current_d_hbase t
						 where t.dtime > '{STARTTIME}'
						   and t.dtime < '{ENDTIME}') tt
				 group by projectid,activitychannelid,dtime,
						  (wnewincome / wnewpayuser),
						  (wlocalnewincome / wnewpayuser)
                ]]>
            </hql>
        </multiHqlReportIndex>

	<!--
	*********************************************************************************************
	//支付话单
	//当月指标
	*********************************************************************************************
	-->
		<!--  
		美元 当年累计流水 yearallincome
		本币 当年累计流水 localyearallincome  
		直接选取当天的当年流水作为当月指标
		-->
		<!--  
		//当期 付费用户数 newpayuser
		//美元 当期 付费流水 newincome
		//本币 当期 付费流水 localnewincome
		-->
		<!--
		//按项目ID，取【支付话单】中，billtype为“400:一次性费用”的话单
		//当期 按次付费用户数 newclickuser
		//美元 当期 按次付费流水  newclick
		//本币 当期 按次付费流水  localnewclick
		-->
		<!--
		//取【支付话单】中，billtype为“200:  月租费”
		//当期 订阅用户数 newsubscribeuser
		//美元 当期 订阅流水 newsubscribe
		//本币 当期 订阅流水 localnewsubscribe
		-->
        <multiHqlReportIndex>
            <indexKey>video.pay.current.incomeanalyse.dm</indexKey>
            <fieldName>mnewincome,mlocalnewincome,mnewpayuser,mnewclick,mlocalnewclick,mnewclickuser,mnewsubscribe,mlocalnewsubscribe,mnewsubscribeuser</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,dtime,
					   sum(fee_usd) mnewincome,
					   sum(fee) mlocalnewincome,
					   count(distinct(identityid)) mnewpayuser,
					   sum(newclick) mnewclick,
					   sum(localnewclick) mlocalnewclick,
					   count(distinct(newclickuser)) mnewclickuser,
					   sum(newsubscribe) mnewsubscribe,
					   sum(localnewsubscribe) mlocalnewsubscribe,
					   count(distinct(newsubscribeuser)) mnewsubscribeuser
				  from (select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   t2.dtime,
							   if(t1.fee_usd is null, 0, t1.fee_usd) fee_usd,
							   if(t1.fee is null, 0, t1.fee) fee,
							   t1.identityid,
							   if(t1.bill_type = '400', t1.fee_usd, 0) newclick,
							   if(t1.bill_type = '400', t1.fee, 0) localnewclick,
							   if(t1.bill_type = '400', t1.identityid, null) newclickuser,
							   if(t1.bill_type = '200', t1.fee_usd, 0) newsubscribe,
							   if(t1.bill_type = '200', t1.fee, 0) localnewsubscribe,
							   if(t1.bill_type = '200', t1.identityid, null) newsubscribeuser
						  from (select projectid,activitychannelid,t.date dtime,fee_usd,fee,identityid,bill_type
								  from video.t_cdr_top_payment_info t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)) t1,
							   (select t.dtime, t.weekdays
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
					union all
						select t1.projectid,
							   'ALL' activitychannelid,
							   t2.dtime,
							   if(t1.fee_usd is null, 0, t1.fee_usd) fee_usd,
							   if(t1.fee is null, 0, t1.fee) fee,
							   t1.identityid,
							   if(t1.bill_type = '400', t1.fee_usd, 0) newclick,
							   if(t1.bill_type = '400', t1.fee, 0) localnewclick,
							   if(t1.bill_type = '400', t1.identityid, null) newclickuser,
							   if(t1.bill_type = '200', t1.fee_usd, 0) newsubscribe,
							   if(t1.bill_type = '200', t1.fee, 0) localnewsubscribe,
							   if(t1.bill_type = '200', t1.identityid, null) newsubscribeuser
						  from (select projectid,activitychannelid,t.date dtime,fee_usd,fee,identityid,bill_type
								  from video.t_cdr_top_payment_info t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)) t1,
							   (select t.dtime, t.weekdays
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
						) tt
				 group by projectid, activitychannelid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--  ARPU每用户平均流水=当期付费流水 localnewincome /当期付费用户数 newpayuser  -->
		<!--  美元 ARPU		arpuincome  -->
		<!--  本币 ARPU		localarpuincome  -->
        <multiHqlReportIndex>
            <indexKey>video.pay.current.arpu.dm</indexKey>
            <fieldName>marpuincome,mlocalarpuincome</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,dtime,
					   (mnewincome / mnewpayuser) marpuincome,
					   (mlocalnewincome / mnewpayuser) mlocalarpuincome
				  from (select projectid,
							   if(activitychannelid is null, 'ALL', activitychannelid) activitychannelid,
							   dtime,
							   if(t.mnewincome is null, 0, t.mnewincome) mnewincome,
							   if(t.mlocalnewincome is null, 0, t.mlocalnewincome) mlocalnewincome,
							   if(t.mnewpayuser is null, 0, t.mnewpayuser) mnewpayuser
						  from video.t_video_pay_current_d_hbase t
						 where t.dtime > '{STARTTIME}'
						   and t.dtime < '{ENDTIME}') tt
				 group by projectid,activitychannelid,dtime,
						  (mnewincome / mnewpayuser),
						  (mlocalnewincome / mnewpayuser)
                ]]>
            </hql>
        </multiHqlReportIndex>

    </multiHqlReportIndexs>
</reportIndexGroup>
