<reportIndexGroup>
<!--  
//操作类型	actionType	1：订购 ; 2：退订 ; 3：点播 ; 4 : 续订 ;[20161110修订]
//使用STATUS字段相关枚举值已刷新；订购状态：1：已订购、 2：暂停期、 3：宽限期、 4：观察期、 5：免费期、 6：保留、 9：已退订[20161107]
-->
    <multiHqlReportIndexs>
	<!--
	*********************************************************************************************
	//订购话单
	//近日指标
	//产品订购分析 界面[projectid,activitychannelid,productid]
	//活动运营 界面[projectid,activitychannelid,activityid]
	*********************************************************************************************
	-->
		<!--
		//(产品订购分析)
		//新增订购用户数：neworderuser [t.actiontype = 1 OR t.actiontype = 3]
		//新增订购次数: newordertimes [t.actiontype = 2]
		//新增取消订购用户数： loseorderuser
		//新增取消订购订购次数 loseordertimes 
		-->
		<!--  
		//(活动运营)
		//新增订购用户数 neworderuser ： 活动当期订购套餐的用户数 t.actiontype = 1
		//新增退订用户数 loseordertimes ：活动当期退订套餐的用户数。 t.actiontype = 2
		-->
        <multiHqlReportIndex>
            <indexKey>video.order.current.orderuser.d</indexKey>
            <fieldName>newordertimes,neworderuser,loseordertimes,loseorderuser</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,productid,dtime,
					   count(neworder) newordertimes,
					   count(distinct(neworder)) neworderuser,
					   count(loseorder) loseordertimes,
					   count(distinct(loseorder)) loseorderuser
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   'ALL' activityid,
							   if(t.productid is null, 'none', t.productid) productid,
							   t.date dtime,
							   if(t.actiontype = 1 OR t.actiontype = 3, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from video.t_cdr_top_order_info t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   if(t.productid is null, 'none', t.productid) productid,
							   t.date dtime,
							   if(t.actiontype = 1 OR t.actiontype = 3, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from video.t_cdr_top_order_info t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   if(t.activitychannelid is null, 'none', t.activitychannelid) activitychannelid,
							   if(t.activityid is null, 'none', t.activityid) activityid,
							   'ALL' productid,
							   t.date dtime,
							   if(t.actiontype = 1, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from video.t_cdr_top_order_info t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   if(t.activityid is null, 'none', t.activityid) activityid,
							   'ALL' productid,
							   t.date dtime,
							   if(t.actiontype = 1, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from video.t_cdr_top_order_info t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						) tt
				 group by projectid, activitychannelid, activityid, productid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--  订购 某产品 的 总用户数 allorderuser  -->
		<!--  总订购次数 allordertimes  -->
		<!--  当期 相关产品的名称   productname  -->
		<!--  当期 相关产品类型   productCatalog  -->
		<!--  当期 相关产品 订购 类型   productordertype -->
		<!--
		订购类型和产品类型属性，
		通过【订购话单】中的产品ID和actionType进行处理，关联【合约信息话单】或者【商品信息话单】。
		Actiontype=3时，取【商品信息话单】，获取productCatalog展示产品类型；直接设置“按次”作为订购类型。
		Actiontype=1时，取【合约信息话单】获取productCatalog展示产品类型；取 cycleType 作为订购类型。
		产品名称属性，取【商品信息话单】和【合约信息话单】的productName字段。
		
		统计项计算逻辑：
		总订购次数：按项目ID，取当期最后一天的【订购话单】中actiontype=1/3的话单计数。
		取消订购次数：取时间段内的【订购话单】中actiontype=2的话单计数。
		-->
        <multiHqlReportIndex>
            <indexKey>video.order.current.product.allorder.d</indexKey>
            <fieldName>productname,productcatalog,productordertype,allordertimes,allorderuser</fieldName>
            <hql>
                <![CDATA[
				 select projectid,activitychannelid,activityid,productid,dtime,
						productname,
						productcatalog,
						productordertype,						
						count(identityid) allordertimes,
						count(distinct(identityid)) allorderuser
				 from ( select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   'ALL' activityid,
							   if(t1.productid is null, 'none', t1.productid) productid,
							   t1.dtime,
							   if(t2.productname is null, t1.productid, t2.productname) productname,
							   t2.productcatalog,
							   if(t1.actiontype = 3, '按次', t2.cycletype) productordertype,
							   t1.identityid
						  from (select s1.projectid,s1.activitychannelid,s1.productid,s2.dtime,s1.identityid,s1.actiontype
								  from (select projectid,activitychannelid,productid,t.date dtime,identityid,actiontype
										  from video.t_cdr_top_order_info t
										 where t.actiontype in (1, 3)) s1,
									   (select t.dtime
										  from video.t_bdi_muchtv_video_rundate t
										 where t.dtime > '{STARTTIME}'
										   and t.dtime < '{ENDTIME}') s2
								 where s1.dtime <= s2.dtime) t1
						  left join (select productid,productcatalog,producttype,productname,cycletype
									   from video.t_cdr_top_product_info t) t2
							on t1.productid = t2.productid
					union all
						 select t1.projectid projectid,
								'ALL' activitychannelid,
								'ALL' activityid,
							   if(t1.productid is null, 'none', t1.productid) productid,
							   t1.dtime,
							   if(t2.productname is null, t1.productid, t2.productname) productname,
							   t2.productcatalog,
							   if(t1.actiontype = 3, '按次', t2.cycletype) productordertype,
							   t1.identityid
						  from (select s1.projectid,s1.activitychannelid,s1.productid,s2.dtime,s1.identityid,s1.actiontype
								  from (select projectid,activitychannelid,productid,t.date dtime,identityid,actiontype
										  from video.t_cdr_top_order_info t
										 where t.actiontype in (1, 3)) s1,
									   (select t.dtime
										  from video.t_bdi_muchtv_video_rundate t
										 where t.dtime > '{STARTTIME}'
										   and t.dtime < '{ENDTIME}') s2
								 where s1.dtime <= s2.dtime) t1
						  left join (select productid,productcatalog,producttype,productname,cycletype
									   from video.t_cdr_top_product_info t) t2
							on t1.productid = t2.productid
					)tt
				 group by projectid,activitychannelid,activityid,productid,dtime,
						  productname,
						  productcatalog,
						  productordertype
                ]]>
            </hql>
        </multiHqlReportIndex>

		<!--  
		//总 订购用户占比 = 单产品订购用户数/（产品）总订购用户数*100% orderuserproportion  
		//注意【单产品订购用户数】为某一产品订购的总用户
		//
		//[201705变更] 订购用户占比= 单产品订购用户数/(单项目)sum(产品订购用户数)
		-->
        <multiHqlReportIndex>
            <indexKey>video.order.current.product.orderuserproportion.d</indexKey>
            <fieldName>orderuserproportion</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,productid,dtime,
					   (allorderuser / allproductorder) orderuserproportion
				  from (select s1.projectid,s1.activitychannelid,s1.productid,'ALL' activityid,s1.dtime,s1.allorderuser,s2.allproductorder
						  from (select projectid,
									   if(activitychannelid is null, 'ALL', activitychannelid) activitychannelid,
									   productid,
									   dtime,
									   if(t.allorderuser is null,0,t.allorderuser) allorderuser
								  from video.t_video_order_current_d_hbase t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}'
								   and t.activityid is null
								   and t.productid is not null) s1,
							   (select projectid,dtime,
									   sum(if(allorderuser is null, 0, allorderuser)) allproductorder
								  from video.t_video_order_current_d_hbase t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}'
								   and t.activitychannelid is null
								   and t.activityid is null
								   and t.productid is not null
								 group by projectid, dtime) s2
						 where s1.projectid = s2.projectid
						   and s1.dtime = s2.dtime
					) tt
				 group by projectid,activitychannelid,activityid,productid,dtime,
						  (allorderuser / allproductorder)
                ]]>
            </hql>
        </multiHqlReportIndex>
	
		<!-- 免费期订购用户数 freeexperienceuser ：活动当期处于免费体验期的用户数量-->
		<!-- 正式期订购用户数 regularorderuser ：活动当期处于正式期期的用户数量 -->
		<!-- 使用STATUS字段相关枚举值已刷新；订购状态：1：已订购、 2：暂停期、 3：宽限期、 4：观察期、 5：免费期、 6：保留、 9：已退订[20161107]-->
		<multiHqlReportIndex>
			<indexKey>video.order.current.activity.freeandregular.d</indexKey>
			<fieldName>freeexperienceuser,regularorderuser</fieldName>
			<hql>
				<![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(freeexperience)) freeexperienceuser,
					   count(distinct(regular)) regularorderuser
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   if(activityid is null, 'none', activityid) activityid,
							   'ALL' productid,
							   t.date dtime,
							   if(t.status = 5, t.identityid, null) freeexperience,
							   if(t.status = 1, t.identityid, null) regular
						  from video.t_cdr_top_order_info t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						   and t.actiontype = 1
						   and t.status in (5, 1)
						union all
						select projectid,
							   'ALL' activitychannelid,
							   if(activityid is null, 'none', activityid) activityid,
							   'ALL' productid,
							   t.date dtime,
							   if(t.status = 5, t.identityid, null) freeexperience,
							   if(t.status = 1, t.identityid, null) regular
						  from video.t_cdr_top_order_info t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						   and t.actiontype = 1
						   and t.status in (5, 1)) tt
				 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>
		
		<!-- 
		//(活动运营)
		//累计订购用户数 totalorderpackageuser ： 活动累计订购套餐的用户数，不含退订用户
		//累计退订用户数 totalloseorderuser ：活动累计退订套餐的用户数
		-->
		<multiHqlReportIndex>
			<indexKey>video.order.current.activity.totalorderandlose.d</indexKey>
			<fieldName>totalorderpackageuser,totalloseorderuser</fieldName>
			<hql>
				<![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(neworder)) totalorderpackageuser,
					   count(distinct(newlose)) totalloseorderuser
				  from (select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   if(t1.activityid is null, 'none', t1.activityid) activityid,
							   t2.dtime,
							   if(t1.actiontype = 1, t1.identityid, null) neworder,
							   if(t1.actiontype = 2, t1.identityid, null) newlose
						  from video.t_cdr_top_order_info t1,
							   (select t.*
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.date <= t2.dtime
						   and t1.actiontype in (1, 2)
						union all
						select t1.projectid,
							   'ALL' activitychannelid,
							   if(t1.activityid is null, 'none', t1.activityid) activityid,
							   t2.dtime,
							   if(t1.actiontype = 1, t1.identityid, null) neworder,
							   if(t1.actiontype = 2, t1.identityid, null) newlose
						  from video.t_cdr_top_order_info t1,
							   (select t.*
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.date <= t2.dtime
						   and t1.actiontype in (1, 2)
						) tt
				 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>

	<!--
	*********************************************************************************************
	//订购话单
	//当周指标
	//产品订购分析 界面[projectid,activitychannelid,productid]
	//活动运营 界面[projectid,activitychannelid,activityid]
	*********************************************************************************************
	-->
		<!--
		//新增订购用户数：neworderuser
		//新增订购次数: newordertimes
		//新增取消订购用户数： loseorderuser
		//新增取消订购订购次数 loseordertimes 
		-->
        <multiHqlReportIndex>
            <indexKey>video.order.current.orderuser.dw</indexKey>
			<macroList>
				<macro>
					<name>ORDERUSER_WEEK</name>
					<value>
					<![CDATA[
					select t1.projectid,t1.activitychannelid,t1.activityid,t1.productid,t2.dtime,t1.identityid,t1.actiontype
						  from (select projectid,activitychannelid,activityid,productid,t.date datatime,identityid,actiontype
								  from video.t_cdr_top_order_info t
								 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}'
								   and t.actiontype in (1,2,3)) t1,
							   (select t.dtime, t.weekdays,from_unixtime(unix_timestamp(t.dtime, 'yyyyMMdd'),'yyyy-MM-dd') formaltime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.datatime > from_unixtime(unix_timestamp(date_sub(t2.formaltime,t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.datatime <=t2.dtime
					]]>
					</value>
				</macro>
			</macroList>
            <fieldName>wnewordertimes,wneworderuser,wloseordertimes,wloseorderuser</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,productid,dtime,
					   count(neworder) wnewordertimes,
					   count(distinct(neworder)) wneworderuser,
					   count(loseorder) wloseordertimes,
					   count(distinct(loseorder)) wloseorderuser
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   'ALL' activityid,
							   if(t.productid is null, 'none', t.productid) productid,
							   t.date dtime,
							   if(t.actiontype = 1 OR t.actiontype = 3, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from ({ORDERUSER_WEEK})t
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   if(t.productid is null, 'none', t.productid) productid,
							   t.date dtime,
							   if(t.actiontype = 1 OR t.actiontype = 3, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from ({ORDERUSER_WEEK})t
						union all
						select projectid,
							   if(t.activitychannelid is null, 'none', t.activitychannelid) activitychannelid,
							   if(t.activityid is null, 'none', t.activityid) activityid,
							   'ALL' productid,
							   t.date dtime,
							   if(t.actiontype = 1, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from ({ORDERUSER_WEEK})t
						union all
						select projectid,
							   'ALL' activitychannelid,
							   if(t.activityid is null, 'none', t.activityid) activityid,
							   'ALL' productid,
							   t.date dtime,
							   if(t.actiontype = 1, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from ({ORDERUSER_WEEK})t
						) tt
				 group by projectid, activitychannelid, activityid, productid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!-- 免费期订购用户数 freeexperienceuser ：活动当期处于免费体验期的用户数量-->
		<!-- 正式期订购用户数 regularorderuser ：活动当期处于正式期期的用户数量 -->
		<!-- 使用STATUS字段相关枚举值已刷新；订购状态：1：已订购、 2：暂停期、 3：宽限期、 4：观察期、 5：免费期、 6：保留、 9：已退订[20161107]-->
		<multiHqlReportIndex>
			<indexKey>video.order.current.activity.freeandregular.dw</indexKey>
			<macroList>
				<macro>
					<name>FREEANDREGUL_WEEK</name>
					<value>
					<![CDATA[
					select t1.projectid,t1.activitychannelid,t1.activityid,t2.dtime,t1.identityid,t1.status
						  from (select projectid,activitychannelid,activityid,t.date datatime,identityid,status
								  from video.t_cdr_top_order_info t
								 where t.date > '{STARTTIME}'
								   and t.date < '{ENDTIME}'
								   and t.actiontype = 1
								   and t.status in (5, 1)) t1,
							   (select t.dtime, t.weekdays,from_unixtime(unix_timestamp(t.dtime, 'yyyyMMdd'),'yyyy-MM-dd') formaltime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where t1.datatime > from_unixtime(unix_timestamp(date_sub(t2.formaltime,t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						   and t1.datatime <=t2.dtime
					]]>
					</value>
				</macro>
			</macroList>
			<fieldName>wfreeexperienceuser,wregularorderuser</fieldName>
			<hql>
				<![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(freeexperience)) wfreeexperienceuser,
					   count(distinct(regular)) wregularorderuser
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   if(activityid is null, 'none', activityid) activityid,
							   'ALL' productid,
							   t.date dtime,
							   if(t.status = 5, t.identityid, null) freeexperience,
							   if(t.status = 1, t.identityid, null) regular
						  from ({FREEANDREGUL_WEEK})t
						union all
						select projectid,
							   'ALL' activitychannelid,
							   if(activityid is null, 'none', activityid) activityid,
							   'ALL' productid,
							   t.date dtime,
							   if(t.status = 5, t.identityid, null) freeexperience,
							   if(t.status = 1, t.identityid, null) regular
						  from ({FREEANDREGUL_WEEK})t
					) tt
				 group by projectid, activitychannelid, activityid, dtime
				]]>
			</hql>
		</multiHqlReportIndex>
		
	<!--
	*********************************************************************************************
	//订购话单 
	//当月指标 the month 
	//产品订购分析 界面[projectid,activitychannelid,productid]
	//活动运营 界面[projectid,activitychannelid,activityid]
	*********************************************************************************************
	-->
		<!--
		//(产品订购分析)
		//新增订购用户数：neworderuser [t.actiontype = 1 OR t.actiontype = 3]
		//新增订购次数: newordertimes [t.actiontype = 2]
		//新增取消订购用户数： loseorderuser
		//新增取消订购订购次数 loseordertimes 
		-->
        <multiHqlReportIndex>
            <indexKey>video.order.current.product.orderuser.dm</indexKey>
			<macroList>
				<macro>
					<name>ORDERUSER_MONTH</name>
					<value>
					<![CDATA[
					select t1.projectid,t1.activitychannelid,t1.activityid,t1.productid,t2.dtime,t1.identityid,t1.actiontype
						  from (select projectid,activitychannelid,activityid,t.date dtime,productid,identityid,actiontype
								  from video.t_cdr_top_order_info t
								 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								   and t.actiontype in (1,2,3)) t1,
							   (select t.dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
						   and t1.dtime <= t2.dtime
					]]>
					</value>
				</macro>
			</macroList>
            <fieldName>mnewordertimes,mneworderuser,mloseordertimes,mloseorderuser</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,productid,dtime,
					   count(neworder) mnewordertimes,
					   count(distinct(neworder)) mneworderuser,
					   count(loseorder) mloseordertimes,
					   count(distinct(loseorder)) mloseorderuser
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   'ALL' activityid,
							   if(t.productid is null, 'none', t.productid) productid,
							   t.date dtime,
							   if(t.actiontype = 1 OR t.actiontype = 3, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from ({ORDERUSER_MONTH})t
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   if(t.productid is null, 'none', t.productid) productid,
							   t.date dtime,
							   if(t.actiontype = 1 OR t.actiontype = 3, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from video.t_cdr_top_order_info t
						 where ({ORDERUSER_MONTH})t
						) tt
				 group by projectid, activitychannelid, activityid, productid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
    </multiHqlReportIndexs>
</reportIndexGroup>
