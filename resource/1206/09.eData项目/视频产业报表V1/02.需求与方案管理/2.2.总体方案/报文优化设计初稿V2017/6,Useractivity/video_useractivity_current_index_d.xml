<reportIndexGroup>
<!--  
//taskstatus 	处理任务状态: 0：处理中; 1:  操作成功; 2:  操作失败
//activitytype  被推广对象的类型(属性) : 0: 一键订购推广活动; 1: 一键注册推广活动; 2: WEB URL推广活动
-->
    <multiHqlReportIndexs>
	<!--
	*********************************************************************************************
	//推广活动参与信息话单
	//近日指标
	//渠道结算统计 界面[projectid,activitychannelid]
	//活动运营 界面[projectid,activitychannelid,activityid]
	*********************************************************************************************
	-->
		<!--点击量 clickrate ： 通过渠道点击前转到TOP的请求　-->
        <multiHqlReportIndex>
            <indexKey>video.ua.current.activity.clickrate.d</indexKey>
            <fieldName>clickrate</fieldName>
            <hql>
                <![CDATA[
 				 select projectid,activitychannelid,activityid,dtime,
						count(transactionid) clickrate
				 from (  select projectid,
								if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
								if(activityid is null,'none',activityid) activityid,
								t.date dtime,
								transactionid
						   from video.t_cdr_top_useractivityinfo t 
						  where t.date > '{STARTTIME}'
							and t.date < '{ENDTIME}'
						union all
						 select projectid,
								'ALL' activitychannelid,
								if(activityid is null,'none',activityid) activityid,
								t.date dtime,
								transactionid
						   from video.t_cdr_top_useractivityinfo t 
						  where t.date > '{STARTTIME}'
							and t.date < '{ENDTIME}'
					)tt
				 group by projectid,activitychannelid,activityid,dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--当期 点击量	cpaclickrate 通过渠道点击前转到TOP的请求数(一键订购所有点击)t.activitytype = 0-->
		<!--当期 点击量	cpcclickrate 通过渠道点击前转到TOP的请求数(所有的一键注册点击量)t.activitytype = 1-->
		<multiHqlReportIndex>
            <indexKey>video.ua.current.settlement.cpclickrate.d</indexKey>
            <fieldName>cpaclickrate,cpcclickrate</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(cpaclick) cpaclickrate,
					   count(cpcclick) cpcclickrate
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   if(t.activitytype = 0, t.transactionid, null) cpaclick,
							   if(t.activitytype = 1, t.transactionid, null) cpcclick
						  from video.t_cdr_top_useractivityinfo t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   if(t.activitytype = 0, t.transactionid, null) cpaclick,
							   if(t.activitytype = 1, t.transactionid, null) cpcclick
						  from video.t_cdr_top_useractivityinfo t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}') tt
				 group by projectid, activitychannelid, activityid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--  转换量 conversionquantity ：成功完成点击的次数，根据活动的不同，取值为：一键注册用户次数或者一键订购用户次　-->
		<!--
		//一键订购转化量 keyorderpromotion : 一键订购用户成功次数(活动运营,activityid is not null,渠道结算统计,cpa)
		//一键注册转化量 keyregisterpromotion : 一键注册用户成功次数(活动运营,activityid is not null,渠道结算统计,cpc)
		-->
        <multiHqlReportIndex>
            <indexKey>video.ua.current.conversionquantity.d</indexKey>
            <fieldName>conversionquantity,keyorderpromotion,keyregisterpromotion</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(transactionid)) conversionquantity,
					   count(distinct(keyorderpromotion)) keyorderpromotion,
					   count(distinct(keyregisterpromotion)) keyregisterpromotion
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   if(activityid is null, 'none', activityid) activityid,
							   t.date dtime,
							   if(t.activitytype = 0, transactionid, null) keyorderpromotion,
							   if(t.activitytype = 1, transactionid, null) keyregisterpromotion,
							   transactionid
						  from video.t_cdr_top_useractivityinfo t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						   and t.taskstatus = '1'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   if(activityid is null, 'none', activityid) activityid,
							   t.date dtime,
							   if(t.activitytype = 0, transactionid, null) keyorderpromotion,
							   if(t.activitytype = 1, transactionid, null) keyregisterpromotion,
							   transactionid
						  from video.t_cdr_top_useractivityinfo t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						   and t.taskstatus = '1'
						union all
						select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   if(t.activitytype = 0, transactionid, null) keyorderpromotion,
							   if(t.activitytype = 1, transactionid, null) keyregisterpromotion,
							   transactionid
						  from video.t_cdr_top_useractivityinfo t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						   and t.taskstatus = '1'
						   and t.transactionstatus = 1
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   if(t.activitytype = 0, transactionid, null) keyorderpromotion,
							   if(t.activitytype = 1, transactionid, null) keyregisterpromotion,
							   transactionid
						  from video.t_cdr_top_useractivityinfo t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						   and t.taskstatus = '1'
						   and t.transactionstatus = 1) tt
				 group by projectid, activitychannelid, activityid, dtime			
                ]]>
            </hql>
        </multiHqlReportIndex>

	<!--
	*********************************************************************************************
	//推广活动参与信息话单
	//当周指标
	//活动运营 界面[projectid,activitychannelid,activityid]
	*********************************************************************************************
	-->
		<!--点击量 clickrate ： 通过渠道点击前转到TOP的请求　-->
        <multiHqlReportIndex>
            <indexKey>video.ua.current.activity.clickrate.dw</indexKey>
            <fieldName>wclickrate</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   sum(clickrate) wclickrate
				from (select t1.projectid,
							 if(t1.activitychannelid is null,'ALL',t1.activitychannelid) activitychannelid,
							 if(t1.activityid is null, 'none', t1.activityid) activityid,
							 t2.dtime,
							 if(t1.clickrate is null,0,t1.clickrate) clickrate
						from (select projectid,activitychannelid,activityid,t.dtime datatime,clickrate
								from video.t_video_useractivity_current_d_hbase t
							   where t.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								 and t.dtime < '{ENDTIME}') t1,
							 (select t.dtime,t.weekdays,from_unixtime(unix_timestamp(t.dtime, 'yyyyMMdd'),'yyyy-MM-dd') formaltime
								from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
								 and t.dtime < '{ENDTIME}') t2
					   where t1.datatime > from_unixtime(unix_timestamp(date_sub(t2.formaltime,t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						 and t1.datatime <= t2.dtime
					) tt
				group by projectid, activitychannelid, activityid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>

		<!--
		//转换量 conversionquantity ：成功完成点击的次数，根据活动的不同，取值为：一键注册用户次数或者一键订购用户次
		//一键订购转化量 keyorderpromotion : 一键订购用户成功次数
		//一键注册转化量 keyregisterpromotion : 一键注册用户成功次数
		-->
        <multiHqlReportIndex>
            <indexKey>video.ua.current.activity.conversionquantity.dw</indexKey>
            <fieldName>wconversionquantity,wkeyorderpromotion,wkeyregisterpromotion</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(transactionid)) wconversionquantity,
					   count(distinct(keyorderpromotion)) wkeyorderpromotion,
					   count(distinct(keyregisterpromotion)) wkeyregisterpromotion
				  from (select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   if(t1.activityid is null, 'none', t1.activityid) activityid,
							   t2.dtime,
							   if(t1.activitytype = 0, t1.transactionid, null) keyorderpromotion,
							   if(t1.activitytype = 1, t1.transactionid, null) keyregisterpromotion,
							   t1.transactionid
						from (select projectid,activitychannelid,activityid,t.date datatime,transactionid,activitytype
								from video.t_cdr_top_useractivityinfo t
							   where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								 and t.date < '{ENDTIME}'
								 and t.taskstatus = '1') t1,
							 (select t.dtime,t.weekdays,from_unixtime(unix_timestamp(t.dtime, 'yyyyMMdd'),'yyyy-MM-dd') formaltime
								from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
								 and t.dtime < '{ENDTIME}') t2
					   where t1.datatime > from_unixtime(unix_timestamp(date_sub(t2.formaltime,t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						 and t1.datatime <= t2.dtime
						union all
						select t1.projectid,
							   'ALL' activitychannelid,
							   if(t1.activityid is null, 'none', t1.activityid) activityid,
							   t2.dtime,
							   if(t1.activitytype = 0, t1.transactionid, null) keyorderpromotion,
							   if(t1.activitytype = 1, t1.transactionid, null) keyregisterpromotion,
							   t1.transactionid
						from (select projectid,activitychannelid,activityid,t.date datatime,transactionid,activitytype
								from video.t_cdr_top_useractivityinfo t
							   where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								 and t.date < '{ENDTIME}'
								 and t.taskstatus = '1') t1,
							 (select t.dtime,t.weekdays,from_unixtime(unix_timestamp(t.dtime, 'yyyyMMdd'),'yyyy-MM-dd') formaltime
								from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
								 and t.dtime < '{ENDTIME}') t2
					   where t1.datatime > from_unixtime(unix_timestamp(date_sub(t2.formaltime,t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
						 and t1.datatime <= t2.dtime
					) tt
				 group by projectid, activitychannelid, activityid, dtime			
                ]]>
            </hql>
        </multiHqlReportIndex>
	<!--
	*********************************************************************************************
	//推广活动参与信息话单
	//当月指标
	//渠道结算统计 界面[projectid,activitychannelid]
	//活动运营 界面[projectid,activitychannelid,activityid]
	*********************************************************************************************
	-->
		<!--点击量 clickrate ： 通过渠道点击前转到TOP的请求　-->
        <multiHqlReportIndex>
            <indexKey>video.ua.current.activity.clickrate.dm</indexKey>
            <fieldName>mclickrate</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   sum(clickrate) mclickrate
				from (select t1.projectid,
							 if(t1.activitychannelid is null,'ALL',t1.activitychannelid) activitychannelid,
							 if(t1.activityid is null, 'none', t1.activityid) activityid,
							 t2.dtime,
							 if(t1.clickrate is null,0,t1.clickrate) clickrate
						from (select projectid,activitychannelid,activityid,t.dtime datatime,clickrate
								from video.t_video_useractivity_current_d_hbase t
							   where substr(t.dtime, 0, 6) >= substr('{STARTTIME}', 0, 6)
								 and substr(t.dtime, 0, 6) <= substr('{ENDTIME}', 0, 6)) t1,
							 (select t.dtime
								from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
								 and t.dtime < '{ENDTIME}') t2
					   where substr(t1.datatime, 0, 6) = substr(t2.dtime, 0, 6)
						 and t1.datatime <= t2.dtime
					) tt
				group by projectid, activitychannelid, activityid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
	
		<!--当期 点击量	cpaclickrate 通过渠道点击前转到TOP的请求数(一键订购所有点击)t.activitytype = 0-->
		<!--当期 点击量	cpcclickrate 通过渠道点击前转到TOP的请求数(所有的一键注册点击量)t.activitytype = 1-->
		<multiHqlReportIndex>
            <indexKey>video.ua.current.settlement.cpclickrate.dm</indexKey>
            <fieldName>mcpaclickrate,mcpcclickrate</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(cpaclick) mcpaclickrate,
					   count(cpcclick) mcpcclickrate
				  from (select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t2.dtime,
							   if(t1.activitytype = 0, t1.transactionid, null) cpaclick,
							   if(t1.activitytype = 1, t1.transactionid, null) cpcclick
						from (select projectid,activitychannelid,activityid,t.date datatime,transactionid,activitytype
								from video.t_cdr_top_useractivityinfo t
							   where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								 and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)) t1,
							 (select t.dtime
								from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
								 and t.dtime < '{ENDTIME}') t2
					   where substr(t1.datatime, 0, 6) = substr(t2.dtime, 0, 6)
						 and t1.datatime <= t2.dtime
						union all
						select t1.projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t2.dtime,
							   if(t1.activitytype = 0, t1.transactionid, null) cpaclick,
							   if(t1.activitytype = 1, t1.transactionid, null) cpcclick
						from (select projectid,activitychannelid,activityid,t.date datatime,transactionid,activitytype
								from video.t_cdr_top_useractivityinfo t
							   where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								 and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)) t1,
							 (select t.dtime
								from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
								 and t.dtime < '{ENDTIME}') t2
					   where substr(t1.datatime, 0, 6) = substr(t2.dtime, 0, 6)
						 and t1.datatime <= t2.dtime
					) tt
				 group by projectid, activitychannelid, activityid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		<!--  转换量 conversionquantity ：成功完成点击的次数，根据活动的不同，取值为：一键注册用户次数或者一键订购用户次　-->
		<!--
		//一键订购转化量 keyorderpromotion : 一键订购用户成功次数(活动运营,activityid is not null,渠道结算统计,cpa)
		//一键注册转化量 keyregisterpromotion : 一键注册用户成功次数(活动运营,activityid is not null,渠道结算统计,cpc)
		-->
        <multiHqlReportIndex>
            <indexKey>video.ua.current.conversionquantity.dm</indexKey>
			<macroList>
				<macro>
					<name>USERACTIVITY_MONTH</name>
					<value>
					<![CDATA[
					  select t1.projectid,t1.activitychannelid,t1.activityid,t1.productid,t2.dtime,t1.transactionid,t1.transactionstatus,t1.activitytype
						from (select projectid,activitychannelid,activityid,t.date datatime,transactionid,transactionstatus,activitytype
								from video.t_cdr_top_useractivityinfo t
							   where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
								 and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)
								 and t.taskstatus = '1') t1,
							 (select t.dtime
								from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
								 and t.dtime < '{ENDTIME}') t2
					   where substr(t1.datatime, 0, 6) = substr(t2.dtime, 0, 6)
						 and t1.datatime <= t2.dtime
					]]>
					</value>
				</macro>
			</macroList>
            <fieldName>mconversionquantity,mkeyorderpromotion,mkeyregisterpromotion</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,activityid,dtime,
					   count(distinct(transactionid)) mconversionquantity,
					   count(distinct(keyorderpromotion)) mkeyorderpromotion,
					   count(distinct(keyregisterpromotion)) mkeyregisterpromotion
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   if(activityid is null, 'none', activityid) activityid,
							   t.date dtime,
							   if(t.activitytype = 0, transactionid, null) keyorderpromotion,
							   if(t.activitytype = 1, transactionid, null) keyregisterpromotion,
							   transactionid
						  from ({USERACTIVITY_MONTH})t
						union all
						select projectid,
							   'ALL' activitychannelid,
							   if(activityid is null, 'none', activityid) activityid,
							   t.date dtime,
							   if(t.activitytype = 0, transactionid, null) keyorderpromotion,
							   if(t.activitytype = 1, transactionid, null) keyregisterpromotion,
							   transactionid
						  from ({USERACTIVITY_MONTH})t
						union all
						select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   if(t.activitytype = 0, transactionid, null) keyorderpromotion,
							   if(t.activitytype = 1, transactionid, null) keyregisterpromotion,
							   transactionid
						  from ({USERACTIVITY_MONTH})t
						 where t.transactionstatus = 1
						union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   t.date dtime,
							   if(t.activitytype = 0, transactionid, null) keyorderpromotion,
							   if(t.activitytype = 1, transactionid, null) keyregisterpromotion,
							   transactionid
						  from ({USERACTIVITY_MONTH})t
						 where t.transactionstatus = 1
					) tt
				 group by projectid, activitychannelid, activityid, dtime			
                ]]>
            </hql>
        </multiHqlReportIndex>

    </multiHqlReportIndexs>
</reportIndexGroup>
