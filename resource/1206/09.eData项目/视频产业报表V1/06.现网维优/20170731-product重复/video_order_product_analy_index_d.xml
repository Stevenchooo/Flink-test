<reportIndexGroup>
    <multiHqlReportIndexs>
		<!--  订购 某产品 的 总用户数 allorderuser  -->
		<!--  总订购次数 allordertimes  -->
		<!--  当期 相关产品的名称   productname  -->
		<!--  当期 相关产品类型   productCatalog  -->
		<!--  当期 相关产品 订购 类型   productordertype -->
		<!--
		订购类型和产品类型属性，
		通过【订购话单】中的产品ID和actionType进行处理，关联【合约信息话单】或者【商品信息话单】。
		Actiontype=3时，取【商品信息话单】，获取productCatalog展示产品类型；直接设置“按次”作为订购类型。
		Actiontype=1时，取【合约信息话单】获取productCatalog展示产品类型；取 cycleType 作为订购类型。
		产品名称属性，取【商品信息话单】和【合约信息话单】的productName字段。
		
		统计项计算逻辑：
		总订购次数：按项目ID，取当期最后一天的【订购话单】中actiontype=1/3的话单计数。
		新增订购次数：取时间段内的【订购话单】中actiontype=1/3的话单计数。
		取消订购次数：取时间段内的【订购话单】中actiontype=2的话单计数。
		-->
        <multiHqlReportIndex>
            <indexKey>video.edp.order.product.allorder.d</indexKey>
            <fieldName>productname,productcatalog,productordertype,allordertimes,allorderuser</fieldName>
            <hql>
                <![CDATA[
				 select projectid,activitychannelid,productid,dtime,
						productname,
						productcatalog,
						productordertype,						
						count(identityid) allordertimes,
						count(distinct(identityid)) allorderuser
				 from ( select t1.projectid,
							   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
							   if(t1.productid is null, 'none', t1.productid) productid,
							   t1.dtime,
							   if(t2.productname is null, t1.productid, t2.productname) productname,
							   t2.productcatalog,
							   if(t1.actiontype = 3, '按次', t2.cycletype) productordertype,
							   t1.identityid
						  from (select s1.projectid,s1.activitychannelid,s1.productid,s2.dtime,s1.identityid,s1.actiontype
								  from (select projectid,activitychannelid,productid,t.date dtime,identityid,actiontype
										  from video.t_cdr_top_order_info t
										 where t.actiontype in (1, 3)) s1,
									   (select t.dtime
										  from video.t_bdi_muchtv_video_rundate t
										 where t.dtime > '{STARTTIME}'
										   and t.dtime < '{ENDTIME}') s2
								 where s1.dtime <= s2.dtime) t1
						  left join (select aa.productid,aa.productcatalog,aa.producttype,aa.productname,
                                            aa.cycletype
									   from (select productid,productcatalog,producttype,productname,cycletype,
									               row_number() over(partition by productid order by operationtime desc) as rn
									           from video.t_cdr_top_product_info t) aa
									  where aa.rn = 1) t2
							on t1.productid = t2.productid
					union all
						 select t1.projectid projectid,
								'ALL' activitychannelid,
							   if(t1.productid is null, 'none', t1.productid) productid,
							   t1.dtime,
							   if(t2.productname is null, t1.productid, t2.productname) productname,
							   t2.productcatalog,
							   if(t1.actiontype = 3, '按次', t2.cycletype) productordertype,
							   t1.identityid
						  from (select s1.projectid,s1.activitychannelid,s1.productid,s2.dtime,s1.identityid,s1.actiontype
								  from (select projectid,activitychannelid,productid,t.date dtime,identityid,actiontype
										  from video.t_cdr_top_order_info t
										 where t.actiontype in (1, 3)) s1,
									   (select t.dtime
										  from video.t_bdi_muchtv_video_rundate t
										 where t.dtime > '{STARTTIME}'
										   and t.dtime < '{ENDTIME}') s2
								 where s1.dtime <= s2.dtime) t1
						  left join (select aa.productid,aa.productcatalog,aa.producttype,aa.productname,aa.cycletype
									   from (select productid,productcatalog,producttype,productname,cycletype,
									                row_number() over(partition by productid order by operationtime desc) as rn
									           from video.t_cdr_top_product_info t) aa
									  where aa.rn = 1) t2
							on t1.productid = t2.productid
					)tt
				 group by projectid,activitychannelid,productid,dtime,
						  productname,
						  productcatalog,
						  productordertype
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--  当期 某一产品 新增 订购用户数： neworderuser  -->
		<!--  当期 新增订购次数 newordertimes -->
		<!--  当期 某一产品 取消 订购用户数： loseorderuser  -->
		<!--  当期 取消订购次数 loseordertimes  -->
        <multiHqlReportIndex>
            <indexKey>video.edp.order.product.orderuser.d</indexKey>
            <fieldName>newordertimes,neworderuser,loseordertimes,loseorderuser</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,productid,dtime,
					   count(neworder) newordertimes,
					   count(distinct(neworder)) neworderuser,
					   count(loseorder) loseordertimes,
					   count(distinct(loseorder)) loseorderuser
				  from (select projectid,
							   if(activitychannelid is null, 'none', activitychannelid) activitychannelid,
							   productid,
							   t.date dtime,
							   if(t.actiontype = 1 OR t.actiontype = 3, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from video.t_cdr_top_order_info t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						union all
						select projectid,
							   'ALL' activitychannelid,
							   if(t.productid is null, 'none', t.productid) productid,
							   t.date dtime,
							   if(t.actiontype = 1 OR t.actiontype = 3, t.identityid, null) neworder,
							   if(t.actiontype = 2, t.identityid, null) loseorder
						  from video.t_cdr_top_order_info t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}') tt
				 group by projectid, activitychannelid, productid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--  
		//总 订购用户占比 = 单产品订购用户数/（产品）总订购用户数*100% orderuserproportion  
		//注意【单产品订购用户数】为某一产品订购的总用户
		//在 DM 上编写时加上 *100%
		//
		// 若产品1 订购用户为 A　Ｂ　产品２　订购用户为　Ａ　总共工有2个用户 产品1占比为100% 还是 2/3??
		// 退订情况不考虑[宋立岩(s00274384) 2016-12-23 17:31  不需要考虑退订]
		//201707 t_video_develop_user_active_d_hbase增加了platformid字段，注册用户数需要增加platformid=ALL条件
		-->
        <multiHqlReportIndex>
            <indexKey>video.edp.order.product.orderuserproportion.d</indexKey>
            <fieldName>orderuserproportion</fieldName>
            <hql>
                <![CDATA[
				select projectid,activitychannelid,productid,dtime,
					   (allorderuser / allproductorder) orderuserproportion
				  from (select tt1.projectid,
							   tt1.activitychannelid,
							   tt1.productid,
							   tt1.dtime,
							   tt1.allorderuser,
							   tt2.allproductorder
						  from (select projectid,
									   if(activitychannelid is null, 'ALL', activitychannelid) activitychannelid,
									   productid,
									   dtime,
									   allorderuser
								  from video.t_video_order_product_analy_d_hbase t1
								 where t1.dtime > '{STARTTIME}'
								   and t1.dtime < '{ENDTIME}'
							) tt1,(
								select projectid,dtime,allproductorder
								  from video.t_video_develop_user_active_d_hbase t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}'
								   and t.activitychannelid is null
								   and t.platformid is null
								) tt2
						 where tt1.projectid = tt2.projectid
						   and tt1.dtime = tt2.dtime
					) ttt
				 group by projectid,activitychannelid,productid,dtime,(allorderuser / allproductorder)
                ]]>
            </hql>
        </multiHqlReportIndex>
		
    </multiHqlReportIndexs>
</reportIndexGroup>
