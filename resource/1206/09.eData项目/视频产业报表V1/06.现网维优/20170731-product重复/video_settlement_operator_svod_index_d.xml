<reportIndexGroup>
	<multiHqlReportIndexs>

	<!--
	//[EDP]中SVOD(RS) 展示主键 {projectid[固定]、 productid[筛选]、 cycletype[筛选]}
	-->
		<!--当期 付费订购用户 总共 付费金额 income[美元]、 localincome[本币]-->
		<!--当期 付费订购用户数 paytimes 正式订购该套餐产品，并成功付费的次数(订阅付费次数 subpaytimes)-->
		
		<!--20170614修改：支付话单表 跟 产品话单表做left join操作时，产品话单表中同一个产品ID有多条记录导致 结算金额翻倍，增加distinct去重；
		sum(tt.fee) income 应该对应 本币localincome,
		sum(tt.fee_usd) localincome 应该对应 美元income
		-->
		<multiHqlReportIndex>
            <indexKey>video.operator.settlement.svod.columns.d</indexKey>
            <fieldName>productdesc,income,localincome,subpaytimes</fieldName>
           <!-- <hql>
                <![CDATA[
				select projectid,productid,cycletype,dtime,
					   productdesc,
					   sum(tt.fee) income,
					   sum(tt.fee_usd) localincome,
					   count(tt.identityid) subpaytimes
				  from (select t1.projectid,
							   if(t1.productid is null, 'none', t1.productid) productid,
							   t2.cycletype,
							   t1.dtime,
							   t2.productdesc,
							   if(t1.fee is null, 0, t1.fee) fee,
							   if(t1.fee_usd is null, 0, t1.fee_usd) fee_usd,
							   t1.identityid
						  from (select projectid,t.productnumber productid,t.date dtime,fee,fee_usd,identityid
								  from video.t_cdr_top_payment_info t
								 where t.date > '{STARTTIME}'
								   and t.date < '{ENDTIME}') t1
						  left join (select productid, producttype, cycletype, productdesc
									  from video.t_cdr_top_product_info t) t2
							on t1.productid = t2.productid
						 where t2.producttype = 2) tt
				 group by projectid, productid, cycletype, dtime, productdesc
                ]]>
            </hql> -->
			
			<hql>
                <![CDATA[
				select projectid,productid,cycletype,dtime,
					   productdesc,
					   sum(tt.fee) localincome,
					   sum(tt.fee_usd) income,
					   count(tt.identityid) subpaytimes
				  from (select t1.projectid,
							   if(t1.productid is null, 'none', t1.productid) productid,
							   t2.cycletype,
							   t1.dtime,
							   t2.productdesc,
							   if(t1.fee is null, 0, t1.fee) fee,
							   if(t1.fee_usd is null, 0, t1.fee_usd) fee_usd,
							   t1.identityid
						  from (select projectid,t.productnumber productid,t.date dtime,fee,fee_usd,identityid
								  from video.t_cdr_top_payment_info t
								 where t.date > '{STARTTIME}'
								   and t.date < '{ENDTIME}') t1
						  left join (select aa.productid,aa.producttype,aa.cycletype,aa.productdesc
									  from (select productid,producttype,cycletype,productdesc,
									               row_number() over(partition by productid order by operationtime desc) as rn
									          from video.t_cdr_top_product_info t) aa
									 where aa.rn = 1) t2
							on t1.productid = t2.productid
						 where t2.producttype = 2) tt
				 group by projectid, productid, cycletype, dtime, productdesc
                ]]>
            </hql>
        </multiHqlReportIndex>

		<!--SVOD分成收入 hwincome[美元]、 hwincomelocal[本币]-->
		<!--
		//@20170223@zwx386873
		//注意：由于华为分成比例在产品信息表中还未增加相应字段；
		//故设计缺省分成比例表 t_cdr_top_product_info_temp 中 包含 分成比例字段 dividedproportion
		-->
		<multiHqlReportIndex>
            <indexKey>video.operator.settlement.svod.income.d</indexKey>
            <fieldName>hwincome,hwincomelocal</fieldName>
            <hql>
                <![CDATA[
				select projectid,productid,cycletype,dtime,
					   (income * dividedproportion) hwincome,
					   (localincome * dividedproportion) hwincomelocal
				  from (select t1.projectid,
							   t1.productid,
							   t1.cycletype,
							   t1.dtime,
							   if(t1.income is null, 0, t1.income) income,
							   if(t1.localincome is null, 0, t1.localincome) localincome,
							   if(t2.dividedproportion is null, 0, t2.dividedproportion) dividedproportion
						  from (select *
								  from video.t_video_settlement_operator_svod_d_hbase t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t1
						  left join (select * from video.t_cdr_top_product_info_temp t) t2
							on t1.projectid = t2.projectid
						   and t1.productid = t2.productid) tt
				 group by projectid,productid,cycletype,dtime,
						  (income * dividedproportion),
						  (localincome * dividedproportion)
                ]]>
            </hql>
        </multiHqlReportIndex>
    </multiHqlReportIndexs>
</reportIndexGroup>
