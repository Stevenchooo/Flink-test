<reportSuite>
    <reports>
        <report tableName = "t_video_settlement_content_single_d" 
				keyFields = "projectid,providerid,productid,contentid,dtime" 
				period = "daily" timeFormat = "yyyyMMdd" timeField = "dtime">
            <fieldDefinition>
                <field name="projectid" regular="[0-9a-zA-Z./-]*"/>
				<field name="providerid" regular="[0-9a-zA-Z./-]*"/>
				<field name="productid" regular="[0-9a-zA-Z./-]*"/>
				<field name="contentid" regular="[0-9a-zA-Z./-]*"/>
                <field name="dtime"  regular="[0-9a-zA-Z./-]*"/>
            </fieldDefinition>
			<!--
			******************************************************************************************
			//物化视图
			//用户产品状态中间表
			//每天统计当天所有订购以及以前最后状态数据
			******************************************************************************************
			DROP TABLE T_MID_ORDERSTATUS;
			CREATE TABLE video.T_MID_ORDERSTATUS
			(
			projectid STRING COMMENT '项目ID', 
			activitychannelid STRING COMMENT '推广活动渠道ID',
			activityid STRING COMMENT '推广活动ID',
			clientid STRING COMMENT '接入门户标识',
			userid STRING COMMENT '用户标识',
			productid STRING COMMENT '产品ID',
			actiontype STRING COMMENT '操作类型',
			status STRING COMMENT '订购关系状态',
			dtime STRING,
			time STRING
			)
			PARTITIONED BY(
			id string,
			date string
			)
			ROW FORMAT delimited fields terminated by '\t' MAP KEYS TERMINATED BY '&' STORED AS TEXTFILE;
			grant select,delete,insert on T_MID_ORDERSTATUS to user mapred;

			grant select on table video.T_MID_ORDERSTATUS to user tianjunjie;
			******************************************************************************************
			修改结算逻辑，每天保存增量话单，不保存全量话单
			-->
			<materialViewers>
			<materialViewer tableName = "video.T_MID_ORDERSTATUS" clear="false" partition="id,date">
			<hql>
			<![CDATA[			
			
			select projectid,activitychannelid,activityid,clientid,userid,productid,
             actiontype,status,dtime,time,t2.projectid id,t2.dtime date
             from (select tt.projectid,tt.activitychannelid,tt.activityid,tt.clientid,tt.userid,
                          tt.productid,tt.actiontype,tt.status,t.dtime,tt.time,
                          row_number() over(partition by tt.projectid, tt.activitychannelid, tt.activityid, tt.clientid, tt.userid, tt.productid, tt.actiontype, t.dtime order by time desc) as rank
                     from (select dtime
                             from video.t_bdi_muchtv_video_rundate
                            where dtime > '{STARTTIME}'
                              and dtime < '{ENDTIME}') t, 
                          (select t.projectid,t.activitychannelid,t.activityid, t.clientid,
                                  t.identityid userid,t.productid,t.actiontype,t.status,
                                  t.date dtime,t.time
                            from video.t_cdr_top_order_info t
                           where t.date >'{STARTTIME}'
                             and t.date <'{ENDTIME}'
                          union all 
                          select t1.projectid,t1.activitychannelid,t1.activityid,
                                 t1.clientid,t1.userid,t1.productid,t1.actiontype,t1.status,
                                 t1.dtime,time
						    from video.T_MID_ORDERSTATUS t1
                           where t1.dtime ='{STARTTIME}') tt
                     where tt.dtime <=t.dtime) t2
            where t2.rank = 1				
			]]>
			</hql>
			</materialViewer>
			</materialViewers>
            <dimensions>
                <dimension id = "0" >
                    <reportIndex>
						video.content.settlement.single.totalplaytime.d,
						video.content.settlement.single.playtime.d,
                        video.content.settlement.single.payuserincome.d
                    </reportIndex>
                </dimension>
                <dimension id = "0" >
                    <reportIndex>
						video.content.settlement.single.property.d
                    </reportIndex>
                </dimension>
            </dimensions>
        </report>
    </reports>
</reportSuite>
<!--
//[RS模式]{Revenue sharing模式通常被称为“按业务收入分成”，简称RS}
//[PAYU模式]{Pay As You Use模式通常被称为 “按使用量收费”，简称PAYU，
//即运营商按一定时间周期（月度/季度），按照网络业务总量支付部分或全部的项目金额。
//
//TVOD 和 SVOD 区别在于产品信息表中的
//producttype 产品类型 1，商品 2，合约
-->