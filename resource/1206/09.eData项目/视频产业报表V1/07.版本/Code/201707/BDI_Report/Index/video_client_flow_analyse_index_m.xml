<reportIndexGroup>
    <multiHqlReportIndexs>
<!--
//每日各种模式(网络和终端)
//networktype 网络类型 取值为：2G,3G,4G,wifi
//platformid 平台ID 取值为：1:安卓;2:IOS;3:其他
//
//根据 网络类型筛选 （ platformid ='ALL'）;根据 终端类型 （networktype ='ALL'）
-->		
		<!--点播流量 vodflow [点播用户 vodwatchusers]-->
		<!--直播流量 livetvflow [直播用户 livetvwatchusers]-->
		<!--总播放流量 totalflow-->
		<!-- 平均每用户消耗点播流量 avgvodflow = vodflow 点播流量 / 点播用户数-->
		<!-- 平均每用户消耗直播流量 avglivetvflow = livetvflow 点播流量 / 点播用户数-->
		<!-- 201707 修改video.client.flow.analyse.allflow.m为video.client.flow.analyse.columns.m，和report一致-->
        <multiHqlReportIndex>
            <indexKey>video.client.flow.analyse.columns.m</indexKey>
            <fieldName>totalflow,vodflow,livetvflow,avgvodflow,avglivetvflow</fieldName>
            <hql>
                <![CDATA[
				select projectid,networktype,platformid,mtime,
					   sum(totalflow) totalflow,
					   sum(vodflow) vodflow,
					   sum(livetvflow) livetvflow,
					   (sum(avgvodflow)/count(avgvodflow)) avgvodflow,
					   (sum(avglivetvflow)/count(avglivetvflow)) avglivetvflow
				  from (select projectid,
							   if(t.networktype is null, 'ALL', t.networktype) networktype,
							   if(t.platformid is null, 'ALL', t.platformid) platformid,
							   substr(t.dtime,0,6) mtime,
							   totalflow,
							   vodflow,
							   livetvflow,
							   avgvodflow,
							   avglivetvflow
						  from video.t_video_client_flow_analyse_dm_hbase t
						 where substr(t.dtime, 0, 6) > '{STARTTIME}'
						   and substr(t.dtime, 0, 6) < '{ENDTIME}'
						   and substr(t.dtime, 0, 6) <
							   from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t.dtime,
								'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMM')
					) tt
				 group by projectid,networktype,platformid,mtime
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--活跃用户DOU	douflow = 总播放流量 totalflow/活跃用户数 -->
		<!-- 201707 活跃用户数从t_video_develop_user_active_m_hbase修改从中间表t_mid_video_sdk_current_dm取platformid=all的数据 -->
		<multiHqlReportIndex>
            <indexKey>video.client.flow.analyse.douflow.m</indexKey>
            <fieldName>douflow</fieldName>
            <hql>
                <![CDATA[
				select projectid, networktype, platformid, mtime, (totalflow / activeusers) douflow
				  from (select t1.projectid,t1.networktype,t1.platformid,t1.mtime,t1.totalflow,
							   t2.activeusers
						  from (select projectid, networktype, platformid, mtime, totalflow
								  from video.t_video_client_flow_analyse_m_hbase t
								 where t.mtime > '{STARTTIME}'
								   and t.mtime < '{ENDTIME}') t1
						  left join (select projectid,substr(dtime,0,6) mtime,sum(activeusers) activeusers
									  from video.t_mid_video_sdk_current_dm t
									 where substr(t.dtime, 0, 6) > '{STARTTIME}'
									   and substr(t.dtime, 0, 6) < '{ENDTIME}'
									   and substr(t.dtime, 0, 6) <
						 				   from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t.dtime,
										   'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMM')
									   and t.activitychannelid = 'ALL'
									   and t.platformid = 'ALL'
									   and t.activityid = 'ALL'
									 group by projectid,substr(dtime,0,6)
									   ) t2
							on t1.projectid = t2.projectid
						   and t1.mtime = t2.mtime
					) tt
				 group by projectid, networktype, platformid, mtime, (totalflow / activeusers)
                ]]>
            </hql>
        </multiHqlReportIndex>
		
    </multiHqlReportIndexs>
</reportIndexGroup>
