<reportSuite>
    <reports>
        <report tableName = "t_video_sdk_current_dw"
				keyFields = "projectid,activitychannelid,activityid,platformid,dtime" 
				period = "daily" timeFormat = "yyyyMMdd" timeField = "dtime">
            <fieldDefinition>
                <field name="projectid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activitychannelid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activityid" regular="[0-9a-zA-Z./-]*"/>
				<field name="platformid" regular="[0-9a-zA-Z./-]*"/>
                <field name="dtime"  regular="[0-9a-zA-Z./-]*"/>
            </fieldDefinition>
			<!--
			  活跃用户数，当周结算
			-->
			<materialViewers>		
				<materialViewer tableName = "video.t_mid_video_sdk_activeusers_dw" clear="false" partition="date">
					<hql>
					<![CDATA[		    
		    select projectid,
			       if(platformid is null,'ALL',platformid) platformid,
				   if(activitychannelid is null,'ALL',activitychannelid) activitychannelid,
				   if(activityid is null,'ALL',activityid) activityid,
				   dtime,
				   count(distinct(userid)) activeusers,dtime date
			  from (select t1.projectid,
						   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
						   if(t1.activityid is null, 'none', t1.activityid) activityid,
						   if(t1.platformid is null, 'none', t1.platformid) platformid,
						   t2.dtime,
						   t1.userid
					  from (select t.c1 projectid,t.activitychannelid,t.activityid,t.platformid,t.date dtime,userid
							  from video.t_cdr_sdk_event_join_video_user t
							 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
											'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
							   and t.date < '{ENDTIME}') t1,
						   (select t.dtime, t.weekdays
							  from video.t_bdi_muchtv_video_rundate t
							 where t.dtime > '{STARTTIME}'
							   and t.dtime < '{ENDTIME}') t2
					 where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
									'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
					   and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
									'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')
				) tt
			 group by projectid,activitychannelid,activityid,platformid,dtime
			 grouping sets
				       (
					     (projectid,activitychannelid,activityid,platformid,dtime),
						 (projectid,activityid,platformid,dtime),
						 (projectid,activitychannelid,platformid,dtime),
						 (projectid,activitychannelid,activityid,dtime),
						 (projectid,activitychannelid,dtime),
						 (projectid,activityid,dtime),
						 (projectid,platformid,dtime),
						 (projectid,dtime)
					   )
					]]>
					</hql>
				</materialViewer>
			</materialViewers>
        </report>
    </reports>
</reportSuite>
