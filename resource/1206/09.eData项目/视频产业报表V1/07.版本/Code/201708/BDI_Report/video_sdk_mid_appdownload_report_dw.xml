<reportSuite>
    <reports>
        <report tableName = "t_video_sdk_current_d"
				keyFields = "projectid,activitychannelid,activityid,platformid,dtime" 
				period = "daily" timeFormat = "yyyyMMdd" timeField = "dtime">
            <fieldDefinition>
                <field name="projectid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activitychannelid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activityid" regular="[0-9a-zA-Z./-]*"/>
				<field name="platformid" regular="[0-9a-zA-Z./-]*"/>
                <field name="dtime"  regular="[0-9a-zA-Z./-]*"/>
            </fieldDefinition>
			<!--
			  appdownload结算，事件为down_app，使用标签来分辨是安卓还是ios，因为只有web会上报此时间，所以标签和platformid（99）是不对应的，需要将标签转化一下
			-->
			<materialViewers>
				<materialViewer tableName = "video.t_mid_video_sdk_appdownload_dw" clear="false" partition="date">
					<hql>
					<![CDATA[
			    select projectid,
				       platformid,
					   activitychannelid,
					   activityid,
					   dtime,
					   count(distinct(userid)) appdownload,
					   dtime date
				  from (select projectid,platformid,activitychannelid,activityid,t2.dtime,userid
				          from(select t.c1 projectid,
							          if(lower(eventlabel) = 'android', '1', '2') platformid,
							          'ALL' activitychannelid,
							          if(t.activityid is null, 'none', t.activityid) activityid,
							          t.date dtime,
							          t.userid
								from video.t_cdr_sdk_event_join_video_user t
							   where t.eventname = 'down_app'
						         and t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
										      'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
						         and t.date < '{ENDTIME}') t1,
					          (select t.dtime, t.weekdays
							     from video.t_bdi_muchtv_video_rundate t
							    where t.dtime > '{STARTTIME}'
							      and t.dtime < '{ENDTIME}') t2
                        where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
									     'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
					      and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
									     'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')							   
						union all
						select projectid,platformid,activitychannelid,activityid,t2.dtime,userid
				         from(select t.c1 projectid,
							         'ALL' platformid,
							         'ALL' activitychannelid,
									 if(t.activityid is null, 'none', t.activityid) activityid,
									 t.date dtime,
									 t.userid 
								from video.t_cdr_sdk_event_join_video_user t
							   where t.eventname = 'down_app'
								 and t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
										      'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								 and t.date < '{ENDTIME}'	) t1,
                        	 (select t.dtime, t.weekdays
							    from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
							     and t.dtime < '{ENDTIME}') t2
                        where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
									     'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
					      and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
									     'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')							   
						union all
						select projectid,platformid,activitychannelid,activityid,t2.dtime,userid
				         from(select t.c1 projectid,
									 'ALL' platformid,
									 'ALL' activitychannelid,
									 'ALL' activityid,
									 t.date dtime,
									 t.userid 
						        from video.t_cdr_sdk_event_join_video_user t
							   where t.eventname = 'down_app'
						         and t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
											  'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								 and t.date < '{ENDTIME}') t1,
						    (select t.dtime, t.weekdays
							   from video.t_bdi_muchtv_video_rundate t
							  where t.dtime > '{STARTTIME}'
							    and t.dtime < '{ENDTIME}') t2
                        where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
									     'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
					      and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
									     'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')	
						union all
						select projectid,platformid,activitychannelid,activityid,t2.dtime,userid
				         from(
								select t.c1 projectid,
										if(lower(eventlabel) = 'android', '1', '2') platformid,
										'ALL' activitychannelid,
										'ALL' activityid,
										t.date dtime,
										t.userid 
								  from video.t_cdr_sdk_event_join_video_user t
								 where t.eventname = 'down_app'
								   and t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),7),'yyyy-MM-dd'),'yyyyMMdd')
								   and t.date < '{ENDTIME}') t1,
						     (select t.dtime, t.weekdays
							    from video.t_bdi_muchtv_video_rundate t
							   where t.dtime > '{STARTTIME}'
							     and t.dtime < '{ENDTIME}') t2
                        where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
									     'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'),'yyyyMMdd')
					      and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
									     'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'),'yyyyMMdd')	
						 ) tt
				 group by dtime, projectid, platformid, activitychannelid, activityid
					]]>
					</hql>
				</materialViewer>
			</materialViewers>
        </report>
    </reports>
</reportSuite>
