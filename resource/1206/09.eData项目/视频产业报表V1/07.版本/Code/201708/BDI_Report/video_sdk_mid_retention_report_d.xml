<reportSuite>
    <reports>
        <report tableName = "t_video_sdk_current_d"
				keyFields = "projectid,activitychannelid,platformid,dtime" 
				period = "daily" timeFormat = "yyyyMMdd" timeField = "dtime">
            <fieldDefinition>
                <field name="projectid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activitychannelid" regular="[0-9a-zA-Z./-]*"/>
				<field name="platformid" regular="[0-9a-zA-Z./-]*"/>
                <field name="dtime"  regular="[0-9a-zA-Z./-]*"/>
            </fieldDefinition>
			<materialViewers>
				<materialViewer tableName = "video.t_mid_video_sdk_retentionrate_d" clear="false" partition="date">
					<hql>
					<![CDATA[
				      select projectid,platformid,activitychannelid,activityid,dtime,
					         newsubscriber,
							 if(newsubscriber=0,0,(day01againloginregister)/newsubscriber) day01retentionrate,
							 if(newsubscriber=0,0,(day03againloginregister)/newsubscriber) day03retentionrate,
							 if(newsubscriber=0,0,(day07againloginregister)/newsubscriber) day07retentionrate,
							 if(newsubscriber=0,0,(day15againloginregister)/newsubscriber) day15retentionrate,
							 if(newsubscriber=0,0,(day30againloginregister)/newsubscriber) day30retentionrate,
							 dtime date
					    from (
						 select distinct projectid,activitychannelid,activityid,platformid,dtime,newsubscriber,day01againloginregister,day03againloginregister,
						        day07againloginregister,day15againloginregister,day30againloginregister
							from (
							 select projectid,activitychannelid,activityid,platformid,dtime,
									sum(newsubscriber) over(partition by projectid,activitychannelid,activityid,dtime) newsubscriber,
									sum(day01againloginregister) over(partition by projectid,activitychannelid,activityid,platformid,dtime) day01againloginregister,
									sum(day03againloginregister) over(partition by projectid,activitychannelid,activityid,platformid,dtime) day03againloginregister,
									sum(day07againloginregister) over(partition by projectid,activitychannelid,activityid,platformid,dtime) day07againloginregister,
									sum(day15againloginregister) over(partition by projectid,activitychannelid,activityid,platformid,dtime) day15againloginregister,
									sum(day30againloginregister) over(partition by projectid,activitychannelid,activityid,platformid,dtime) day30againloginregister
							   from (
								select projectid,activitychannelid,activityid,platformid,dtime,
									   if(newsubscriber is null,0,newsubscriber) newsubscriber ,0 newvisitor,
									   0 day01againloginregister,0 day03againloginregister,0 day07againloginregister,0 day15againloginregister,0 day30againloginregister
								  from video.t_mid_newsubscriber_tmp
								 where date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),30),'yyyy-MM-dd'), 'yyyyMMdd')
								   and date < '{ENDTIME}'
								   and platformid='ALL'
								   
								 union all
								select projectid,activitychannelid,activityid,platformid,dtime,
									   0 novisitorconvert,0 newvisitor,
									   if(day01againloginregister is null,0,day01againloginregister) day01againloginregister,0 day03againloginregister,0 day07againloginregister,0 day15againloginregister,0 day30againloginregister
								  from video.t_mid_day01againloginregister_tmp
								 where date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),30),'yyyy-MM-dd'), 'yyyyMMdd')
								   and date < '{ENDTIME}'
								 union all
								select projectid,activitychannelid,activityid,platformid,dtime,
									   0 novisitorconvert,0 newvisitor,
									   0 day01againloginregister,if(day03againloginregister is null,0,day03againloginregister) day03againloginregister,0 day07againloginregister,0 day15againloginregister,0 day30againloginregister
								  from video.t_mid_day03againloginregister_tmp
								 where date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),30),'yyyy-MM-dd'), 'yyyyMMdd')
								   and date < '{ENDTIME}'
								 union all
								select projectid,activitychannelid,activityid,platformid,dtime,
									   0 novisitorconvert,0 newvisitor,
									   0 day01againloginregister,0 day03againloginregister,if(day07againloginregister is null,0,day07againloginregister) day07againloginregister,0 day15againloginregister,0 day30againloginregister
								  from video.t_mid_day07againloginregister_tmp
								 where date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),30),'yyyy-MM-dd'), 'yyyyMMdd')
								   and date < '{ENDTIME}'
								 union all
								select projectid,activitychannelid,activityid,platformid,dtime,
									   0 novisitorconvert,0 newvisitor,
									   0 day01againloginregister,0 day03againloginregister,0 day07againloginregister,if(day15againloginregister is null,0,day15againloginregister) day15againloginregister,0 day30againloginregister
								  from video.t_mid_day15againloginregister_tmp
								 where date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),30),'yyyy-MM-dd'), 'yyyyMMdd')
								   and date < '{ENDTIME}'
								 union all
								select projectid,activitychannelid,activityid,platformid,dtime,
									   0 novisitorconvert,0 newvisitor,
									   0 day01againloginregister,0 day03againloginregister,0 day07againloginregister,0 day15againloginregister,if(day30againloginregister is null,0,day30againloginregister) day30againloginregister
								  from video.t_mid_day30againloginregister_tmp
								 where date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												'yyyyMMdd'),'yyyy-MM-dd'),30),'yyyy-MM-dd'), 'yyyyMMdd')
								   and date < '{ENDTIME}'
								  )t
								   )tt
                                    )ttt								   
					]]>
					</hql>
				</materialViewer>
			</materialViewers>
        </report>
    </reports>
</reportSuite>
