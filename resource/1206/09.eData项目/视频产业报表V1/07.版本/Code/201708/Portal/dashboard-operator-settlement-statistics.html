<link rel="stylesheet" type="text/css" href="resources/default/css/eData/dashboard-user-situation.css"/>
<script type="text/javascript" src="js/base_common.js"></script>
<script type="text/javascript" src="data/channel-data_video.js"></script>
<script type="text/javascript" src="js/toExcel/getTblDataFF.js"></script>
<script type="text/javascript" src="js/toExcel/table2excel.js"></script>


<style>
.currency{
    text-decoration: underline;
}
	
.date-filter-wrap-settlement-statistics{
    float: left;
    margin-right: 30px;
    margin-top: 30px;
	margin-bottom: 30px;
    display: inline-block;
    border: 1px solid #CFC7C7;
    <!-- border-radius: 14px; -->
    background: #FAFAFA;
    font-size: 12px;
    text-align: center;
    overflow: hidden;
    line-height: 40px;
    vertical-align: middle;
}
.date-filter-wrap-settlement-statistics .btn-date {
    display: inline-block;
    min-width: 120px;
    border-right: 0px solid #CFC7C7;
    padding: 3px 0px;
    cursor: pointer;
}

.date-filter-wrap-settlement-statistics .selected {
    background: #00B0FF;
}

h3 {
    font-size: 20px;
    color: #00B0FF;
    margin-left: 0px;
}


#help_text{
    position: absolute;
    z-index: 20;
    background: #E6E3E3;
    width: 10%;
    height: 30px;
    padding-bottom: 45px;
    border: 1px solid #BCB0B0;
	top:-12%;
	left:28%;
    text-align: left;
}

</style>
<!-- 导出模板页面 -->
<iframe src="exportModel.html" name="exportShow"  style="width:0;height:0"></iframe>


<div class="content-body-wrap content-no-header">
    <div class="content-title">
        <div class="date-wrap float-left" id="nextDate"></div>
		<div class="currencycolor" style="float:left" id="currency-choose">
			<span id="currency-type" style="float:left">Currency type:</span>
			<span class="currency" id="currency-type-usd" style="float:left;color:#00b0ff">USD</span>
			<span class="currency" id="currency-type-local" style="display:none;float:left;color:#00b0ff">LOCAL</span>
        </div>
		
		
		<div class="droplist-multi-wrap channel-droplist" id="multi_droplist" style="display:none">
            <div class="droplist-multi">
                <span class="ellipsis" id="choosecycletype">Cycletype</span>
                <i class="droplist-multi-trigger"></i>
            </div>
            <div class="multi-obj-wrap">              
                 <ul class="obj-list"> </ul>
                 <div class="btn-wrap">
                     <span class="btn btn-ok" id=btnOK>OK</span>
                 </div>
             </div>
        </div> 
    </div>
<!-- 列表 -->

	<div class="date-filter-wrap-settlement-statistics" id="trend-menu-type">
		<span id="date-table-tvod" class="btn-date selected">tvod</span>
		<span id="date-table-svod" class="btn-date">svod</span>
    </div>
	
    <div class="data-trend-header clearfix">
            <div class="date-filter-wrap" id="recent-filter">
                <span class="btn-date selected">Yesterday</span>
				<span class="btn-date">month</span>
            </div>

            <div class="date-filter-wrap">
            <span class="btn btnH24-opacity1" onclick="doExport()" id="export">Export</span>
            </div>
            <div class="droplist-wrap" id="versionDroplist">
            </div>
            <h3 id="trend">Details</h3><p id="dtime" class="timepos" style="color: #00B0FF;"></p>
    </div>

    <!-- <div class="cut-line" style="margin-top:8px;"></div> -->
	
	
	
    <div class="content-body-wrap" id="tvod-settlement" style="padding: 0px 0px 0;margin-top:15px">
        <table id="tvod-operator-settlement-statistics-table" class="table-dashboard" >
        <colgroup>
			<col width="20%"/>
			<col width="20%"/>
			<col width="20%"/>
			<col width="20%"/>
			<col width="20%"/>
        </colgroup>
        <thead>
           <tr>
             <th>productid</th>
             <th>productdesc</th>
             <th>clickpaytimes</th>
             <th>income</th>
             <th>hwincome</th>
           </tr>
        </thead>
        <tbody>
        </tbody>
        </table>
		<!-- <div class="page clearfix"> -->
          <!-- <div class="page-total" id="totalpage"> -->
            <!-- <div class="inline-block" > -->
                <!-- Total:<span id="totalrn">--</span> -->
            <!-- </div> -->
          <!-- </div> -->
          <!-- <div class="float-right" id="pageSplit"></div> -->
       <!-- </div>  -->
    </div>
        
	<div class="content-body-wrap" id="svod-settlement" style='padding: 0px 0px 0;margin-top:15px;display:none'>
        <table id="svod-operator-settlement-statistics-table" class="table-dashboard" >
        <colgroup>
			<col width="16%"/>
			<col width="16%"/>
			<col width="16%"/>
			<col width="16%"/>
			<col width="16%"/>
			<col width="20%"/>
        </colgroup>
        <thead>
           <tr>
             <th>productid</th>
			 <th id="th_logo_help">cycletype</th>
             <th>productdesc</th>
             <th>clickpaytimes</th>
             <th>income</th>
             <th>hwincome</th>
           </tr>
        </thead>
        <tbody>
        </tbody>
        </table>
		<!-- <div class="page clearfix"> -->
          <!-- <div class="page-total" id="totalpagesvod"> -->
            <!-- <div class="inline-block" > -->
                <!-- Total:<span id="total">--</span> -->
            <!-- </div> -->
          <!-- </div> -->
          <!-- <div class="float-right" id="pageSplitsvod"></div> -->
       <!-- </div>  -->
    </div>
     <div class="page clearfix">
          <div class="page-total" id="totalpage">
            <div class="inline-block" >
                Total:<span id="totalrn">--</span>
            </div>
          </div>
          <div class="float-right" id="pageSplit"></div>
       </div> 
    

</div>        
<script>

function doExportTVOD(){
    //_edata.push(['setEvent','edp_channel_analysis','export']);
    getXlsFromTbl('tvod-operator-settlement-statistics-table','tvod-operator-settlement-statistics-table.xls','');
}

function doExportSVOD(){
    //_edata.push(['setEvent','edp_channel_analysis','export']);
    getXlsFromTbl('svod-operator-settlement-statistics-table','svod-operator-settlement-statistics-table.xls','');
}


function doExport(){
    if($("#date-table-tvod").hasClass("selected")==true){
            doExportTVOD();
        }else{
            doExportSVOD();
        }	
}


initChannel();
function initChannel(){  

	$("#currency-type").html($.i18n.prop("video.currency.type.conversion"));
	
    $("#currency-type-usd").html($.i18n.prop("video.currency.usd"));
	
    $("#currency-type-local").html($.i18n.prop("video.currency.local"));

	$("#date-table-tvod").html($.i18n.prop("video.operator.settlement.statistics.tvod"));
	
    $("#date-table-svod").html($.i18n.prop("video.operator.settlement.statistics.svod"));

	$("#choosecycletype").html($.i18n.prop("video.operator.settlement.statistics.cycletype"));
	
    $("#btnOK").html($.i18n.prop("video.usertrend.retention.btnok"));

    $("#tvod-operator-settlement-statistics-table thead th").each(function(index){
        $(this).html($.i18n.prop("video.tvod.operator.settlement.statistics.title_"+(parseInt(index))));
    });   

	$("#svod-operator-settlement-statistics-table thead th").each(function(index){
        $(this).html($.i18n.prop("video.svod.operator.settlement.statistics.title_"+(parseInt(index))));
    }); 
 
    $("#export").html($.i18n.prop("video.usertrend.retention.export"));

    $("#trend").html($.i18n.prop("video.tvod.settlement.statistics"));

    $("#totalpage .inline-block").html($.i18n.prop("video.usertrend.retention.total"));
 
    $("#recent-filter .btn-date").each(function(index){
        $(this).html($.i18n.prop("video.settlement.statistics.days_"+(parseInt(index))));
    }); 

          
};

   
//鼠标在问号上时显示提醒
  $("#logo-help").mouseover(function(){
        if ('en' == getLanguage()){
				$("#th_logo_help").append("<div id='help_text'> 0：Pay By The Day<br/>1：Pay By The Month<br/>2：Pay By The Week  </div>");
			}else{
			    $("#th_logo_help").append("<div id='help_text'> 0：按天计费<br/>1：按月计费<br/>2：按周计费  </div>");
			}    
       

  });

 $("#logo-help").mouseout(function(){
        $("#help_text").remove();
  });  


//TVOD结算
function getListDataTVODSettlementStatistics(endtime,recentPeriod,tableid){
	//alert(billCurrencyType);
    if(tableid == 'undefined'){
        return;    
    } 

	if(recentPeriod=="0"){

		endtime=getBeforeGivenDateVideo(1,endtime);
		endtime=endtime.replace(/-/g,"");
		$("#dtime").text("("+endtime+"~"+endtime+")");

	}else if(recentPeriod=="1"){

		var monthtime=endtime;
		endtime=endtime.replace(/-/g,"");
		a=endtime.substr(0,6);
		systime=systime.replace(/-/g,"");
		b=systime.substr(0,6);		
		var m=endtime.substr(6,2);
		if(a==b){
			starttime=a+"01";
			endtime=getBeforeGivenDateVideo(1,monthtime);
			endtime=endtime.replace(/-/g,"");
			if(m=="01"){
				starttime=endtime.substr(0,6)+"01";
			}
		}else{
			starttime=a+"01";
			c=parseInt(endtime.substr(4,2));				
			endtime=a+getSelectMonthTime(c);				
		}	
		$("#dtime").text("("+starttime+"~"+endtime+")");
	}
	
	

    var hql="tvod_operator_settlement_statistics_list_d";
	if("USD"==billCurrencyType){
		if("0" == recentPeriod){
			hql="tvod_operator_settlement_statistics_list_d";
		}else if("1" == recentPeriod){
			hql="tvod_operator_settlement_statistics_list_m";
		}else{
			hql="tvod_operator_settlement_statistics_list_d";
		}
	}else{
		if("0" == recentPeriod){
			hql="tvod_operator_settlement_statistics_list_d_local";
		}else if("1" == recentPeriod){
			hql="tvod_operator_settlement_statistics_list_m_local";
		}else{
			hql="tvod_operator_settlement_statistics_list_d_local";
		}
	}
	

       Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','PRODUCTID':'"+productid+"','ENDTIME':'"+endtime+"'}",
         
         function(qResult){
			//alert(qResult);
             if(qResult==null)
             {
                 return;
             }
             var obj = JSON.parse(qResult);
             
             var TIME = obj.DTIME;
                                      
             var trendTime = new Array();
			 
             if (TIME instanceof Array)
             {
                 trendTime = TIME;
             }
             //一条数据的 后台未以数组返回
             else
             {
                 trendTime[0] = TIME;
             }
            

             listDetailData = new Array(); 
      
             for (i = 0;i < trendTime.length;i++)
             { 
                  
                 listDetailData[i] = new Array();

                 for( j = 0 ;j < 5; j++)
                 { 
                    listDetailData[i][j] = obj[tvodOperatorSettlementStatisticsTable[j]][i];
                  }
             }
             var needRow = 0;
             needRow = listDetailData.length;

             if(needRow == "0")
             {
                 needRow= "1";
             }
             if (listDetailData.length > 0)
             {
                 addTableRows('tvod-operator-settlement-statistics-table',needRow,listDetailData[0].length);        
             }
             else
             {
                 addTableRows('tvod-operator-settlement-statistics-table',12,5);     
             }
             insertTableDetailOperatorSettlementStatistics('tvod-operator-settlement-statistics-table',listDetailData);
			 //alert("tvod---"+trendTime.length);
             $("#totalrn").html(trendTime.length);
             addPageDiv('pageSplit',needRow,12);
             listSplit('tvod-operator-settlement-statistics-table',12);
         });
};




//SVOD结算
function getListDataSVODSettlementStatistics(endtime,recentPeriod,tableid){

	//alert(billCurrencyType);
	
    if(tableid == 'undefined'){
        return;    
    } 

	if(recentPeriod=="0"){

		endtime=getBeforeGivenDateVideo(1,endtime);
		endtime=endtime.replace(/-/g,"");
		$("#dtime").text("("+endtime+"~"+endtime+")");

	}else if(recentPeriod=="1"){

		var monthtime=endtime;
		endtime=endtime.replace(/-/g,"");
		a=endtime.substr(0,6);
		systime=systime.replace(/-/g,"");
		b=systime.substr(0,6);		
		var m=endtime.substr(6,2);
		if(a==b){
			starttime=a+"01";
			endtime=getBeforeGivenDateVideo(1,monthtime);
			endtime=endtime.replace(/-/g,"");
			if(m=="01"){
				starttime=endtime.substr(0,6)+"01";
			}
		}else{
			starttime=a+"01";
			c=parseInt(endtime.substr(4,2));				
			endtime=a+getSelectMonthTime(c);				
		}	
		$("#dtime").text("("+starttime+"~"+endtime+")");
	}
	
	
	if(cycletype=="ALL"){

		var hql="svod_operator_settlement_statistics_list_d_all";
		
		if("USD"==billCurrencyType){
			if("0" == recentPeriod){
				hql="svod_operator_settlement_statistics_list_d_all";
			}else if("1" == recentPeriod){
				hql="svod_operator_settlement_statistics_list_m_all";
			}else{
				hql="svod_operator_settlement_statistics_list_d_all";
			}
		}else{
			if("0" == recentPeriod){
				hql="svod_operator_settlement_statistics_list_d_all_local";
			}else if("1" == recentPeriod){
				hql="svod_operator_settlement_statistics_list_m_all_local";
			}else{
				hql="svod_operator_settlement_statistics_list_d_all_local";
			}
		}				
	}else{
		var hql="svod_operator_settlement_statistics_list_d_not_all";
		if("USD"==billCurrencyType){
		
			if("0" == recentPeriod){
				hql="svod_operator_settlement_statistics_list_d_not_all";
			}else if("1" == recentPeriod){
				hql="svod_operator_settlement_statistics_list_m_not_all";
			}else{
				hql="svod_operator_settlement_statistics_list_d_not_all";
			}
		}else{
			if("0" == recentPeriod){
				hql="svod_operator_settlement_statistics_list_d_not_all_local";
			}else if("1" == recentPeriod){
				hql="svod_operator_settlement_statistics_list_m_not_all_local";
			}else{
				hql="svod_operator_settlement_statistics_list_d_not_all_local";
			}
		}
	}
    
       Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','PRODUCTID':'"+productid+"','CYCLETYPE':'"+cycletype+"','ENDTIME':'"+endtime+"'}",
         
         function(qResult){
				//alert(qResult);
             if(qResult==null)
             {
                 return;
             }
             var obj = JSON.parse(qResult);
             
             var TIME = obj.DTIME;
                                      
             var trendTime = new Array();
			 
             if (TIME instanceof Array)
             {
                 trendTime = TIME;
             }
             //一条数据的 后台未以数组返回
             else
             {
                 trendTime[0] = TIME;
             }
            

             listDetailData = new Array(); 
      
             for (i = 0;i < trendTime.length;i++)
             { 
                  
                 listDetailData[i] = new Array();

                 for( j = 0 ;j < 6; j++)
                 { 
                    listDetailData[i][j] = obj[svodOperatorSettlementStatisticsTable[j]][i];
                  }
             }
             var needRow = 0;
             needRow = listDetailData.length;

             if(needRow == "0")
             {
                 needRow= "1";
             }
             if (listDetailData.length > 0)
             {
                 addTableRows('svod-operator-settlement-statistics-table',needRow,listDetailData[0].length);        
             }
             else
             {
                 addTableRows('svod-operator-settlement-statistics-table',12,6);     
             }
             insertTableDetailOperatorSettlementStatistics('svod-operator-settlement-statistics-table',listDetailData);
			 //alert("svod---"+trendTime.length);
             $("#totalrn").html(trendTime.length);
             addPageDiv('pageSplit',needRow,12);
             listSplit('tvod-operator-settlement-statistics-table',12);
         });
};


//初始化日期
var nextDate = new UCD.Date(null, "YYYY-MM-dd");
nextDate.init();
nextDate.setMode(1);
nextDate.setAnchor($('#nextDate'));
var projectid=getProjectidFromCookie();
var productid = "ALL";
var cycletype = "ALL";
var recentPeriod = "0";

var newnextDate = new UCD.Date(null, "YYYY-MM-dd");
newnextDate.init();
newnextDate.setMode(1);
newnextDate.setAnchor($('#newnextDate'));

var systime=newnextDate.getValue();
var weeksystime=newnextDate.getValue();

var endtime = nextDate.getValue();

var starttime;


$(function(){
    nextDate.setOnChanged(function(self){
        //改变头数据
        endtime = nextDate.getValue();
		
        getListDataTVODSettlementStatistics(endtime,recentPeriod,'tvod-operator-settlement-statistics-table');
        
		getListDataSVODSettlementStatistics(endtime,recentPeriod,'svod-operator-settlement-statistics-table');
		
    });
	
	
	
    
    initTabList(function(){
        //tab 回调函数
        
    });
	
	//货币转换
     $("#currency-choose").on("click","#currency-type-usd",function(){
        var $this = $(this);
         $this.parent().find(".selected").removeClass("selected");
         $(this).addClass("selected");
         var usd=document.getElementById("currency-type-usd");
         var local=document.getElementById("currency-type-local");
         usd.style.display='none';
         local.style.display='block';
         billCurrencyType="LOCAL";
		 
		 if($("#date-table-tvod").hasClass("selected")==true){
            getListDataTVODSettlementStatistics(endtime,recentPeriod,'tvod-operator-settlement-statistics-table');
         }else{
            getListDataSVODSettlementStatistics(endtime,recentPeriod,'svod-operator-settlement-statistics-table');
         }	
		 
      });
	  
      $("#currency-choose").on("click","#currency-type-local",function(){
        var $this = $(this);
          $this.parent().find(".selected").removeClass("selected");
          $(this).addClass("selected");
         var usd=document.getElementById("currency-type-usd");
         var local=document.getElementById("currency-type-local");
         usd.style.display='block';
         local.style.display='none';
         billCurrencyType="USD";
		 
		 if($("#date-table-tvod").hasClass("selected")==true){
            getListDataTVODSettlementStatistics(endtime,recentPeriod,'tvod-operator-settlement-statistics-table');
         }else{
            getListDataSVODSettlementStatistics(endtime,recentPeriod,'svod-operator-settlement-statistics-table');
         }	
		 
      });
	
   
    getListDataTVODSettlementStatistics(endtime,recentPeriod,'tvod-operator-settlement-statistics-table');

	//getListDataSVODSettlementStatistics(endtime,recentPeriod,'svod-operator-settlement-statistics-table');
    
    // 按钮切换
    $("#recent-filter").on("click",".btn-date",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");

        recentPeriod = $(this).index();

        endtime = nextDate.getValue();
		
		if($("#date-table-tvod").hasClass("selected")==true){
            getListDataTVODSettlementStatistics(endtime,recentPeriod,'tvod-operator-settlement-statistics-table');
        }else{
            getListDataSVODSettlementStatistics(endtime,recentPeriod,'svod-operator-settlement-statistics-table');
        }			
        
    });
	
	var table=document.getElementById("multi_droplist");
	var tvod_table=document.getElementById("tvod-settlement");
    var svod_table=document.getElementById("svod-settlement");
	 //点击TVOD结算
    $("#trend-menu-type").on("click","#date-table-tvod",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
		
		table.style.display='none';

		tvod_table.style.display='block';
		svod_table.style.display='none';
		
        $("#trend").html($.i18n.prop("video.tvod.settlement.statistics"));	
		
		getListDataTVODSettlementStatistics(endtime,recentPeriod,'tvod-operator-settlement-statistics-table');
        
     });
     

     
    //点击SVOD结算
     $("#trend-menu-type").on("click","#date-table-svod",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");

        table.style.display='block';
		
		tvod_table.style.display='none';
		svod_table.style.display='block';

        $("#trend").html($.i18n.prop("video.svod.settlement.statistics"));
		
		getListDataSVODSettlementStatistics(endtime,recentPeriod,'svod-operator-settlement-statistics-table');
     
     });
    
	 
	 //初始化多选droplist，渠道下拉框的选择
    setVideoCycletypeInfo('multi_droplist',projectid);
    $(".droplist-multi").on("click", function(event){//droplist-multi：渠道下拉框class
        var $objWrap = $(".multi-obj-wrap");//OK按钮的总class
        var $this = $(this);//取得该元素
        if($this.hasClass("multi-choosed")){//hasClass：检查ok按钮是否包含class类multi-choosed
            $this.removeClass("multi-choosed");//removeClass:移除class类multi-choosed
            $objWrap.hide();//隐藏ok按钮
        }else{
            $this.addClass("multi-choosed");//添加class类multi-choosed
            $objWrap.show();//展示OK按钮
            
            $(".multi-obj-wrap").off().on("click", ".object", function(event){
                if($(this).hasClass("selected")){
                    $(this).removeClass("selected");
                }else{
                    controlMultiListChannelVideo($(this));
                    $(this).addClass("selected");
                    $(this).siblings().removeClass("selected");
                }
                event.stopPropagation();
            });
            $(".droplist-multi-wrap").off().on("click", ".btn-ok", function(event){//渠道下拉框的总class：droplist-multi-wrap
                                                        //OK按钮的class
                
                setAreaDisplay();//选中下拉框的内容
                $objWrap.removeClass("choosing").hide();
                $this.removeClass("multi-choosed");
                cycletype = getAreaID();   
				getListDataSVODSettlementStatistics(endtime,recentPeriod,'svod-operator-settlement-statistics-table');
            });
        }
        event.stopPropagation();
    });
    
    $("body").on("click",function(){
        if($(".droplist-multi").hasClass("multi-choosed")){
            $(".multi-obj-wrap").hide();
            $(".droplist-multi").removeClass("multi-choosed");
        }
    });    
    
    

            
});




</script>