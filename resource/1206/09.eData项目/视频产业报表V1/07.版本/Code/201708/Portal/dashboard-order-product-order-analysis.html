<link rel="stylesheet" type="text/css" href="resources/default/css/eData/dashboard-user-situation.css"/>
<script type="text/javascript" src="js/base_common.js"></script>
<script type="text/javascript" src="data/channel-data_video.js"></script>
<script type="text/javascript" src="js/toExcel/getTblDataFF.js"></script>
<script type="text/javascript" src="js/toExcel/table2excel.js"></script>
<script>
function doExport(){
    _edata.push(['setEvent','edp_channel_analysis','export']);
    getXlsFromTbl('deduction-statistics-table','product-order-analysis-table.xls','');
}


</script>

<style type="text/css">
    .productorderanalysistime-detail{
    text-decoration: underline;
    }
	
	#help_text{
    position: absolute;
    z-index: 20;
    background: #E6E3E3;
    width: 10%;
    height: 30px;
    padding-bottom: 45px;
    border: 1px solid #BCB0B0;
	top:-12%;
	left:23%;
    text-align: left;
}
</style>

<!-- 导出模板页面 -->
<iframe src="exportModel.html" name="exportShow"  style="width:0;height:0"></iframe>


<div class="content-body-wrap content-no-header">
    <div class="content-title">
        <div class="date-wrap float-left" id="nextDate"></div>
       <div class="droplist-wrap float-right" id="groupDroplist"></div>
        <!-- <div class="droplist-multi-wrap channel-droplist" id="multi_droplist">
            <div class="droplist-multi">
                <span class="ellipsis" id="chooseChannel">Channel</span>
                <i class="droplist-multi-trigger"></i>
            </div>
            <div class="multi-obj-wrap">              
                 <ul class="obj-list"> </ul>
                 <div class="btn-wrap">
                     <span class="btn btn-ok" id=btnOK>OK</span>
                 </div>
             </div>
        </div> -->
    </div>
<!-- 列表 -->
    <div class="data-trend-header clearfix">
            <div class="date-filter-wrap" id="recent-filter">
                <span class="btn-date selected">Yesterday</span>
            </div>

            <div class="date-filter-wrap">
            <span class="btn btnH24-opacity1" onclick="doExport()" id="export">Export</span>
            </div>
            <div class="droplist-wrap" id="versionDroplist">
            </div>
            <h3 id="trend">Details</h3><p id="dtime" class="timepos" style="color: #00B0FF;"></p>
    </div>

    <div class="cut-line" style="margin-top:8px;"></div>
    <div class="content-body-wrap" style='padding: 0px 0px 0;margin-top:15px;'>
        <table id="deduction-statistics-table" class="table-dashboard" >
        <colgroup>
        <col width="8%"/>
        <col width="8%"/>
        <col width="8%"/>
        <col width="8%"/>
        <col width="8%"/>
        <col width="8%"/>
        <col width="8%"/>
        <col width="8%"/>
        <col width="10%"/>
        <col width="8%"/>
        <col width="10%"/>
        <col width="8%"/>
        </colgroup>
        <thead>
           <tr>
             <th>productid</th>
             <th>productname</th>
             <th id="th_logo_help">productcatalog</th>
             <th id="th_Subscriptiontype_help">productordertype</th>
             <th>allordertimes</th>
             <th>newordertimes</th>
             <th>loseordertimes</th>
             <th>allorderuser</th>
             <th>neworderuser</th>
             <th>orderuserproportion</th>
             <th>loseorderuser</th>
             <th>Operation</th>
           </tr>
            </thead>
               <tbody>
               </tbody>
        </table>
      </div>
        

    <div class="page clearfix">
          <div class="page-total" id="totalpage">
            <div class="inline-block" >
                Total:<span id="totalrn">--</span>
            </div>
          </div>
            <!--右边按钮区-->
          <div class="float-right" id="pageSplit">
          </div>
    </div>  
    
   
        

</div>        
<script>
initChannel();
function initChannel(){    
    $("#chooseChannel").html($.i18n.prop("video.usertrend.retention.channel"));
    $("#btnOK").html($.i18n.prop("video.usertrend.retention.btnok"));
	
    $("#deduction-statistics-table thead th").each(function(index){
        $(this).html($.i18n.prop("video.product.order.analysis.title_"+(parseInt(index))));
    });    

    $("#export").html($.i18n.prop("video.usertrend.retention.export"));
    
    $("#trend").html($.i18n.prop("video.order.analysis.detail"));
    
    $("#totalpage .inline-block").html($.i18n.prop("video.usertrend.retention.total"));
    
    $("#recent-filter .btn-date").each(function(index){
        $(this).html($.i18n.prop("video.usertrend.retention.days_"+(parseInt(index))));
    });
          
};    

   
//鼠标在问号上时显示提醒
  $("#logo-help").mouseover(function(){
            if ('en' == getLanguage()){
				$("#th_logo_help").append("<div id='help_text'> 0：Pay By The Day<br/>1：Pay By The Month<br/>2：Pay By The Week  </div>");
			}else{
			    $("#th_logo_help").append("<div id='help_text'> 0：按天计费<br/>1：按月计费<br/>2：按周计费  </div>");
			}

  });

 $("#logo-help").mouseout(function(){
        $("#help_text").remove();
  }); 
 $("#Subscriptiontype-help").mouseover(function(){
            if ('en' == getLanguage()){
				$("#th_Subscriptiontype_help").append("<div id='help_text'> 0：Pay By The Day<br/>1：Pay By The Month<br/>2：Pay By The Week  <br/>3：Pay Per View  </div>");
			}else{
			    $("#th_Subscriptiontype_help").append("<div id='help_text'> 0：按天计费<br/>1：按月计费<br/>2：按周计费  <br/>3：按次计费  </div>");
			}

  });

 $("#Subscriptiontype-help").mouseout(function(){
        $("#help_text").remove();
  }); 
  
//获取列表数据
function getListDataChannnel(endtime,periodFlag,productid,tableid){
    if(tableid == 'undefined'){
        return;    
    } 
    var column=tableid.split('_')[0];
    endtime=endtime.replace(/-/g,"");
    var hql="product_order_analysis_detail_d";
    //if(channelid!="All"&&channelid!="ALL"){
        //hql = "product_order_analysis_channel_detail_d";
        //}
        //alert(channelid+productid+endtime);
       Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','PRODUCTID':'"+productid+"','ENDTIME':'"+endtime+"'}",
         
         function(qResult){
     
             if(qResult==null)
             {
                 return;
             }
             
             //alert(qResult);
             
             var obj = JSON.parse(qResult);
             
             var TIME = obj.PRODUCTID;
             
             
             var trendTime = new Array();
             if (TIME instanceof Array)
             {
                 trendTime = TIME;
             }
             //一条数据的 后台未以数组返回
             else
             {
                 trendTime[0] = TIME;
             }
            
             //具体的赋值语句
             channelTrendData = initArray();
             for (var k = 0;k < 11;k++)
             {
                 channelTrendData[k]=new Array();
                 var trendDisplay = productAnalysisTable[k];
                 for(var i=0;i<trendTime.length;i++)
                 {    
                     var labelValue;
                     labelValue=trendTime[i].substr(6,2);//.substr(4,2)
                     channelTrendData[k][i] = {
                         value: [obj[trendDisplay][i]],
                         label: labelValue,
                         attr1: trendTime[i]}; 
                 }
             }
             //list data
             listDetailData = new Array(); 
             listproductid= new Array();
             listProductName= new Array();
             listProductCatalog= new Array();
             listProductOrderTypeVideo= new Array();
             var collen = channelTrendData.length + 1;         
             for (i = 0;i < trendTime.length;i++)
             { 
                  
                  listproductid[i]=new Array();
                  listProductName[i]=new Array();
                  listProductCatalog[i]=new Array();
                  listProductOrderTypeVideo[i]=new Array();
                  listDetailData[i] = new Array();
				  
                 for( j = 1 ;j <= collen; j++)
                 {
                     if(j==collen)
                     {    
                         listproductid[i]=obj.PRODUCTID[i];
                         listProductName[i]=obj.PRODUCTNAME[i];
                         listProductCatalog[i]=obj.PRODUCTCATALOG[i];
                         listProductOrderTypeVideo[i]=obj.PRODUCTORDERTYPE[i];
                         listDetailData[i][j-1]=$.i18n.prop("common.btn.detail");
                     }else{
                     
                         listDetailData[i][j-1] = obj[productAnalysisTable[j-1]][i];
                         if(j == 10){
                             listDetailData[i][j-1] = obj[productAnalysisTable[j-1]][i]+"%";
                             }
                     }
                         
             }

				 if ('en' == getLanguage()){
						if(listDetailData[i][3]=="按次"){
							listDetailData[i][3]="sequence";
						}
					  }
             }
             var needRow = 0;
             //if(listDetailData.length > 12){
             //   needRow = (Math.ceil(listDetailData.length/12))*12;
             //}else{
                needRow = listDetailData.length;
             //}
             if(needRow == "0")
             {
                 needRow= "1";
             }
             if (listDetailData.length > 0)
             {
                 addTableRows('deduction-statistics-table',needRow,listDetailData[0].length);        
             }
             else
             {
                 addTableRows('deduction-statistics-table',12,12);     
             }
             //insertTableDetailProductOrderAnalysis('deduction-statistics-table',listDetailData,listproductid,listchannelid,productAnalysisShowTable,endtime);
             
             insertTableDetailProductOrderAnalysis('deduction-statistics-table',listDetailData,listproductid,listProductName,listProductCatalog,listProductOrderTypeVideo,productAnalysisShowTable,endtime);
             $("#totalrn").html(trendTime.length);
             addPageDiv('pageSplit',needRow,12);
             listSplit('deduction-statistics-table',12);
         });
};


function getStartEndTime(starttime,endtime){
endtime=endtime.replace(/-/g,"");
starttime=starttime.replace(/-/g,"");
$("#dtime").text("("+starttime+"~"+starttime+")");
};

//初始化日期
var nextDate = new UCD.Date(null, "YYYY-MM-dd");
nextDate.init();
nextDate.setMode(1);
nextDate.setAnchor($('#nextDate'));
var projectid=getProjectidFromCookie();

var periodFlag = "0";
var endtime = nextDate.getValue();
var starttime = getBeforeGivenDate(1,endtime);

var channelid = "ALL";
var productid = "ALL";
var providerid = "ALL";
$(function(){
    nextDate.setOnChanged(function(self){
        //改变头数据
        endtime = nextDate.getValue();
        starttime=getBeforeGivenDate(1,endtime);
        getStartEndTime(starttime,endtime);
        getListDataChannnel(endtime,periodFlag,productid,'deduction-statistics-table');
        //getListDataCooperation(endtime,periodFlag,channelid,providerid,'cooperation-statistics-table');
        
    });
    
    initTabList(function(){
        //tab 回调函数
        
    });
    getStartEndTime(starttime,endtime);
    getListDataChannnel(endtime,periodFlag,productid,'deduction-statistics-table');
    //getListDataCooperation(endtime,periodFlag,channelid,providerid,'cooperation-statistics-table');
    $("#deduction-statistics-table").on('click','.productorderanalysistime-detail',function(){
        var $parent = $(this);
        var productid = $parent.attr('productid');
        
        var product_order_analysis_product_name=$parent.attr('product_order_analysis_product_name');
        var productcatalog=$parent.attr('productcatalog');
        var productordertypevideo=$parent.attr('productordertypevideo');
        
        var productorderanalysistime=$parent.attr('productorderanalysistime');
        
        //document.cookie="productid="+productid+";product_order_analysis_productname="+escape(product_order_analysis_product_name)+";productcatalog="+escape(productcatalog)+";productordertypevideo="+escape(productordertypevideo)+";productorderanalysistime="+productorderanalysistime;
        
        document.cookie="productid="+productid;
        
        document.cookie="product_order_analysis_product_name="+escape(product_order_analysis_product_name);
       
        document.cookie="productcatalog="+escape(productcatalog);
        
        document.cookie="productordertypevideo="+escape(productordertypevideo);
        
        document.cookie="productorderanalysistime="+productorderanalysistime;
        
        
        
        //alert(document.cookie);
        _edata.push(['sendPageInfo','eData/video/dashboard-order-product-order-analysis-detail.html']);
        $("#content-body").empty().load("eData/video/dashboard-order-product-order-analysis-detail.html");
    });
    
    // 按钮切换
    $("#recent-filter").on("click",".btn-date",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        //0--yesterday;1--last 7 days; 2--last 31 days
        recentPeriod = $(this).index();
        
        switch (recentPeriod)
        {
            case 0:
                _edata.push(['setEvent','edp_channel_analysis','yesterday']);
                break;
            case 1:
                _edata.push(['setEvent','edp_channel_analysis','last_7_days']);
                break;
            case 2:
                _edata.push(['setEvent','edp_channel_analysis','last_30_days']);
                break;
            default:
                _edata.push(['setEvent','edp_channel_analysis','yesterday']);
                break;
        }
        
        endtime = nextDate.getValue();
        getListDataChannnel(endtime,periodFlag,productid,'deduction-statistics-table');
        
    });
    
    
    //初始化tab list并绑定回调函数
         initTabList(function(){
             //tab 回调函数
             
         }); 
    
    
    //初始化多选droplist
    setVideoChannelInfo('multi_droplist');
    $(".droplist-multi").on("click", function(event){
        var $objWrap = $(".multi-obj-wrap");
        var $this = $(this);
        if($this.hasClass("multi-choosed")){
            $this.removeClass("multi-choosed");
            $objWrap.hide();
        }else{
            $this.addClass("multi-choosed");
            $objWrap.show();

            $(".multi-obj-wrap").off().on("click", ".object", function(event){
                if($(this).hasClass("selected")){
                    $(this).removeClass("selected");
                }else{
                    controlMultiListChannelVideo($(this));
                    $(this).addClass("selected");
                }
                event.stopPropagation();
            });
            $(".droplist-multi-wrap").off().on("click", ".btn-ok", function(event){

                setAreaDisplay();
                $objWrap.removeClass("choosing").hide();
                $this.removeClass("multi-choosed");
                channelid = getAreaID();     
                getListDataChannnel(endtime,periodFlag,productid,'deduction-statistics-table');
                //getListDataCooperation(endtime,periodFlag,channelid,providerid,'cooperation-statistics-table');
            });
        }
        event.stopPropagation();
    });
    
         $("body").on("click",function(){
             if($(".droplist-multi").hasClass("multi-choosed")){
                 $(".multi-obj-wrap").hide();
                 $(".droplist-multi").removeClass("multi-choosed");
             }
         });
            
});

//add by zwx379555 start
function generateCompareTRs(iCol,sDataType){
     return function compareTRs(oTR1,oTR2){
        vValue1 = convert(oTR1.cells[iCol].firstChild.nodeValue,sDataType);
        vValue2 = convert(oTR2.cells[iCol].firstChild.nodeValue,sDataType);
         if(vValue1 < vValue2) {
             return  -1;
        }else if(vValue1 > vValue2){
             return 1;
        }else{
             return 0;
        }
    };
}
function  generateCompareTRs2(iCol, sDataType) {
     return   function  compareTRs(oTR1, oTR2) {
        vValue1 = convert(oTR1.cells[iCol].firstChild.nodeValue, sDataType);
        vValue2 = convert(oTR2.cells[iCol].firstChild.nodeValue, sDataType);
         if  (vValue1 < vValue2) {
             return  1;
        }  else   if  (vValue1 > vValue2) {
             return  -1;
        }  else  {
             return  0;
        }
    };
}
function convert(sValue,sDataType) {
     switch(sDataType){
     case "int":
         return parseInt(sValue);
     case "float":
         return parseFloat(sValue);
     case "date":
         return new Date(Date.parse(sValue));
     default:
         return sValue.toString();
    }
}
function sortTable(sTableID, iCol, sDataType){
     var oTable = document.getElementById(sTableID);
     var oTBody = oTable.tBodies[0];
     var colDataRows = oTBody.rows;
     var aTRs = new Array;
     for(var i = 0; i < colDataRows.length; i++){
        aTRs[i] = colDataRows[i];
    }
     if(oTable.sortCol == iCol) {
        //aTRs.sort(generateCompareTRs2(iCol, sDataType));
        //iCol = -1;
        aTRs.reverse();
    }else{
        aTRs.sort(generateCompareTRs(iCol, sDataType));
    }
     var oFragment = document.createDocumentFragment();
     for (var j = 0; j < aTRs.length; j++) {
        oFragment.appendChild(aTRs[j]);
    }
    oTBody.appendChild(oFragment);
    oTable.sortCol = iCol;
}
//add by zwx379555 end


</script>