<link rel="stylesheet" type="text/css" href="resources/default/css/eData/dashboard-user-situation.css"/>
<script type="text/javascript" src="js/base_common.js"></script>
<script type="text/javascript" src="js/charts/initCharts.js"></script>
<script type="text/javascript" src="js/charts/Line.js"></script>
<script type="text/javascript" src="js/charts/getColor.js"></script>
<script type="text/javascript" src="data/channel-data_video.js"></script>
<script type="text/javascript" src="js/base_common_video.js"></script>
<script type="text/javascript" src="js/dashboard-common_video.js"></script>
<script type="text/javascript" src="js/toExcel/getTblDataFF.js"></script>
<script type="text/javascript" src="js/toExcel/table2excel.js"></script>




<script>
function doExport(){
    _edata.push(['setEvent','edp_channel_analysis','export']);
    getXlsFromTbl('user-retention-table','user-retention-table.xls','');
}
</script>


<style type="text/css">
    .currency{
    text-decoration: underline;
    }
    .line-container {
    background: #fff;
    margin: 20px 0 30px;
    padding: 0 50px 20px 10px;
    }
 .threshold {
    position: absolute;
    top: -20px;
    left: auto!important;
    right: 0;
    z-index: 2;
    color: #000000;
}

.yLegend {
    margin: 10px 0 0 20px;
    font-size: 16px;

}
</style>

<!-- 导出模板页面 -->
<iframe src="exportModel.html" name="exportShow"  style="width:0;height:0"></iframe>


 <div class="content-body-wrap content-no-header">
    <div class="content-title">
        <div class="date-wrap float-left" id="nextDate"></div>
        <!-- <div class="currencycolor" style="float:left" id="currency-choose">
        <span id="currency-type" style="float:left">Currency type:</span>
        <span class="currency" id="currency-type-usd" style="float:left;color:#00b0ff">USD</span>
        <span class="currency" id="currency-type-local" style="display:none;float:left;color:#00b0ff">LOCAL</span>
        </div> -->
        <!--  platformid  -->
		<div class="droplist-multi-wrap channel-droplist" id="overview_platformid_droplist">
            <div class="droplist-multi" id="project_droplist">
                <span class="ellipsiscontent" id="choose_platformid" title="All Platformid">All Platformid</span>
                <i class="droplist-multi-trigger"></i>
            </div>
            <div class="multi-obj-wrap">
                <div class="scrollbar-container-outer">
                      <div class="scrollbar-container">
                          <div class="scrollbar-container-inner">
                          <ul class="obj-list" id="all_platformid"></ul>
                        </div>
                    </div>
                </div>
                <div class="btn-wrap">
                     <span class="btn btn-ok" id="project_droplist_ok">OK</span>
                </div>
            </div>
        </div>
		
        <div class="droplist-wrap float-right" id="groupDroplist"></div>
		
        <div class="droplist-multi-wrap channel-droplist" id="multi_droplist">
            <div class="droplist-multi" id="channel_droplist">
                <span class="ellipsis" id="chooseChannel">Channel</span>
                <i class="droplist-multi-trigger"></i>
            </div>
            <div class="multi-obj-wrap">
                          <ul class="obj-list">
                          </ul>
                 <div class="btn-wrap">
                     <span class="btn btn-ok" id="btnOK">OK</span>
                 </div>
             </div>
        </div>        
    </div>
    
    
    <div class="trend">
        <div class="data-trend-header clearfix">
            <div class="date-filter-wrap" id="trend-filter">
                <span class="btn-date selected">Daily</span>
               <!--  <span class="btn-date">Weekly</span>
                <span class="btn-date">Monthly</span> -->
            </div>
            <div class="date-filter-wrap" id="trend-menu">
                <span id="date-chart" class="btn-date selected">chart</span>
                <span id="date-table" class="btn-date">table</span>
            </div>
            <div class="date-filter-wrap">
            <span class="btn btnH24-opacity1" onclick="doExport()" id="export">Export</span>
            </div>
            <div class="droplist-wrap" id="versionDroplist"></div>
            <h3 id="trend">Trend</h3><p id="trend_dtime" class="timepos" style="color: #00B0FF;"></p>
        </div>
        <div class="content-body-wrap" id="game_trend_table"   style="display:none">
            <table id="user-retention-table" class="table-dashboard" >
                <colgroup>
                    <col width="14%"/>
                    <col width="14%"/>
                    <col width="14%"/>
                    <col width="14%"/>
                    <col width="14%"/>
                    <col width="14%"/>
                    <col width="16%"/> 
                </colgroup>
            <thead>
                <tr>
                    <th>date</th>
                    <th>newsubscriber</th>                   
                    <th>day01retentionrate</th>
                    <th>day03retentionrate</th>
                    <th>day07retentionrate</th>                   
                    <th>day15retentionrate</th>
                    <th>day30retentionrate</th>
                </tr>

                <tr>
                    <th>avgretentionrate</th>
                    <th style="font-weight:normal">newsubscriber</th>                   
                    <th style="font-weight:normal">avgday01retentionrate</th>
                    <th style="font-weight:normal">avgday03retentionrate</th>
                    <th style="font-weight:normal">avgday07retentionrate</th>
                    <th style="font-weight:normal">avgday15retentionrate</th>
                    <th style="font-weight:normal">avgday30retentionrate</th>
                </tr>
            </thead>
               <tbody></tbody>
            </table>          
        <div class="page clearfix" >
           <div class="page-total" id="totalpage">
            <div class="inline-block" >
                Total:<span id="totalrn">--</span>
            </div>
         </div>
            <!--右边按钮区-->
            <div class="float-right" id="pageSplitm">
            </div>
           </div> 
        </div> 
        <div class="edata-dashboard-tab clearfix" id="game_trend_chart">
            <div class="tab-list-header-wrap">
                <a href="javascript:void(0);" class="nav-tab-more tab-left"><i class="icon-more-left"></i>&nbsp;</a>
                <div class="nav-wrap">
                    <ul class="nav-tab-wrap clearfix">
                        <li class="tab-list-wrap">
                            <ul class="tab-list">
                                <li class="nav-tab selected">
                                    <p>newsubscriber</p>
                                </li>                              
                                <li class="nav-tab">
                                    <p>day01retentionrate</p>
                                </li> 
                                <li class="nav-tab">
                                    <p>day03retentionrate</p>
                                </li>
                                <li class="nav-tab">
                                    <p>day07retentionrate</p>
                                </li> 
                                <li class="nav-tab">
                                    <p>day15retentionrate</p>
                                </li>
                                <li class="nav-tab">
                                    <p>day30retentionrate</p>
                                </li> 
                            </ul>
                        </li>
                    </ul>
                </div>
                <a href="javascript:void(0);" class="nav-tab-more"><i class="icon-more-right"></i>&nbsp;</a>
            </div>
            <div class="tab-body-wrap">
                <div class="line-container">
                    <div class="yLegend">
                        Quantity
                    </div>
                    <div id="channelLine" class="line"></div>
                    <div class="xLegend">
                        Date
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 列表 -->
      
 </div>
<script>
initChannel();
function initChannel(){
    $("#currency-type").html($.i18n.prop("video.currency.type.conversion"));
    $("#currency-type-usd").html($.i18n.prop("video.currency.usd"));
    $("#currency-type-local").html($.i18n.prop("video.currency.local"));
    $("#chooseChannel").html($.i18n.prop("video.usertrend.retention.channel"));
	$("#choose_platformid").html($.i18n.prop("video.usertrend.retention.platformid"));
    $("#btnOK").html($.i18n.prop("video.usertrend.retention.btnok"));
    $("#recent-filter .btn-date").each(function(index){
        $(this).html($.i18n.prop("video.usertrend.retention.days_"+index));
    });
    $("#date-chart").html($.i18n.prop("video.common.trend.date.chart"));
    $("#date-table").html($.i18n.prop("video.common.trend.date.table"));
    $("#recentdata").html($.i18n.prop("video.usertrend.retention.recentdata"));
    
    $("#trend-filter .btn-date").each(function(index){
        $(this).html($.i18n.prop("video.usertrend.retention.daytype_"+index));
    });//日周月
    
    $("#trend").html($.i18n.prop("video.usertrend.retentionanalysis.trend"));//留存分析
    

    
    $(".tab-list-wrap .tab-list .nav-tab p").each(function(index){
        $(this).html($.i18n.prop("video.user.retention.tabletitle_"+(parseInt(index))));
    });//图数据
    $(".line-container .yLegend").html($.i18n.prop("video.usertrend.retention.quantity"));
    $(".line-container .xLegend").html($.i18n.prop("video.usertrend.retention.date"));
    $("#export").html($.i18n.prop("video.usertrend.retention.export"));
    $("#details").html($.i18n.prop("video.usertrend.retention.details"));
    
    <!-- $("#user-retention-table thead tr").eq(0).find("th").each(function(index){  -->
        <!-- $(this).html($.i18n.prop("video.user.retention.detailtitle_"+(parseInt(index))));  -->
    <!-- });//表数据  -->
    
    $("#user-retention-table thead").eq(0).find("th").each(function(index){ 
        $(this).html($.i18n.prop("video.user.retention.detailtitle_"+(parseInt(index)))); 
    });//表数据 
    

    $("#totalpage .inline-block").html($.i18n.prop("video.usertrend.retention.total"));
}






//初始化日期
var nextDate = new UCD.Date(null, "YYYY-MM-dd");
nextDate.init();
nextDate.setMode(1);
nextDate.setAnchor($('#nextDate'));
//golbal var
var periodFlag = "0";//日周月
var displayFlag = "0";//指具体的指标
var channelid = "ALL";
var platformid="ALL"; 
//var projectid = "ALL";
var recentPeriod = "0";//昨日，近7日，近30日
var projectid=getProjectidFromCookie();
var endtime = nextDate.getValue();

var newnextDate = new UCD.Date(null, "YYYY-MM-dd");
newnextDate.init();
newnextDate.setMode(1);
newnextDate.setAnchor($('#newnextDate'));
var systime=newnextDate.getValue();


var starttime = getBeforeGivenDate(1,endtime);
var billCurrencyType="USD";


$(function(){
    nextDate.setOnChanged(function(self){     
        endtime=nextDate.getValue();
        starttime=getBeforeGivenDate(1,endtime);
		getuserTrendDataNew(endtime,periodFlag,displayFlag,platformid);		
        getuserTrendData(endtime,periodFlag,displayFlag,platformid);////改变图数据
        getuserTrendDataTable(endtime,periodFlag,displayFlag,'user-retention-table',platformid); //改变表数据   	
    });
    
    //改变图数据
    $("#trend-menu").on("click","#date-chart",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        var chart=document.getElementById("game_trend_chart");
        var table=document.getElementById("game_trend_table");
        chart.style.display='block';//展开
        table.style.display='none';//隐藏
        getuserTrendData(endtime,periodFlag,displayFlag,platformid);
     });
     
    //改变表数据 
     $("#trend-menu").on("click","#date-table",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        var chart=document.getElementById("game_trend_chart");
        var table=document.getElementById("game_trend_table");
        table.style.display='block';
        chart.style.display='none';
		getuserTrendDataNew(endtime,periodFlag,displayFlag,platformid);		
        getuserTrendDataTable(endtime,periodFlag,displayFlag,'user-retention-table',platformid);
     });
    
    
    
    
    //不同指标trend切换，切换指标刷新显示相应数据，enchannelTrendData：指标集合， projectSituationSingleDisplayTrend中英文名称集合
    $(".nav-wrap").on("click",".nav-tab",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        displayFlag = $(this).index();
        drawCall();
        
             
    });
 

    //初始化tab list并绑定回调函数
    initTabList(function(){
        //tab 回调函数
        
    });
	
	//var newenchannelTrendData=getuserTrendDataNew(systime,periodFlag,displayFlag);	
	
	 getuserTrendDataNew(endtime,periodFlag,displayFlag,platformid);	 
     getuserTrendData(endtime,periodFlag,displayFlag,platformid);
	 getuserTrendDataTable(endtime,periodFlag,displayFlag,'user-retention-table',platformid);

	 
	 

    //初始化多选droplist，渠道下拉框的选择
    setVideoChannelInfo('multi_droplist',projectid);
    $("#channel_droplist").on("click", function(event){//droplist-multi：渠道下拉框class
//        var $objWrap = $(".multi-obj-wrap");//OK按钮的总class
    	var $this = $(this);//取得该元素
        var $objWrap = $this.parent().find(".multi-obj-wrap");
        
        if($this.hasClass("multi-choosed")){//hasClass：检查ok按钮是否包含class类multi-choosed
            $this.removeClass("multi-choosed");//removeClass:移除class类multi-choosed
            $objWrap.hide();//隐藏ok按钮
        }else{
            $this.addClass("multi-choosed");//添加class类multi-choosed
            $objWrap.show();//展示OK按钮
            //自定义滚动条
//            $(".multi-obj-wrap").off().on("click", ".object", function(event){
              $objWrap.find(".object").off().on("click", function(event){
                if($(this).hasClass("selected")){
                    $(this).removeClass("selected");
                }else{
                    controlMultiListChannelVideo($(this));
                    $(this).addClass("selected");
                    $(this).siblings().removeClass("selected");
                }
                event.stopPropagation();
            });
//            $(".droplist-multi").off().on("click", ".btn-ok", function(event){//渠道下拉框的总class：droplist-multi-wrap
            $objWrap.find(".btn-ok").off().on("click", function(event){ 
            	//OK按钮的class
//                setAreaDisplay();//选中下拉框的内容
                setDroplistTiltle($this);
                $objWrap.removeClass("choosing").hide();
                $this.removeClass("multi-choosed");
                //callback function for update
                channelid = getAreaID();
                getuserTrendDataNew(endtime,periodFlag,displayFlag,platformid);				
                getuserTrendData(endtime,periodFlag,displayFlag,platformid);
                getuserTrendDataTable(endtime,periodFlag,displayFlag,'user-retention-table',platformid);
            });
        }
        event.stopPropagation();
    });
	
	//终端类型
	setFlowPlatformidInfoVideo('overview_platformid_droplist',projectid);
    $("#project_droplist").on("click", function(event){
		
        var $this = $(this);
        var $objWrap = $this.parent().find(".multi-obj-wrap");
        if($this.hasClass("multi-choosed")){
            $this.removeClass("multi-choosed");
            $objWrap.hide();
        }else{
            $this.addClass("multi-choosed");
            $objWrap.show();
            if(this.projectScrollbar){
                this.projectScrollbar.refreshScroll();
            }else{
                this.projectScrollbar = new ucd.DefaultScroll({
                    scrollObj:$objWrap.find(".scrollbar-container")
                });
                this.projectScrollbar.refreshScroll();
            }
            $objWrap.find(".object").off().on("click", function(event){
                if($(this).hasClass("selected")){
                    $(this).removeClass("selected");
                }else{                
                    removeAllSelection($(this));
                    $(this).addClass("selected");
                }
                event.stopPropagation();
            });
            $objWrap.find(".btn-ok").off().on("click", function(event){
                //_edata.push(['setEvent','edc_Overview','Switch_Project']);
                setDroplistTiltles($this);
                $objWrap.removeClass("choosing").hide();
                $this.removeClass("multi-choosed");
                platformid = getSelectPlatformid();
                //alert(platformid);
				getuserTrendDataNew(endtime,periodFlag,displayFlag,platformid);				
                getuserTrendData(endtime,periodFlag,displayFlag,platformid);
                getuserTrendDataTable(endtime,periodFlag,displayFlag,'user-retention-table',platformid);
            });
        }
        event.stopPropagation();
    });
    
    $("body").on("click",function(){
        if($(".droplist-multi").hasClass("multi-choosed")){
            $(".multi-obj-wrap").hide();
            $(".droplist-multi").removeClass("multi-choosed");
        }
    });    
    
    
    
});


//获取图数据
function getuserTrendData(endtime,periodFlag,displayFlag,platformid){
    endtime=endtime.replace(/-/g,"");
    
     var hql="user_retention_30d";
       
    Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','ENDTIME':'"+endtime+"','ACTIVITYCHANNELID':'"+channelid+"','PLATFORMID':'"+platformid+"'}",
               function(qResult){
        if(qResult==null)
        {
            return;
        }
        var obj = JSON.parse(qResult);
        var TIME = obj.DTIME;
        if("2" == periodFlag){
            TIME = obj.MTIME;
        }else if("1" == periodFlag){
            TIME = obj.WTIME;
        }
        var trendTime = new Array();
        if (TIME instanceof Array){
            trendTime = TIME;
        }
        //一条数据的 后台未以数组返回
        else{
            trendTime[0] = TIME;
        }    
                   
        //具体的赋值语句
        enchannelTrendData = initArray();
        for (var k = 0;k < 11;k++){
            enchannelTrendData[k]=new Array();
            var trendDisplay = userRetentionTrend[k];

           for(var i=0;i<trendTime.length;i++)
            {    
                var labelValue;
                if ("0" == periodFlag){
                    labelValue=trendTime[i].substr(6,2);
                }
                else if("1" == periodFlag){
                    labelValue=trendTime[i];//.substr(4,2)
                }
                else{
                    labelValue=trendTime[i];//.substr(4,2)
                }

                enchannelTrendData[k][i] = {
                             value: [obj[trendDisplay][i]],
                             label: labelValue,
                             attr1: 'classname'};

            }
        }
        drawCall();
   
    });
};

function getuserTrendDataNew(endtime,periodFlag,displayFlag,platformid){
     endtime=endtime.replace(/-/g,"");
    
     var hql="user_retention_30d";
       
    Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','ENDTIME':'"+endtime+"','ACTIVITYCHANNELID':'"+channelid+"','PLATFORMID':'"+platformid+"'}",
               function(qResult){
        if(qResult==null)
        {
            return;
        }
        var obj = JSON.parse(qResult);
        var TIME = obj.DTIME;
        if("2" == periodFlag){
            TIME = obj.MTIME;
        }else if("1" == periodFlag){
            TIME = obj.WTIME;
        }
        var trendTime = new Array();
        if (TIME instanceof Array){
            trendTime = TIME;
        }
        //一条数据的 后台未以数组返回
        else{
            trendTime[0] = TIME;
        }                
        //具体的赋值语句
        newenchannelTrendData = initArray();
        for (var k = 0;k < 11;k++){
            newenchannelTrendData[k]=new Array();
            var trendDisplay = userRetentionTrend[k];

           for(var i=0;i<trendTime.length;i++)
            {    
                var labelValue;
                if ("0" == periodFlag){
                    labelValue=trendTime[i].substr(6,2);
                }
                else if("1" == periodFlag){
                    labelValue=trendTime[i];//.substr(4,2)
                }
                else{
                    labelValue=trendTime[i];//.substr(4,2)
                }

                newenchannelTrendData[k][i] = {
                             value: [obj[trendDisplay][i]],
                             label: labelValue,
                             attr1: 'classname'};

            }
        }
		newTableData()

    });

	
};
//获取表数据
function getuserTrendDataTable(endtime,periodFlag,displayFlag,tableid,platformid){    
         endtime=endtime.replace(/-/g,"");
         var hql="user_retention_30d";
         
 
         Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','ACTIVITYCHANNELID':'"+channelid+"','ENDTIME':'"+endtime+"','PLATFORMID':'"+platformid+"'}",
         function(qResult){
             if(qResult==null)
             {
                 return;
             }
             var obj = JSON.parse(qResult);
			 
             var TIME = obj.DTIME;
            
             var trendTime = new Array();
             if (TIME instanceof Array){
                 trendTime = TIME;
             }
             //一条数据的 后台未以数组返回
             else{
                 trendTime[0] = TIME;
             }   
             
            $("#trend_dtime").text("("+trendTime[0]+"~"+trendTime[trendTime.length-1]+")");
            
             //具体的赋值语句
             channelTrendData = initArray();
             for (var k = 0;k < 12;k++){
                 channelTrendData[k]=new Array();
                 var trendDisplay = userRetentionTabled[k];//图里日的数据获取字段

                 for(var i=0;i<trendTime.length;i++)
                 {    
                 
                     var labelValue;
                     if ("0" == periodFlag){
                         labelValue=trendTime[i].substr(6,2);
                     }
                     else if("1" == periodFlag){
                         labelValue=trendTime[i];//.substr(4,2)
                     }
                     else{
                         labelValue=trendTime[i];//.substr(4,2)
                     }
                     channelTrendData[k][i] = {
                         value: [obj[trendDisplay][i]],
                         label: labelValue,
                         attr1: trendTime[i]};
                  }
                     
             }
             //list data
             listDetailData = new Array(); 
            // var collen = channelTrendData.length + 1;       
            
             for (i = 0;i < trendTime.length;i++)
             {
                 listDetailData[i] = new Array();
                 for( j = 1 ;j < 8; j++)
                 {                                       
                        listDetailData[i][j-1] = obj[userRetentionTabled[j-1]][i];
                        

                        
                        if(j==3||j==4||j==5||j==6||j==7){
							
							if(obj[userRetentionTabled[j-1]][i]=="0"){
											listDetailData[i][j-1]=" ";
							} else{                               
								 listDetailData[i][j-1] = obj[userRetentionTabled[j-1]][i].toFixed(2)+"%";
								  }  
						}							  
                 }
             }
             var needRow = (Math.ceil(listDetailData.length/12))*12;
             if(needRow == "0")
             {
                 needRow= "1";
             }
             if (listDetailData.length > 0)
             {
                 addTableRows('user-retention-table',needRow,listDetailData[0].length);        
             }
             else
             {
                 addTableRows('user-retention-table',12,7);     
             }            			 
             
             insertTableDatas('user-retention-table',listDetailData,userRetentionShowTabled);
             
             $("#totalrn").html(trendTime.length);
             addPageDiv('pageSplitm',needRow,12);
             listSplitm('user-retention-table',12);
         });
};

function drawCall(){
	var i =displayFlag+5;       
	if(displayFlag!=0){
		$(".line-container .yLegend").html("%");
		//alert(enchannelTrendData[i][29].value);  newenchannelTrendData
		drawlinenew("#channelLine",enchannelTrendData[displayFlag],periodFlag,userRetentionDisplayTrend[displayFlag],enchannelTrendData[i][29]);
	}
	else{
		$(".line-container .yLegend").html($.i18n.prop("video.usertrend.retention.quantity"));
		drawline("#channelLine",enchannelTrendData[displayFlag],periodFlag,userRetentionDisplayTrend[displayFlag]);
	}
 }

function newTableData(){
	$("#user-retention-table thead tr").eq(1).find("th").each(function(index){
		if(index==0){
			$(this).html($.i18n.prop("video.usertrend.retention.avgretentionrate"));
		}
		else if(index==1){
			$(this).html("----");
		}else{
			var index=parseInt(index)-1;
			$(this).html(parseFloat(newenchannelTrendData[index+5][29].value).toFixed(2)+"%"); 
		}
		
	});
}	 


</script>