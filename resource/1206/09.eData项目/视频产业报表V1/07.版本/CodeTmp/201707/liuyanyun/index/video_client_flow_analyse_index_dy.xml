<reportIndexGroup>
    <multiHqlReportIndexs>
<!--
//每日各种模式(网络和终端)
//networktype 网络类型 取值为：2G,3G,4G,wifi
//platformid 平台ID 取值为：1:安卓;2:IOS;3:其他
//
//根据 网络类型筛选 （ platformid ='ALL'）;根据 终端类型 （networktype ='ALL'）
//
//[20170306@SE]变动确认：（当月当年指标中）用户不需要进行去重，直接累加
-->		
		<!--点播流量 vodflow-->
		<!--直播流量 livetvflow-->
		<!--点播用户 vodwatchusers-->
		<!--直播用户 livetvwatchusers-->
        <multiHqlReportIndex>
            <indexKey>video.client.flow.analyse.columns.dy</indexKey>
            <fieldName>vodflow,livetvflow,vodwatchusers,livetvwatchusers</fieldName>
            <hql>
                <![CDATA[
				select projectid,networktype,platformid,dtime,
					   sum(vodflow) vodflow,
					   sum(livetvflow) livetvflow,
					   sum(vodwatchusers) vodwatchusers,
					   sum(livetvwatchusers) livetvwatchusers
				  from (select t1.projectid,
							   if(t1.networktype is null, 'ALL', t1.networktype) networktype,
							   if(t1.platformid is null, 'ALL', t1.platformid) platformid,
							   t2.dtime,
							   if(t1.vodwatchflow is null, 0, t1.vodwatchflow) vodflow,
							   if(t1.livetvwatchflow is null, 0, t1.livetvwatchflow) livetvflow,
							   if(t1.vodwatchusers is null, 0, t1.vodwatchusers) vodwatchusers,
							   if(t1.livetvwatchusers is null, 0, t1.livetvwatchusers) livetvwatchusers
						  from (select *
								  from video.t_video_client_flow_day_analy_d_hbase t
								 where substr(t.dtime, 0, 4) >= substr('{STARTTIME}', 0, 4)
								   and substr(t.dtime, 0, 4) <= substr('{ENDTIME}', 0, 4)) t1,
							   (select t.dtime
								  from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t2
						 where substr(t1.dtime, 0, 4) = substr(t2.dtime, 0, 4)
						   and t1.dtime <= t2.dtime) tt
				 group by projectid, networktype, platformid, dtime
                ]]>
            </hql>
        </multiHqlReportIndex>
                        <!--
                //当期 活跃的的用户数量 activeusers [游客和注册用户数]
                //注意更新：全部取客户端上报的事件（组合表不再使用）
                -->
                <multiHqlReportIndex>
                        <indexKey>video.client.flow.analyse.activeusers.dy</indexKey>
                        <fieldName>activeusers</fieldName>
                         
                        <hql>
                                <![CDATA[
                          		select projectid,networktype,platformid,dtime,
					   count(distinct(userid)) activeusers
				  from (select t1.c1 projectid,
							   'ALL' networktype,
							   'ALL' platformid,
							   t2.dtime,
							   t1.userid
						  from (select * from video.t_cdr_sdk_event_join_video_user t
						 where substr(t.date, 0, 4) >= substr('{STARTTIME}', 0, 4)
						   and substr(t.date, 0, 4) <= substr('{ENDTIME}', 0, 4))t1
						   left join(select dtime from video.t_bdi_muchtv_video_rundate t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}')t2
					where substr(t1.date, 0, 4) =substr(t2.dtime, 0, 4)
					  and t1.date <= t2.dtime
					) tt
				 group by projectid,networktype,platformid,dtime
                                ]]>  
                        </hql> 
                        
                </multiHqlReportIndex>
		
		<!--总播放流量 totalflow-->
		<!-- 平均每用户消耗点播流量 avgvodflow = vodflow 点播流量 / 点播用户数-->
		<!-- 平均每用户消耗点播流量 avglivetvflow = livetvflow 点播流量 / 点播用户数-->
		<multiHqlReportIndex>
            <indexKey>video.client.flow.analyse.flowavg.dy</indexKey>
            <fieldName>totalflow,avgvodflow,avglivetvflow</fieldName>
            <hql>
                <![CDATA[
				select projectid,networktype,platformid,dtime,
					   (vodflow + livetvflow) totalflow,
					   (vodflow / vodwatchusers) avgvodflow,
					   (livetvflow / livetvwatchusers) avglivetvflow
				  from (select projectid,
							   if(t.networktype is null, 'ALL', t.networktype) networktype,
							   if(t.platformid is null, 'ALL', t.platformid) platformid,
							   dtime,
							   vodflow,
							   livetvflow,
							   vodwatchusers,
							   livetvwatchusers
						  from video.t_video_client_flow_analyse_dy_hbase t
						 where t.dtime > '{STARTTIME}'
						   and t.dtime < '{ENDTIME}') tt
				 group by projectid,networktype,platformid,dtime,
						  (vodflow + livetvflow),
						  (vodflow / vodwatchusers),
						  (livetvflow / livetvwatchusers)
                ]]>
            </hql>
        </multiHqlReportIndex>
		
		<!--活跃用户DOU	douflow = 总播放流量 totalflow/活跃用户数-->
		<multiHqlReportIndex>
            <indexKey>video.client.flow.analyse.douflow.dy</indexKey>
            <fieldName>douflow</fieldName>
            <hql>
                <![CDATA[
				select projectid, networktype, platformid, dtime, (totalflow / activeusers) douflow
				  from (select t1.projectid,t1.networktype,t1.platformid,t1.dtime,t1.totalflow,
							   t2.activeusers
						  from (select projectid, networktype, platformid, dtime, totalflow
								  from video.t_video_client_flow_analyse_dy_hbase t
								 where t.dtime > '{STARTTIME}'
								   and t.dtime < '{ENDTIME}') t1
						  left join (select projectid,dtime,if(activeusers is null, 0, activeusers) activeusers
									  from video.t_video_client_flow_analyse_dy_hbase t
									 where t.dtime > '{STARTTIME}'
									   and t.dtime < '{ENDTIME}'
									   and t.networktype is null
									  and t.platformid is null) t2
							on t1.projectid = t2.projectid
						   and t1.dtime = t2.dtime
					) tt
				 group by projectid, networktype, platformid, dtime, (totalflow / activeusers)
                ]]>
            </hql>
        </multiHqlReportIndex>
		
    </multiHqlReportIndexs>
</reportIndexGroup>
