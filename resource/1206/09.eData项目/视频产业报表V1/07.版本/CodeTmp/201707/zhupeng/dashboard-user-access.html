<link rel="stylesheet" type="text/css" href="resources/default/css/eData/dashboard-user-situation.css"/>
<script type="text/javascript" src="js/base_common.js"></script>
<script type="text/javascript" src="data/channel-data_video.js"></script>
<script type="text/javascript" src="js/base_common_video.js"></script>
<script type="text/javascript" src="js/dashboard-common_video.js"></script>
<script type="text/javascript" src="js/toExcel/getTblDataFF.js"></script>
<script type="text/javascript" src="js/toExcel/table2excel.js"></script>
<script>
function doExport(){
    _edata.push(['setEvent','edp_channel_analysis','export']);
    getXlsFromTbl('user-access-table','user-access-table.xls','');
}
</script>

<!-- 导出模板页面 -->
<iframe src="exportModel.html" name="exportShow"  style="width:0;height:0"></iframe>


 <div class="content-body-wrap content-no-header">
    <div class="content-title">
        <div class="date-wrap float-left" id="nextDate"></div>
        
	<!--  platformid  -->
		<div class="droplist-multi-wrap channel-droplist" id="overview_platformid_droplist">
            <div class="droplist-multi" id="project_droplist">
                <span class="ellipsiscontent" id="choose_platformid" title="All Platformid">All Platformid</span>
                <i class="droplist-multi-trigger"></i>
            </div>
            <div class="multi-obj-wrap">
                <div class="scrollbar-container-outer">
                      <div class="scrollbar-container">
                          <div class="scrollbar-container-inner">
                          <ul class="obj-list" id="all_platformid"></ul>
                        </div>
                    </div>
                </div>
                <div class="btn-wrap">
                     <span class="btn btn-ok" id="project_droplist_ok">OK</span>
                </div>
            </div>
        </div>
        
        <div class="droplist-wrap float-right" id="groupDroplist"></div>
        <div class="droplist-multi-wrap channel-droplist" id="multi_droplist">
            <div class="droplist-multi" id="channel_droplist">
                <span class="ellipsis" id="chooseChannel">Channel</span>
                <i class="droplist-multi-trigger"></i>
            </div>
            <div class="multi-obj-wrap">
                          <ul class="obj-list">
                          </ul>
                 <div class="btn-wrap">
                     <span class="btn btn-ok" id="btnOK">OK</span>
                 </div>
             </div>
        </div>        		
    </div>
	
    
    <div class="content-data">
        <div class="content-data-header clearfix">
            <div class="date-filter-wrap" id="recent-filter">
                <span class="btn-date selected">Yesterday</span>
                <span class="btn-date">Last 7 Days</span>
                <span class="btn-date">Last 30 Days</span>                
            </div>
            <h3 id="recentdata">Recent Data</h3><p id="dtime" class="timepos" style="color: #00B0FF;"></p>
        </div>
        <div>
            <table class="table-dashboard" id="tableRecent">
                <colgroup>
                    <col width="12.5%"/>
					<col width="12.5%"/>
                    <col width="12.5%"/>
					<col width="12.5%"/>
                    <col width="12.5%"/>
					<col width="12.5%"/>
                    <col width="12.5%"/>
					<col width="12.5%"/>
                    <col />
                </colgroup>
                <thead>
                    <th>newvisitor</th>
					<th>totalvisitor</th>
                    <th>newregisteruser</th>
                    <th>neworderuser</th>
                    <th>loginuser</th>
                    <th>allregisteruser</th>
                    <th>totalregisteruser</th>
                    <th>newunsubscribeproduct</th>
                </thead>
                <tbody>
                    <td><p id='newvisitor'></p></td>
					<td><p id='totalvisitor'></p></td>
                    <td><p id='newregisteruser'></p></td>
                    <td><p id='neworderuser'></p></td>
                    <td><p id='loginuser'></p></td>
                    <td><p id='allregisteruser'></p></td>
                    <td><p id='totalregisteruser'></p></td>
                    <td><p id='newunsubscribeproduct'></p></td>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="trend">
        <div class="data-trend-header clearfix">
            <div class="date-filter-wrap" id="trend-filter">
                <span class="btn-date selected">Daily</span>
                <span class="btn-date">Weekly</span>
                <span class="btn-date">Monthly</span>
            </div>
            <div class="date-filter-wrap" id="trend-menu">
                <span id="date-chart" class="btn-date selected">chart</span>
                <span id="date-table" class="btn-date">table</span>
            </div>
            <div class="date-filter-wrap">
            <span class="btn btnH24-opacity1" onclick="doExport()" id="export">Export</span>
            </div>
            <div class="droplist-wrap" id="versionDroplist"></div>
            <h3 id="trend">Trend</h3><p id="trend_dtime" class="timepos" style="color: #00B0FF;"></p>
        </div>
        <div class="content-body-wrap" id="game_trend_table"   style="display:none">
            <table id="user-access-table" class="table-dashboard" >
                <colgroup>
                    <col width="11%"/>
                    <col width="11%"/>
                    <col width="11%"/>
                    <col width="11%"/>
                    <col width="11%"/>
                    <col width="11%"/>
                    <col width="11%"/>
                    <col width="11%"/>
					<col width="12%"/>
                </colgroup>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>newvisitor</th>
					<th>totalvisitor</th>
                    <th>newregisteruser</th>
                    <th>neworderuser</th>
                    <th>loginuser</th>
                    <th>allregisteruser</th>
                    <th>totalregisteruser</th>
                    <th>newunsubscribeproduct</th>
                </tr>
            </thead>
               <tbody></tbody>
            </table>
        
        <div class="page clearfix" >
           <div class="page-total" id="totalpage">
            <div class="inline-block" >
                Total:<span id="totalrn">--</span>
            </div>
         </div>
            <!--右边按钮区-->
            <div class="float-right" id="pageSplitm">
            </div>
           </div> 
        </div> 
        <div class="edata-dashboard-tab clearfix" id="game_trend_chart">
            <div class="tab-list-header-wrap">
                <a href="javascript:void(0);" class="nav-tab-more tab-left"><i class="icon-more-left"></i>&nbsp;</a>
                <div class="nav-wrap">
                    <ul class="nav-tab-wrap clearfix">
                        <li class="tab-list-wrap">
                            <ul class="tab-list">
                                <li class="nav-tab selected">
                                    <p>newvisitor</p>
                                </li>
								<li class="nav-tab">
                                    <p>totalvisitor</p>
                                </li>
                                <li class="nav-tab">
                                    <p>newregisteruser</p>
                                </li>
                                <li class="nav-tab">
                                    <p>neworderuser</p>
                                </li>
                                <li class="nav-tab">
                                    <p>loginuser</p>
                                </li>
                                <li class="nav-tab">
                                    <p>allregisteruser</p>
                                </li> 
                                <li class="nav-tab">
                                    <p>totalregisteruser</p>
                                </li>
                                <li class="nav-tab">
                                    <p>newunsubscribeproduct</p>
                                </li> 
                            </ul>
                        </li>
                    </ul>
                </div>
                <a href="javascript:void(0);" class="nav-tab-more"><i class="icon-more-right"></i>&nbsp;</a>
            </div>
            <div class="tab-body-wrap">
                <div class="line-container">
                    <div class="yLegend">
                        Quantity
                    </div>
                    <div id="channelLine" class="line"></div>
                    <div class="xLegend">
                        Date
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 列表 -->
      
 </div>
<script>
initChannel();
function initChannel(){
    $("#chooseChannel").html($.i18n.prop("video.usertrend.retention.channel"));
	$("#choose_platformid").html($.i18n.prop("video.usertrend.retention.platformid"));
    $("#btnOK").html($.i18n.prop("video.usertrend.retention.btnok"));
	$("#project_droplist_ok").html($.i18n.prop("video.usertrend.retention.btnok"));
    $("#recent-filter .btn-date").each(function(index){
        $(this).html($.i18n.prop("video.usertrend.retention.days_"+index));
    });
    $("#date-chart").html($.i18n.prop("video.common.trend.date.chart"));
    $("#date-table").html($.i18n.prop("video.common.trend.date.table"));
    $("#recentdata").html($.i18n.prop("video.usertrend.retention.recentdata"));
    
    $("#trend-filter .btn-date").each(function(index){
        $(this).html($.i18n.prop("video.usertrend.retention.daytype_"+index));
    });//日周月
    
    $("#trend").html($.i18n.prop("video.usertrend.retention.trend"));
    
    $("#tableRecent thead th").each(function(index){
        $(this).html($.i18n.prop("video.user.access.tabletitle_"+(parseInt(index))));
    });//获取头部数据
    
    $(".tab-list-wrap .tab-list .nav-tab p").each(function(index){
        $(this).html($.i18n.prop("video.user.access.tabletitle_"+(parseInt(index))));
    });//图数据
    $(".line-container .yLegend").html($.i18n.prop("video.usertrend.retention.quantity"));
    $(".line-container .xLegend").html($.i18n.prop("video.usertrend.retention.date"));
    $("#export").html($.i18n.prop("video.usertrend.retention.export"));
    $("#details").html($.i18n.prop("video.usertrend.retention.details"));
    
    $("#user-access-table thead th").each(function(index){
        $(this).html($.i18n.prop("video.user.access.detailtitle_"+(parseInt(index))));
    });//表数据
    
    $("#totalpage .inline-block").html($.i18n.prop("video.usertrend.retention.total"));
}


//获取头数据
function getProjectNumData(starttime,endtime,recentPeriod,channelid,platformid){
	
	if(recentPeriod=="0"){

		endtime=getBeforeGivenDateVideo(1,endtime);
		endtime=endtime.replace(/-/g,"");
		$("#dtime").text("("+endtime+"~"+endtime+")");

	}else if(recentPeriod=="1"){
		yesterdaytime=getBeforeGivenDateVideo(1,endtime);
		var s = yesterdaytime+" 00:00:00";    
		var tD = new Date(Date.parse(s.replace(/-/g,"/"))); 												
		var FirstDay = aa(tD); 
		var FirstDayOfWeek = MM_dateFormata(FirstDay,7);			
		var LastDay = bb(tD); 		
		var LastDayOfWeek = MM_dateFormatb(LastDay,7);
		var m = weeksystime+" 00:00:00"; 
		var mD = new Date(Date.parse(m.replace(/-/g,"/"))); 
		var mFirstDay = aa(mD); 
		var mFirstDayOfWeek = MM_dateFormata(mFirstDay,7);
		//alert("选择时间减一天所在周第一天"+FirstDayOfWeek+"系统时间减一天所在周第一天"+mFirstDayOfWeek);
		if(FirstDayOfWeek==mFirstDayOfWeek){	
			yesterdaytime=yesterdaytime.replace(/-/g,"");
			endtime=yesterdaytime;
			$("#dtime").text("("+FirstDayOfWeek+"~"+yesterdaytime+")");			
		}else{
			endtime=LastDayOfWeek;
			$("#dtime").text("("+FirstDayOfWeek+"~"+LastDayOfWeek+")");
		}
	}else if(recentPeriod=="2"){

		var monthtime=endtime;
		endtime=endtime.replace(/-/g,"");
		a=endtime.substr(0,6);
		systime=systime.replace(/-/g,"");
		b=systime.substr(0,6);		
		var m=endtime.substr(6,2);
		if(a==b){
			starttime=a+"01";
			endtime=getBeforeGivenDateVideo(1,monthtime);
			endtime=endtime.replace(/-/g,"");
			if(m=="01"){
				starttime=endtime.substr(0,6)+"01";
			}
		}else{
			starttime=a+"01";
			c=parseInt(endtime.substr(4,2));				
			endtime=a+getSelectMonthTime(c);				
		}	
		$("#dtime").text("("+starttime+"~"+endtime+")");
	}
    var hql="user_access_d";
    
    if("0" == recentPeriod){
        hql="user_access_d";
    }
    else if("1" == recentPeriod){
        hql="user_access_sd";
    }
    else if("2" == recentPeriod){
        hql="user_access_td";
    }else{
        hql="user_access_d";
    }
    Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','ENDTIME':'"+endtime+"','ACTIVITYCHANNELID':'"+channelid+"','PLATFORMID':'"+platformid+"'}",
    function(qResult){
        if(qResult==null)
        {
            return;
        } 
        var page0Overview = JSON.parse(qResult);

        $("#newvisitor").text(commafy(page0Overview.NEWVISITOR));
		$("#totalvisitor").text(commafy(page0Overview.TOTALVISITOR));
        $("#newregisteruser").text(commafy(page0Overview.NEWREGISTERUSER));
        $("#neworderuser").text(commafy(page0Overview.NEWORDERUSER));
        $("#loginuser").text(commafy(page0Overview.LOGINUSER));
        $("#allregisteruser").text(commafy(page0Overview.ALLREGISTERUSER));
        $("#totalregisteruser").text(commafy(page0Overview.TOTALREGISTERUSER));
        $("#newunsubscribeproduct").text(commafy(page0Overview.NEWUNSUBSCRIBEPRODUCT));
    });
};

//获取图数据
function getuserTrendData(endtime,periodFlag,displayFlag,channelid,platformid){
    endtime=endtime.replace(/-/g,"");
    var hql="user_access_30d";
    if("0" == periodFlag){
        hql="user_access_30d";
    }
    else if("1" == periodFlag){
        hql="user_access_14w";
        endtime = getWeekOfYear(endtime);
    }
    else if("2" == periodFlag){
        hql="user_access_12m";
        endtime=endtime.substr(0,6);
    }else{
        hql="user_access_30d";
    }
    Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','ENDTIME':'"+endtime+"','ACTIVITYCHANNELID':'"+channelid+"','PLATFORMID':'"+platformid+"'}",
               function(qResult){
        if(qResult==null)
        {
            return;
        }
        var obj = JSON.parse(qResult);
        var TIME = obj.DTIME;
        if("2" == periodFlag){
            TIME = obj.MTIME;
        }else if("1" == periodFlag){
            TIME = obj.WTIME;
        }
        var trendTime = new Array();
        if (TIME instanceof Array){
            trendTime = TIME;
        }
        //一条数据的 后台未以数组返回
        else{
            trendTime[0] = TIME;
        }    
        
        //具体的赋值语句
        enchannelTrendData = initArray();
        for (var k = 0;k < 8;k++){
            enchannelTrendData[k]=new Array();
            var trendDisplay = userAccessTrend[k];//userAccessTrend在channel-data_video.js里，需要改变

           for(var i=0;i<trendTime.length;i++)
            {    
                var labelValue;
                if ("0" == periodFlag){
                    labelValue=trendTime[i].substr(6,2);
                }
                else if("1" == periodFlag){
                    labelValue=trendTime[i];//.substr(4,2)
                }
                else{
                    labelValue=trendTime[i];//.substr(4,2)
                }

                
                
                enchannelTrendData[k][i] = {
                             value: [obj[trendDisplay][i]],
                             label: labelValue,
                             attr1: 'classname'};
                             
                             

            }
        }
        

        
        drawline("#channelLine",enchannelTrendData[displayFlag],periodFlag,userAccessDisplayTrend[displayFlag]); 
        //channelLine:日期 enchannelTrendData：指标集合数据  userAccessDisplayTrend：指标的中英文名称集合
    });
};

//获取表数据
function getuserTrendDataTable(endtime,periodFlag,displayFlag,channelid,tableid,platformid){    
         endtime=endtime.replace(/-/g,"");
         var hql="user_access_30d";
         if ("0" == periodFlag){
             hql="user_access_30d";
         }
         else if("1" == periodFlag){
             hql="user_access_14w";
             endtime = getWeekOfYear(endtime);
         }
         else if("2" == periodFlag){
             hql="user_access_12m";
             endtime=endtime.substr(0,6);
         }
         else{
             hql="user_access_30d";
         }
         Portal.getJsonWithCondition(hql,"{'PROJECTID':'"+projectid+"','ACTIVITYCHANNELID':'"+channelid+"','ENDTIME':'"+endtime+"','PLATFORMID':'"+platformid+"'}",
         function(qResult){
			
             if(qResult==null)
             {
                 return;
             }
             var obj = JSON.parse(qResult);
             var TIME = obj.DTIME;
             if("1" == periodFlag){
                 TIME = obj.WTIME;
             }else if("2" == periodFlag){
                 TIME = obj.MTIME;
             }
             var trendTime = new Array();
             if (TIME instanceof Array){
                 trendTime = TIME;
             }
             //一条数据的 后台未以数组返回
             else{
                 trendTime[0] = TIME;
             }   
             
            $("#trend_dtime").text("("+trendTime[0]+"~"+trendTime[trendTime.length-1]+")");
            
             //具体的赋值语句
             channelTrendData = initArray();
             for (var k = 0;k < 9;k++){
                 channelTrendData[k]=new Array();
                 if("1" == periodFlag){
                    var trendDisplay = userAccessTablew[k];//图里周的数据获取字段
                 }else if("2" == periodFlag){
                    var trendDisplay = userAccessTablem[k];//图里月的数据获取字段
                 }else{
                     var trendDisplay = userAccessTabled[k];//图里日的数据获取字段
                 
                 }
                 for(var i=0;i<trendTime.length;i++)
                 {    
                 
                     var labelValue;
                     if ("0" == periodFlag){
                         labelValue=trendTime[i].substr(6,2);
                     }
                     else if("1" == periodFlag){
                         labelValue=trendTime[i];//.substr(4,2)
                     }
                     else{
                         labelValue=trendTime[i];//.substr(4,2)
                     }
                     channelTrendData[k][i] = {
                         value: [obj[trendDisplay][i]],
                         label: labelValue,
                         attr1: trendTime[i]};
                  }
                     
             }
             //list data
             listDetailData = new Array(); 
             var collen = channelTrendData.length + 1; 
             //alert(channelTrendData.length);
             for (i = 0;i < trendTime.length;i++)
             {
                 listDetailData[i] = new Array();
                 for( j = 1 ;j < collen; j++)
                 {
                     if("2" == periodFlag){
                         listDetailData[i][j-1] = obj[userAccessTablem[j-1]][i];
                         <!-- if(j == 6){ -->
                             <!-- listDetailData[i][j-1] = obj[userAccessTablem[j-1]][i].toFixed(2)+"%"; -->
                             <!-- } -->
                     }else if("1" == periodFlag){
                         listDetailData[i][j-1] = obj[userAccessTablew[j-1]][i];
                         <!-- if(j == 6){ -->
                             <!-- listDetailData[i][j-1] = obj[userAccessTablew[j-1]][i].toFixed(2)+"%"; -->
                             <!-- } -->
                     }
                     else{
                         listDetailData[i][j-1] = obj[userAccessTabled[j-1]][i]; 
                         <!-- if(j == 6){ -->
                             <!-- listDetailData[i][j-1] = obj[userAccessTabled[j-1]][i].toFixed(2)+"%"; -->
                             <!-- } -->
                     }
                 }
             }
             var needRow = (Math.ceil(listDetailData.length/12))*12;
             if(needRow == "0")
             {
                 needRow= "1";
             }
             if (listDetailData.length > 0)
             {
                 addTableRows('user-access-table',needRow,listDetailData[0].length);        
             }
             else
             {
                 addTableRows('user-access-table',12,9);     
             }
             if("2" == periodFlag){
                 insertTableDatas('user-access-table',listDetailData,userAccessShowTablem);
             }else if("1" == periodFlag){
                 insertTableDatas('user-access-table',listDetailData,userAccessShowTablew);
             }else{
                 insertTableDatas('user-access-table',listDetailData,userAccessShowTabled);
             }
             $("#totalrn").html(trendTime.length);
             addPageDiv('pageSplitm',needRow,12);
             listSplitm('user-access-table',12);
         });
};

//初始化日期
var nextDate = new UCD.Date(null, "YYYY-MM-dd");
nextDate.init();
nextDate.setMode(1);
nextDate.setAnchor($('#nextDate'));
//golbal var
var periodFlag = "0";//日周月
var displayFlag = "0";//指具体的指标
var channelid = "ALL";
var platformid="ALL"; 
//var projectid = "ALL";
var recentPeriod = "0";//昨日，近7日，近30日
var projectid=getProjectidFromCookie();

var newnextDate = new UCD.Date(null, "YYYY-MM-dd");
newnextDate.init();
newnextDate.setMode(1);
newnextDate.setAnchor($('#newnextDate'));

var systime=newnextDate.getValue();
var weeksystime=newnextDate.getValue();

var endtime = nextDate.getValue();

var starttime;

$(function(){
    nextDate.setOnChanged(function(self){     
        endtime=nextDate.getValue();
				       
        getProjectNumData(starttime,endtime,recentPeriod,channelid,platformid);//改变头数据
        
        getuserTrendData(endtime,periodFlag,displayFlag,channelid,platformid);////改变图数据
    
        getuserTrendDataTable(endtime,periodFlag,displayFlag,channelid,'user-access-table',platformid); //改变表数据     
    });
    
    //改变图数据
    $("#trend-menu").on("click","#date-chart",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        var chart=document.getElementById("game_trend_chart");
        var table=document.getElementById("game_trend_table");
        chart.style.display='block';//展开
        table.style.display='none';//隐藏
        getuserTrendData(endtime,periodFlag,displayFlag,channelid,platformid);
        getuserTrendDataTable(endtime,periodFlag,displayFlag,channelid,'user-access-table',platformid);
     });
     
    //改变表数据 
     $("#trend-menu").on("click","#date-table",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        var chart=document.getElementById("game_trend_chart");
        var table=document.getElementById("game_trend_table");
        table.style.display='block';
        chart.style.display='none';
        getuserTrendData(endtime,periodFlag,displayFlag,channelid,platformid);
        getuserTrendDataTable(endtime,periodFlag,displayFlag,channelid,'user-access-table',platformid);
     });
    
    // 按钮切换：昨日，近7日，近30日，刷新近日数据
    $("#recent-filter").on("click",".btn-date",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        //0--yesterday;1--last 7 days; 2--last 31 days
        recentPeriod = $(this).index();
        
        switch (recentPeriod)
        {
            case 0:
                _edata.push(['setEvent','edp_channel_analysis','yesterday']);
                break;
            case 1:
                _edata.push(['setEvent','edp_channel_analysis','last_7_days']);
                break;
            case 2:
                _edata.push(['setEvent','edp_channel_analysis','last_30_days']);
                break;
            default:
                _edata.push(['setEvent','edp_channel_analysis','yesterday']);
                break;
        }
        
        endtime = nextDate.getValue();
        //刷新近日数据
        getProjectNumData(starttime,endtime,recentPeriod,channelid,platformid);
        
    });
    
    //不同粒度trend切换：日，月，周，刷新图表数据
    $("#trend-filter").on("click",".btn-date",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        //0--daily;1--weekly; 2--monthly
        periodFlag = $(this).index();
        
        switch (periodFlag)
        {
            case 0:
                _edata.push(['setEvent','edp_channel_analysis','daily']);
                break;
            case 1:
                _edata.push(['setEvent','edp_channel_analysis','weekly']);
                break;
            case 2:
                _edata.push(['setEvent','edp_channel_analysis','monthly']);
                break;
            default:
                _edata.push(['setEvent','edp_channel_analysis','daily']);
                break;
        }
        
        endtime = nextDate.getValue();
        getuserTrendData(endtime,periodFlag,displayFlag,channelid,platformid);
        getuserTrendDataTable(endtime,periodFlag,displayFlag,channelid,'user-access-table',platformid);
    });
    //不同指标trend切换，切换指标刷新显示相应数据，enchannelTrendData：指标集合， userAccessDisplayTrend中英文名称集合
    $(".nav-wrap").on("click",".nav-tab",function(){
        var $this = $(this);
        $this.parent().find(".selected").removeClass("selected");
        $(this).addClass("selected");
        displayFlag = $(this).index();
        _edata.push(['setEvent','edp_channel_analysis',userAccessTrend[displayFlag]]);
        drawline("#channelLine",enchannelTrendData[displayFlag],periodFlag,userAccessDisplayTrend[displayFlag]);
    });
 

    //初始化tab list并绑定回调函数
    initTabList(function(){
        //tab 回调函数
        
    });
    
     getProjectNumData(starttime,endtime,recentPeriod,channelid,platformid);
     
     getuserTrendData(endtime,periodFlag,displayFlag,channelid,platformid);
     
     getuserTrendDataTable(endtime,periodFlag,displayFlag,channelid,'user-access-table',platformid);

     //初始化多选droplist，渠道下拉框的选择
    setVideoChannelInfo('multi_droplist',projectid);
    $("#channel_droplist").on("click", function(event){//droplist-multi：渠道下拉框class
//        var $objWrap = $(".multi-obj-wrap");//OK按钮的总class
    	var $this = $(this);//取得该元素
        var $objWrap = $this.parent().find(".multi-obj-wrap");
        
        if($this.hasClass("multi-choosed")){//hasClass：检查ok按钮是否包含class类multi-choosed
            $this.removeClass("multi-choosed");//removeClass:移除class类multi-choosed
            $objWrap.hide();//隐藏ok按钮
        }else{
            $this.addClass("multi-choosed");//添加class类multi-choosed
            $objWrap.show();//展示OK按钮
            //自定义滚动条
//            $(".multi-obj-wrap").off().on("click", ".object", function(event){
              $objWrap.find(".object").off().on("click", function(event){
                if($(this).hasClass("selected")){
                    $(this).removeClass("selected");
                }else{
                    controlMultiListChannelVideo($(this));
                    $(this).addClass("selected");
                    $(this).siblings().removeClass("selected");
                }
                event.stopPropagation();
            });
//            $(".droplist-multi").off().on("click", ".btn-ok", function(event){//渠道下拉框的总class：droplist-multi-wrap
            $objWrap.find(".btn-ok").off().on("click", function(event){ 
            	//OK按钮的class
//                setAreaDisplay();//选中下拉框的内容
                setDroplistTiltle($this);
                $objWrap.removeClass("choosing").hide();
                $this.removeClass("multi-choosed");
                //callback function for update
                channelid = getAreaID();
                getProjectNumData(starttime,endtime,recentPeriod,channelid,platformid);
                getuserTrendData(endtime,periodFlag,displayFlag,channelid,platformid);
                getuserTrendDataTable(endtime,periodFlag,displayFlag,channelid,'user-access-table',platformid);
            });
        }
        event.stopPropagation();
    });
	//终端类型
	setFlowPlatformidInfoVideo('overview_platformid_droplist',projectid);
    $("#project_droplist").on("click", function(event){
		
        var $this = $(this);
        var $objWrap = $this.parent().find(".multi-obj-wrap");
        if($this.hasClass("multi-choosed")){
            $this.removeClass("multi-choosed");
            $objWrap.hide();
        }else{
            $this.addClass("multi-choosed");
            $objWrap.show();
            if(this.projectScrollbar){
                this.projectScrollbar.refreshScroll();
            }else{
                this.projectScrollbar = new ucd.DefaultScroll({
                    scrollObj:$objWrap.find(".scrollbar-container")
                });
                this.projectScrollbar.refreshScroll();
            }
            $objWrap.find(".object").off().on("click", function(event){
                if($(this).hasClass("selected")){
                    $(this).removeClass("selected");
                }else{                
                    removeAllSelection($(this));
                    $(this).addClass("selected");
                }
                event.stopPropagation();
            });
            $objWrap.find(".btn-ok").off().on("click", function(event){
                //_edata.push(['setEvent','edc_Overview','Switch_Project']);
                setDroplistTiltles($this);
                $objWrap.removeClass("choosing").hide();
                $this.removeClass("multi-choosed");
                platformid = getSelectPlatformid();
                //alert(platformid);
				getProjectNumData(starttime,endtime,recentPeriod,channelid,platformid);
                getuserTrendData(endtime,periodFlag,displayFlag,channelid,platformid);
                getuserTrendDataTable(endtime,periodFlag,displayFlag,channelid,'user-access-table',platformid);
				
				
            });
        }
        event.stopPropagation();
    });
    
    $("body").on("click",function(){
        if($(".droplist-multi").hasClass("multi-choosed")){
            $(".multi-obj-wrap").hide();
            $(".droplist-multi").removeClass("multi-choosed");
        }
    });    
    
    
    
});

</script>