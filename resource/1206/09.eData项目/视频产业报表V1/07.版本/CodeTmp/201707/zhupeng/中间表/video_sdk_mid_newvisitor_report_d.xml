<reportSuite>
    <reports>
        <report tableName = "t_video_sdk_current_d"
				keyFields = "projectid,activitychannelid,activityid,platformid,dtime" 
				period = "daily" timeFormat = "yyyyMMdd" timeField = "dtime">
            <fieldDefinition>
                <field name="projectid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activitychannelid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activityid" regular="[0-9a-zA-Z./-]*"/>
				<field name="platformid" regular="[0-9a-zA-Z./-]*"/>
                <field name="dtime"  regular="[0-9a-zA-Z./-]*"/>
            </fieldDefinition>
			<!--
			  新增游客数，当天结算
			  T_MID_DAY_NEWLOGIN_VISITOR获取当天新增游客数，并且在30天之内没有重复登录
			-->
			<materialViewers>
				<materialViewer tableName = "video.T_MID_DAY_NEWLOGIN_VISITOR" clear="false" partition="id,date">
					<hql>
					<![CDATA[
					  select projectid, dtime, userid, time,platformid, projectid id, dtime date
						from (select distinct tt.*
								from (select t1.c1 projectid,
											 t1.date  dtime,
											 t1.userid userid,
											 t1.time,
											 t1.platformid,
											 t2.userid userid_t2,
											 t2.dtime dtime_t2
										from (select distinct t.c1,t.date,t.userid,t.time,t.platformid
												from video.t_cdr_sdk_event_join_video_user t
											   where t.date > '{STARTTIME}'
												 and t.date < '{ENDTIME}'
												 and t.eventname = 'login'
												 and t.eventlabel = 'guest'
											) t1
										left join (select distinct r1.userid, r2.dtime
													from (select distinct userid,date
															from video.t_cdr_sdk_event_join_video_user t
														   where t.eventname = 'login'
															 and t.eventlabel = 'guest'
															 and date>from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
												                       'yyyyMMdd'),'yyyy-MM-dd'),31),'yyyy-MM-dd'),'yyyyMMdd')
														 ) r1,
														 (select dtime
															from video.t_bdi_muchtv_video_rundate t
														   where t.dtime > '{STARTTIME}'
															 and t.dtime < '{ENDTIME}') r2
												   where r1.date < r2.dtime
												      
											) t2
										  on t1.userid = t2.userid
										 and t1.date = t2.dtime
									) tt
									where tt.userid_t2 is null and tt.dtime_t2 is null
							) tb
					]]>
					</hql>
				</materialViewer>
				
				<materialViewer tableName = "video.t_mid_video_sdk_newvisitor_d" clear="false" partition="id,date">
					<hql>
					<![CDATA[
			    select projectid,platformid,activitychannelid,activityid,dtime,
					   count(distinct(userid)) newvisitor,projectid id, dtime date
				  from (select projectid,
							   'none' activitychannelid,
							   'ALL' activityid,
							   if(t.platformid is null, 'none', t.platformid) platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITOR t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						 union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   if(t.platformid is null, 'none', t.platformid) platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITOR t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						 union all
						select projectid,
							   'none' activitychannelid,
							   'none' activityid,
							   if(t.platformid is null, 'none', t.platformid) platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITOR t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						 union all
						select projectid,
							   'ALL' activitychannelid,
							   'none' activityid,
							   if(t.platformid is null, 'none', t.platformid) platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITOR t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}' 
						 union all
						   select projectid,
							   'none' activitychannelid,
							   'ALL' activityid,
							   'ALL' platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITOR t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						 union all
						select projectid,
							   'ALL' activitychannelid,
							   'ALL' activityid,
							   'ALL' platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITOR t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						 union all
						select projectid,
							   'none' activitychannelid,
							   'none' activityid,
							   'ALL' platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITOR t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
						 union all
						select projectid,
							   'ALL' activitychannelid,
							   'none' activityid,
							   'ALL' platformid,
							   t.date dtime,
							   userid
						  from video.T_MID_DAY_NEWLOGIN_VISITOR t
						 where t.date > '{STARTTIME}'
						   and t.date < '{ENDTIME}'
					) tt
				 group by projectid,activitychannelid,activityid,platformid,dtime
					]]>
					</hql>
				</materialViewer>
			</materialViewers>
        </report>
    </reports>
</reportSuite>
