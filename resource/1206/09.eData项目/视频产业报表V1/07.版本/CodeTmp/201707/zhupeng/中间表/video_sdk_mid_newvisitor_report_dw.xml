<reportSuite>
    <reports>
        <report tableName = "t_video_sdk_current_dw"
				keyFields = "projectid,activitychannelid,activityid,platformid,dtime" 
				period = "daily" timeFormat = "yyyyMMdd" timeField = "dtime">
            <fieldDefinition>
                <field name="projectid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activitychannelid" regular="[0-9a-zA-Z./-]*"/>
				<field name="activityid" regular="[0-9a-zA-Z./-]*"/>
				<field name="platformid" regular="[0-9a-zA-Z./-]*"/>
                <field name="dtime"  regular="[0-9a-zA-Z./-]*"/>
            </fieldDefinition>
			<!--
			  新增游客数，当周结算
			-->
			<materialViewers>
				<materialViewer tableName = "video.t_mid_video_sdk_newvisitor_dw" clear="false" partition="id,date">
					<hql>
					<![CDATA[
			    select projectid,platformid,activitychannelid,activityid,dtime,
					   sum(newvisitor) newvisitor,projectid id, dtime date
				  from ( select t1.projectid,
								if(t1.activitychannelid is null,'none',t1.activitychannelid) activitychannelid,
								if(t1.activityid is null,'none',t1.activityid) activityid,
								if(t1.platformid is null,'none',t1.platformid) platformid,
								t2.dtime,
								if(t1.newvisitor is null,0,t1.newvisitor) newvisitor
						   from video.t_mid_video_sdk_current_d t1,
								( select t.dtime,t.weekdays
									from video.t_bdi_muchtv_video_rundate t
								   where t.dtime > '{STARTTIME}' 
								     and t.dtime < '{ENDTIME}')t2
						  where t1.dtime > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),t2.weekdays),'yyyy-MM-dd'), 'yyyyMMdd')
						    and t1.dtime < from_unixtime(unix_timestamp(date_add(from_unixtime(unix_timestamp(t2.dtime,
											'yyyyMMdd'),'yyyy-MM-dd'),1),'yyyy-MM-dd'), 'yyyyMMdd')
				    )tt
				 group by projectid,platformid,activitychannelid,activityid,dtime
					]]>
					</hql>
				</materialViewer>
			</materialViewers>
        </report>
    </reports>
</reportSuite>
