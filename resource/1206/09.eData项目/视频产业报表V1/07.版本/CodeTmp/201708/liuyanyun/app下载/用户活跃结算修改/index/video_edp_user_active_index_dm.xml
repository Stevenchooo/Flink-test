<reportIndexGroup>
<!--
//[201703]
//近七日指标切换当周指标、近三十日指标切换当月指标[结算表名称不变 _sd _td]
//
//注意：界面选择数据展示逻辑(以当周指标为例，当月相同)
//当选择本周数据，则数据展示情况为当周近几天情况；
//当选择上周数据，则数据展示情况为上周周数据。
//201707 新增终端分组
//需要前段进行判断抽取数据，当选日期，点击[当周]。后台获取系统周数和选择日期周数进行判断，系统周=选择周 和 系统周<>选择周
-->
<multiHqlReportIndexs>
	<!--
	//当期 活跃的的用户数量 activeusers [游客和注册用户数]
	//[2017年2月23日]变动
	//活跃用户数指标，改为全部取客户端上报的事件（包含注册用户和游客），根据userID去重计数。
	//从中间表t_mid_video_sdk_current_dm获取activeusers、registeruseractive、totalvisitor
	201708需求，从t_mid_video_sdk_current_d获取appdownload
	-->
	<multiHqlReportIndex>
		<indexKey>video.edp.user.active.sdkusers.dm</indexKey>
		<fieldName>activeusers,registeruseractive,totalvisitor,appdownload</fieldName>
		<hql>
			<![CDATA[
			select projectid,activitychannelid,platformid,dtime,
				   sum(activeusers) activeusers,
				   sum(registeruseractive) registeruseractive,
				   sum(totalvisitor) totalvisitor,
				   sum(appdownload) appdownload
			 from video.t_mid_video_sdk_current_dm t
			where t.date > '{STARTTIME}'
			  and t.date < '{ENDTIME}'
			  and t.activityid ='ALL'
			 group by projectid, activitychannelid,platformid, dtime
			]]>
		</hql>
	</multiHqlReportIndex>

	<!--
	//当期 注册用户活跃数 registeruseractive: 注册用户中有登陆、浏览、播放行为的数量 
	//当前已注册用户 和 当前客户端上报的事件关联处理获取
	//
	//[20170306@SE]
	//注册用户活跃数根据[SDK话单中的 C2：用户类型（guest、subscriber、vip）]usertype <> guest 为注册用户数
	-->
	
	<!--当期 新增注册用户数 newregisteruser:  新增有注册行为的用户数量。-->
	<!--当期 新增注销用户数 newcanceluser:    新增有注销行为的用户数量。-->
	<!--操作类型 actionType	用户调用接口动作类型：1 注册、2 修改、3 删除(注销)。-->
	<multiHqlReportIndex>
		<indexKey>video.edp.user.active.userstatus.dm</indexKey>
		<fieldName>newregisteruser,newcanceluser</fieldName>
		<hql>
			<![CDATA[
			select projectid,activitychannelid,platformid,dtime,
				   count(distinct(newregister)) newregisteruser,
				   count(distinct(newcancel)) newcanceluser
			  from (select t1.projectid,
						   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
						   platformid,
						   t2.dtime,
						   if(t1.actiontype = 1, t1.identityid, null) newregister,
						   if(t1.actiontype = 3, t1.identityid, null) newcancel
					  from (select projectid, activitychannelid,'ALL' platformid, t.date dtime, actiontype,identityid
							  from video.t_cdr_top_user_info t
							 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
							   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)) t1,
						   (select dtime
							  from video.t_bdi_muchtv_video_rundate t
							 where t.dtime > '{STARTTIME}'
							   and t.dtime < '{ENDTIME}') t2
					 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
					   and t1.dtime <= t2.dtime
					union all
					select t1.projectid,
						   'ALL' activitychannelid,
						   platformid,
						   t2.dtime,
						   if(t1.actiontype = 1, t1.identityid, null) newregister,
						   if(t1.actiontype = 3, t1.identityid, null) newcancel
					  from (select projectid, activitychannelid,'ALL' platformid, t.date dtime, actiontype,identityid
							  from video.t_cdr_top_user_info t
							 where substr(t.date, 0, 6) >= substr('{STARTTIME}', 0, 6)
							   and substr(t.date, 0, 6) <= substr('{ENDTIME}', 0, 6)) t1,
						   (select dtime
							  from video.t_bdi_muchtv_video_rundate t
							 where t.dtime > '{STARTTIME}'
							   and t.dtime < '{ENDTIME}') t2
					 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
					   and t1.dtime <= t2.dtime
				) tt
			 group by projectid, activitychannelid,platformid, dtime
			]]>
		</hql>
	</multiHqlReportIndex>
	
<!--
//[20170306@SE] 
//注册用户总数 totalregisteruser ：当前在注册状态的用户总数，用户注销后不计算注册用户总数。
//上月最后一天的注册用户总数 + 当月 新增注册用户数(sum)
//2017-08-15 当天、当周、当月数据不一致，修改totalregisteruser从天表获取近日的数据
-->
	<multiHqlReportIndex>
		<indexKey>video.edp.user.active.totalregisteruser.dm</indexKey>
		<fieldName>totalregisteruser</fieldName>
		<hql>
		    
			<![CDATA[
			select projectid,activitychannelid,platformid,dtime,
						   sum(totalregisteruser) totalregisteruser
					  from (select t1.projectid,
								   if(t1.activitychannelid is null,'ALL',t1.activitychannelid) activitychannelid,
								   t1.platformid,
								   t2.dtime,
								   if(t1.totalregisteruser is null, 0, t1.totalregisteruser) totalregisteruser
							  from (select projectid,activitychannelid,platformid,dtime,totalregisteruser
									  from video.t_video_develop_user_active_d_hbase t
									 where t.dtime > '{STARTTIME}'
									   and t.dtime < '{ENDTIME}'
									   and t.platformid is null) t1,
								   (select dtime
									  from video.t_bdi_muchtv_video_rundate t
									 where t.dtime > '{STARTTIME}'
									   and t.dtime < '{ENDTIME}') t2
							 where t1.dtime = t2.dtime) s1
			 group by projectid,activitychannelid,platformid,dtime
			]]>			
		</hql>
	</multiHqlReportIndex>
	
	<!--
	//当期 观看用户数 VariousTVWatchUsers: 注意：所有种类,但是目前只有两种(VOD 和 liveTV)。
	//
	//[20170309@SE]初步设定视频周期为三天 即观看时间记录不会超过48小时
	//故设计检索原表 设置时长为 31+3=34 天
	-->
	<multiHqlReportIndex>
		<indexKey>video.edp.user.active.watchusers.dm</indexKey>
		<fieldName>watchusers</fieldName>
		<hql>
			<![CDATA[
			select projectid,activitychannelid,platformid,dtime, 
				   count(distinct(subscriberid)) watchusers
			  from (select t1.projectid,
						   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
						   platformid,
						   t2.dtime,
						   t1.subscriberid
					  from (select projectid,activitychannelid,'ALL' platformid,starttime,endtime,subscriberid,t.date dtime
							  from video.t_cdr_vod_watch_event t
							 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
											'yyyyMMdd'),'yyyy-MM-dd'),34),'yyyy-MM-dd'),'yyyyMMddHHmmss')
							   and t.date < '{ENDTIME}') t1,
						   (select t.dtime
							  from video.t_bdi_muchtv_video_rundate t
							 where t.dtime > '{STARTTIME}'
							   and t.dtime < '{ENDTIME}')t2
					 where (substr(t1.dtime,0,6) = substr(t2.dtime,0,6) AND t1.dtime <= t2.dtime)
						or (substr(t1.dtime,0,6) < substr(t2.dtime,0,6) AND substr(t1.endtime, 0, 8) >= substr(t2.dtime,0,6))
				union all
					select t1.projectid,
						   'ALL' activitychannelid,
						   platformid,
						   t2.dtime,
						   t1.subscriberid
					  from (select projectid,activitychannelid,'ALL' platformid,starttime,endtime,subscriberid,t.date dtime
							  from video.t_cdr_vod_watch_event t
							 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
											'yyyyMMdd'),'yyyy-MM-dd'),34),'yyyy-MM-dd'),'yyyyMMddHHmmss')
							   and t.date < '{ENDTIME}') t1,
						   (select t.dtime
							  from video.t_bdi_muchtv_video_rundate t
							 where t.dtime > '{STARTTIME}'
							   and t.dtime < '{ENDTIME}')t2
					 where (substr(t1.dtime,0,6) = substr(t2.dtime,0,6) AND t1.dtime <= t2.dtime)
						or (substr(t1.dtime,0,6) < substr(t2.dtime,0,6) AND substr(t1.endtime, 0, 8) >= substr(t2.dtime,0,6))
				union all
					select t1.projectid,
						   if(t1.activitychannelid is null, 'none', t1.activitychannelid) activitychannelid,
						   platformid,
						   t2.dtime,
						   t1.subscriberid
					  from (select projectid,activitychannelid,'ALL' platformid,starttime,endtime,subscriberid,t.date dtime
							  from video.t_cdr_livetv_watch_event t
							 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
											'yyyyMMdd'),'yyyy-MM-dd'),34),'yyyy-MM-dd'),'yyyyMMddHHmmss')
							   and t.date < '{ENDTIME}') t1,
						   (select t.dtime
							  from video.t_bdi_muchtv_video_rundate t
							 where t.dtime > '{STARTTIME}'
							   and t.dtime < '{ENDTIME}')t2
					 where (substr(t1.dtime,0,6) = substr(t2.dtime,0,6) AND t1.dtime <= t2.dtime)
						or (substr(t1.dtime,0,6) < substr(t2.dtime,0,6) AND substr(t1.endtime, 0, 8) >= substr(t2.dtime,0,6))
				union all
					select t1.projectid,
						   'ALL' activitychannelid,
						   platformid,
						   t2.dtime,
						   t1.subscriberid
					  from (select projectid,activitychannelid,'ALL' platformid,starttime,endtime,subscriberid,t.date dtime
							  from video.t_cdr_livetv_watch_event t
							 where t.date > from_unixtime(unix_timestamp(date_sub(from_unixtime(unix_timestamp('{STARTTIME}',
											'yyyyMMdd'),'yyyy-MM-dd'),34),'yyyy-MM-dd'),'yyyyMMddHHmmss')
							   and t.date < '{ENDTIME}') t1,
						   (select t.dtime
							  from video.t_bdi_muchtv_video_rundate t
							 where t.dtime > '{STARTTIME}'
							   and t.dtime < '{ENDTIME}')t2
					 where (substr(t1.dtime,0,6) = substr(t2.dtime,0,6) AND t1.dtime <= t2.dtime)
						or (substr(t1.dtime,0,6) < substr(t2.dtime,0,6) AND substr(t1.endtime, 0, 8) >= substr(t2.dtime,0,6))
				)tt
			 group by projectid,activitychannelid,platformid,dtime
			]]>
		</hql>
	</multiHqlReportIndex>

	<!--游客用户总数(totalvisitor) 截止当日的累计的游客总数，根据设备ID去重；同一个用户更换设备，按照新的游客用户统计。-->
	
	<!--
	//[201703新增指标@EDP@zwx386873]
	//当期 日活用户数 dayactiveusers
	//统计所在月份内，注册用户中有登陆、浏览、播放行为的数量的平均值；
	//粒度选择：
	//日为当天日活，月为当月平均日活，年为年平均日活；
	//日期选择：当周期未结束，根据实际天数计算平均，呈现最新的日活数据；
	-->
	<multiHqlReportIndex>
		<indexKey>video.edp.user.active.dayactiveusers.dm</indexKey>
		<fieldName>dayactiveusers</fieldName>
		<hql>
			<![CDATA[
			select projectid,activitychannelid,platformid,dtime,
				   (sum(dayactiveusers) / count(dayactiveusers)) dayactiveusers
			  from (select t1.projectid,
						   if(t1.activitychannelid is null, 'ALL', t1.activitychannelid) activitychannelid,
						   if(t1.platformid is null, 'ALL', t1.platformid) platformid,
						   t2.dtime,
						   if(t1.registeruseractive is null, 0, t1.registeruseractive) dayactiveusers
					  from video.t_video_develop_user_active_d_hbase t1,
						   (select t.dtime
							  from video.t_bdi_muchtv_video_rundate t
							 where t.dtime > '{STARTTIME}'
							   and t.dtime < '{ENDTIME}') t2
					 where substr(t1.dtime, 0, 6) = substr(t2.dtime, 0, 6)
					   and t1.dtime <= t2.dtime
				) tt
			 group by projectid, activitychannelid,platformid,dtime
			]]>
		</hql>
	</multiHqlReportIndex>
	
	<!--当期 注册用户活跃率 registeruseractiverate: 活跃用户/注册用户总数*100% -->
	<multiHqlReportIndex>
		<indexKey>video.edp.user.active.registeruseractiverate.dm</indexKey>
		<fieldName>registeruseractiverate</fieldName>
		<hql>
			<![CDATA[
			 select projectid,activitychannelid,platformid,dtime,
					(registeruseractive/totalregisteruser) registeruseractiverate  
			   from (select projectid,
							if(t.activitychannelid is null,'ALL',t.activitychannelid) activitychannelid,
							if(t.platformid is null, 'ALL', t.platformid) platformid,
							dtime,
							if(t.registeruseractive is null,0,t.registeruseractive) registeruseractive,
							if(t.totalregisteruser is null,0,t.totalregisteruser) totalregisteruser
					   from video.t_video_develop_user_active_td_hbase t
					  where t.dtime > '{STARTTIME}'
						and t.dtime < '{ENDTIME}'
				)tt
			group by projectid,activitychannelid,platformid,dtime,(registeruseractive/totalregisteruser)
			]]>
		</hql>
	</multiHqlReportIndex>
</multiHqlReportIndexs>
</reportIndexGroup>
