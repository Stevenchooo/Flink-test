<?xml version="1.0"?>
<!DOCTYPE configuration>
<project name="MktSystem" default="upload" basedir=".">
    <!-- 指定环境变量参数为:SystemVariable -->  
    <property environment="SystemVariable" />  
	
    <!--define variables-->
    <property name="release.name" value="MktSystem" />
    <property name="release.home" value="${basedir}/release" />
    <property name="build.home" value="${basedir}/build" />
    <property name="release.version" value="v1.20" />
    
    <tstamp>
       <format property="TODAY" pattern="yyyy-MM-dd" locale="zh_CN"/>
    </tstamp>
        
    <property name="release.war" value="${release.name}.war" />
    
    <property name="web.home" value="${basedir}/WebContent" />
    <property name="release.web.home" value="${release.home}/WebContent" />
    <!-- 将tomcat.home指向环境变量TOMCAT_HOME指向的路径 -->  
    <property name="tomcat.home" value="D:\\apache-tomcat-7.0.57\\apache-tomcat-7.0.57" />
    <property name="web.inf" value="${web.home}/WEB-INF" />
    <property name="release.web.inf" value="${release.web.home}/WEB-INF" />
    
    <property name="javac.debug" value="on" />
            
    <path id="compile-libs">
        <fileset dir="${web.inf}/lib">
            <include name="**/*.jar" />
            <include name="*.jar" />
        </fileset>
        <fileset dir="${tomcat.home}/lib">
            <include name="**/*.jar" />
            <include name="*.jar" />
        </fileset>
    </path>
    
    <target name="usage">
        <echo message="" />
        <echo message="ant release --> create release objects" />
    </target>

    <target name="init" description="make necessary dirs, and copy necessary files">
        <!-- clear dirs-->
		<delete dir="${release.home}" includeemptydirs="true" failonerror="false" />
        <mkdir dir="${release.home}" />
		
        <delete dir="${web.inf}/classes" failonerror="false"/>
        <mkdir dir="${web.inf}/classes" />
    </target>

	<target name="archive" description="archive current release.">
		<zip destfile="${release.home}/${release.name}.${release.version}.${current_time_str}.zip">
		    <fileset dir="${basedir}">
		        <include name="**/**" />
		        <exclude name="release/**" />
		        <exclude name="build/**" />
		        <exclude name="**/**/*.rar" />
   		        <exclude name="**/**/*.zip" />
		    </fileset>
		</zip>		
	</target>
    
    <target name="compile" depends="init" description="Compile source files into class files">
        <javac destdir="${web.inf}/classes" encoding="utf-8"  debug="${javac.debug}" deprecation="false" optimize="true" failonerror="true" includeantruntime="true">
            <src path="${basedir}/src" />
            <classpath refid="compile-libs" />
        </javac>
        
        <jar destfile="${release.home}/${release.name}-${release.version}.source.jar" strict="fail">
            <fileset dir="${basedir}/src">  
                <include name="**/*.java"/>  
            </fileset>  
            <manifest>
                <attribute name="Implementation-Title" value="${release.name}-${release.version}.source.jar" />
                <attribute name="Implementation-Version" value="${release.version}" />
                <attribute name="Implementation-Vendor" value="huawei"/>
                <attribute name="BuildTime" value="${current_time}" />
            </manifest>
        </jar>
    </target>

    <!-- 复制归档文件至归档目录 -->
    <target name="mergeDBFiles">
        <concat destfile="${release.home}/procedures.sql" encoding="utf-8">
		    <header filtering="no" trimleading="yes">
		        delimiter $$$$
		    </header>
            <fileset dir="${basedir}/database/">
                <include name="**/*.sql"/>
                <exclude name="**/tables.sql"/>
            	<exclude name="**/dataImport/*"/>
            </fileset>
            <footer filtering="no" trimleading="yes">
				$$$$
				delimiter ;
            </footer>
        </concat>
        
        <concat destfile="${release.home}/tables.sql" encoding="utf-8">
            <fileset dir="${basedir}/database/">
                <include name="**/tables.sql"/>
            </fileset>
        </concat>
    	<concat destfile="${release.home}/tableDatas.sql" encoding="utf-8">
    	    <fileset dir="${basedir}/database/">
    	        <include name="**/dataImport/*.sql"/>
    	    </fileset>
    	</concat>
    </target>
        
    <target name="release" depends="compile, mergeDBFiles, archive" description="make tomcat version">
		<copy todir="${release.web.home}" overwrite="true">
			<fileset dir="${web.home}">
		        <include name="**/**"/>
				<exclude name="**/*source*.jar" />
		    </fileset>
		</copy>
		        
		<copy todir="${release.web.inf}/conf" overwrite="true">
			<fileset dir="${basedir}/config">
		        <include name="**/**"/>
		    </fileset>
		</copy>        
		
        <!--war project-->
        <war warfile="${release.home}/${release.war}" basedir="${release.web.home}">
            <include name="*/**" />
            <exclude name="**/*.source.jar" />
        </war>
    	
    	<checksum file="${release.home}/${release.war}" />
        <delete dir="${release.web.home}" failonerror="false"/>
    </target>
	
	<target name="upload" depends="release">
		<echo message="upload....." />		
		<exec executable="cmd">
			<arg value="/C d:\build\Marketing\code\current\Marketing\CI\tool\upload.bat" />
	    </exec>
	</target>

    <tstamp>
        <format property="current_time" pattern="yyyy-MM-dd HH:mm:ss" offset="8" unit="hour" />
    </tstamp>

    <tstamp>
        <format property="current_time_str" pattern="yyyyMMddHHmmss" offset="8" unit="hour" />
    </tstamp>
</project>