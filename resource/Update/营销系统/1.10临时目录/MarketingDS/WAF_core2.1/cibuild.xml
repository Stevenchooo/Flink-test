<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ant>

<project name="WEBSERVER" default="jar" basedir=".">
	<!--define variables-->
	<tstamp>
		<format property="current_time" pattern="yyyy-MM-dd HH:mm:ss" offset="8" unit="hour" />
	</tstamp>

	<tstamp>
		<format property="current_time_str" pattern="yyyyMMddHH" offset="8" unit="hour" />
	</tstamp>
	
	<property environment="env"/>
    <property name="release.project" value="WAF_core" />
    <property name="release.database" value="WAF" />
    <property name="release.home" value="${basedir}/release" />
    <property name="build.home" value="${basedir}/build" />
    <property name="release.version" value="2.2" />
    
    <property name="release.name" value="${release.home}/${release.project}-${release.version}" />
    <property name="release.jar" value="${release.name}.jar" />
    <property name="release.source.jar" value="${release.name}.source.jar" />
    <property name="debug.jar" value="${release.name}.debug.jar" />
    <property name="hs4j.jar" value="${release.home}/hs4j-1.2.jar" />
    <property name="hs4j_source.jar" value="${release.home}/hs4j-1.2.source.jar" />
    
    <property name="release.war" value="${release.home}/${release.project}.war" />
    
    <property name="release.web.home" value="${release.home}/WebContent" />
    <property name="web.home" value="${basedir}/WebContent" />
    <property name="tomcat.home" value="D:\apache-tomcat-7.0.67" />
    <property name="web.inf" value="${web.home}/WEB-INF" />
    <property name="release.web.inf" value="${release.web.home}/WEB-INF" />
    
    <property name="proguard" value="f:/Tools/Develop/proguard4.11" />
    <property name="proguard.map" value="${release.home}/proguard.${current_time_str}.map" />
    
    <property name="javac.debug" value="on" />
    		
	<path id="compile-libs">
		<fileset dir="${basedir}/lib">
			<include name="**/*.jar" />
            <include name="*.jar" />
		</fileset>
        <fileset dir="${tomcat.home}/lib">
            <include name="**/*.jar" />
            <include name="*.jar" />
        </fileset>
	</path>
	
	<target name="usage">
		<echo message="" />
		<echo message="${release.project} build script" />
		<echo message="-----------------------------------------" />
		<echo message="" />
		<echo message="ant release  --> make war for tomcat runtime" />
	</target>

	<target name="init" description="make necessary dirs">
		<!--mk some dirs-->
		<delete includeEmptyDirs="true" failonerror="false">
		    <fileset dir="${release.home}" includes="**/*"/>
		</delete>
		<mkdir dir="${release.home}" />

        <delete dir="${basedir}/bin" />
        <mkdir dir="${basedir}/bin" />
    </target>

	<target name="compile" depends="init" description="Compile source files into class files">
		<javac destdir="${basedir}/bin" encoding="utf-8" source="1.6" target="1.6" debug="${javac.debug}" deprecation="false" optimize="true" failonerror="true" includeantruntime="true">
			<src path="${basedir}/src" />
			<classpath refid="compile-libs" />
		</javac>
	</target>

	<target name="archive" description="archive current release.">
		<zip destfile="${release.home}/${release.project}.${release.version}.${current_time_str}.zip">
		    <fileset dir="${basedir}">
		        <include name="**/**" />
		        <exclude name="release/**" />
		        <exclude name="build/**" />
		        <exclude name="**/**/*.rar" />
   		        <exclude name="**/**/*.zip" />
		    </fileset>
		</zip>		
		<zip destfile="${release.home}/${release.project}.${release.version}.bin.zip">
		    <fileset dir="${basedir}/bin">
		        <include name="**/*.bat" />
		        <include name="**/*.sh" />
		    </fileset>
		</zip>		
	</target>

	<target name="mergeMysql" description="merge all mysql sql files">
		<concat destfile="${release.home}/mysql_procedures.sql" encoding="utf-8" fixlastline="true" overwrite="true">
      	    <fileset dir="${basedir}/database/mysql">
		        <include name="**/*.sql" />
		        <exclude name="**/tables.sql" />
		    </fileset>
      	</concat>
      	
		<concat destfile="${release.home}/mysql_tables.sql" encoding="utf-8" eol="unix">
	 		<header trimleading="yes" filtering="no">
				drop databse if exists ${release.database};
				create database ${release.database} DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
				use ${release.database};
	      	</header>
		    <fileset dir="${basedir}/database/mysql">
		        <include name="**/tables.sql" />
		    </fileset>
		</concat>
	</target>

	<target name="release" depends="jar,mergeMysql" description="make tomcat war">
	    <copy todir="${release.web.home}" overwrite="true">
	        <fileset dir="${web.home}">
				<include name="**/**" />
				<exclude name="**/*source*.jar" />
			</fileset>
	    </copy>
	 
	    <copy todir="${release.web.inf}/conf" overwrite="true">
	        <fileset dir="${basedir}/config">
				<include name="**/**" />
			</fileset>
	    </copy>
	            	    	    
		<!--war project-->
		<war warfile="${release.war}" basedir="${release.web.home}">
			<include name="**/**" />
		</war>
		
		<checksum file="${release.war}" /> 
		<delete dir="${release.web.home}" />
	</target>
	
	<target name="jar" depends="compile,archive" description="make jar files">
        <!--make jar -->
        <jar destfile="${release.jar}" strict="fail">
			<fileset dir="${basedir}/bin">  
                <include name="**/**/*.class"/> 
                <!--<exclude name="**/yourprj/**/*.class"/>--> 
                <!--<exclude name="**/HSBenchMark*.class"/>--> 
            </fileset>
            <manifest>
                <attribute name="Implementation-Title" value="${release.project}.${release.version}.jar" />
                <attribute name="Implementation-Version" value="v${release.version}" />
                <attribute name="Implementation-Vendor" value="huawei"/>
                <attribute name="BuildTime" value="${current_time}" />
            </manifest>
        </jar>
        
        <jar destfile="${release.source.jar}" strict="fail">
			<fileset dir="${basedir}/">  
                <include name="**/*.java"/>  
            </fileset>
            <manifest>
				<attribute name="Implementation-Title" value="${release.project}.jar" />
                <attribute name="Implementation-Version" value="v${release.version}" />
                <attribute name="Implementation-Vendor" value="huawei"/>
                <attribute name="BuildTime" value="${current_time}" />
            </manifest>
        </jar>        
       
    </target>
    
    <target name="encrypt" depends="jar" description="use proguard to encode classes">
        <echo>Proguard ${release.name}...</echo>
        <java jar="${proguard}/lib/proguard.jar" fork="true" failonerror="true">
            <jvmarg value="-Dmaximum.inlined.code.length=16" />
            <arg value="@${basedir}/proguard.cfg" />
            <arg value="-injars ${debug.jar}" />
            <arg value="-outjars ${release.jar}" />
            <arg value="-libraryjars ${web.inf}/lib;${tomcat.home}/lib" />
            <arg value="-printmapping ${proguard.map}" />
        </java>
    </target>
</project>